{
  "info": {
    "name": "Build State API Tests",
    "description": "Comprehensive test collection for Build State API including user management, authentication, and build operations",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "adminToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "userToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "testUserId",
      "value": "",
      "type": "string"
    },
    {
      "key": "testBuildId",
      "value": "",
      "type": "string"
    },
    {
      "key": "apiToken",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Health Checks",
      "item": [
        {
          "name": "API Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": ["{{baseUrl}}"],
              "path": ["health"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains status\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql(\"healthy\");",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "API Readiness Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/ready",
              "host": ["{{baseUrl}}"],
              "path": ["ready"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Readiness check passes\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.overall).to.be.true;",
                  "    pm.expect(jsonData.database).to.be.true;",
                  "    pm.expect(jsonData.redis).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "API Status Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/status",
              "host": ["{{baseUrl}}"],
              "path": ["status"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Status check shows healthy components\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.overall_status).to.eql(\"healthy\");",
                  "    pm.expect(jsonData.components).to.be.an('array');",
                  "    pm.expect(jsonData.components.length).to.be.greaterThan(0);",
                  "    ",
                  "    // Check that all components are healthy",
                  "    jsonData.components.forEach(function(component) {",
                  "        pm.expect(component.status).to.eql(\"healthy\");",
                  "    });",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Admin Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/password",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "password"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains access token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.access_token).to.be.a('string');",
                  "    pm.collectionVariables.set(\"adminToken\", jsonData.access_token);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "IDM Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"idm_token\": \"idm-token-12345\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/idm",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "idm"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains access token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.access_token).to.be.a('string');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "User Management",
      "item": [
        {
          "name": "Create User",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"testuser\",\n  \"email\": \"test@example.com\",\n  \"first_name\": \"Test\",\n  \"last_name\": \"User\",\n  \"employee_id\": \"EMP001\",\n  \"password\": \"testpass123\",\n  \"is_superuser\": false\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/users",
              "host": ["{{baseUrl}}"],
              "path": ["users"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains user ID\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.id).to.be.a('string');",
                  "    pm.collectionVariables.set(\"testUserId\", jsonData.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get User Details",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/{{testUserId}}",
              "host": ["{{baseUrl}}"],
              "path": ["users", "{{testUserId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains user data\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.username).to.eql(\"testuser\");",
                  "    pm.expect(jsonData.email).to.eql(\"test@example.com\");",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update User",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"first_name\": \"Updated\",\n  \"last_name\": \"TestUser\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/users/{{testUserId}}",
              "host": ["{{baseUrl}}"],
              "path": ["users", "{{testUserId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get User Profile",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/{{testUserId}}/profile",
              "host": ["{{baseUrl}}"],
              "path": ["users", "{{testUserId}}", "profile"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Profile contains correct data\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.first_name).to.eql(\"Updated\");",
                  "    pm.expect(jsonData.last_name).to.eql(\"TestUser\");",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "API Token Management",
      "item": [
        {
          "name": "Create API Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Test Token\",\n  \"scopes\": [\"read\", \"write\"],\n  \"expires_at\": null\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/users/{{testUserId}}/tokens",
              "host": ["{{baseUrl}}"],
              "path": ["users", "{{testUserId}}", "tokens"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.token).to.be.a('string');",
                  "    pm.collectionVariables.set(\"apiToken\", jsonData.token);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "List API Tokens",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/{{testUserId}}/tokens",
              "host": ["{{baseUrl}}"],
              "path": ["users", "{{testUserId}}", "tokens"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains tokens array\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.tokens).to.be.an('array');",
                  "    pm.expect(jsonData.tokens.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Build Management",
      "item": [
        {
          "name": "Create Build",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"platform\": \"aws-commercial\",\n  \"os_version\": \"rhel-8.8\",\n  \"image_type\": \"base\",\n  \"build_id\": \"test-build-\" + Date.now(),\n  \"pipeline_url\": \"https://github.com/example/repo/actions/runs/123\",\n  \"commit_hash\": \"abc123def456\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/builds",
              "host": ["{{baseUrl}}"],
              "path": ["builds"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response contains build ID\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.id).to.be.a('string');",
                  "    pm.collectionVariables.set(\"testBuildId\", jsonData.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Build Details",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/builds/{{testBuildId}}",
              "host": ["{{baseUrl}}"],
              "path": ["builds", "{{testBuildId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Build data is correct\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.platform).to.eql(\"aws-commercial\");",
                  "    pm.expect(jsonData.os_version).to.eql(\"rhel-8.8\");",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Build State",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"state_code\": 25,\n  \"message\": \"Build started successfully\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/builds/{{testBuildId}}/state",
              "host": ["{{baseUrl}}"],
              "path": ["builds", "{{testBuildId}}", "state"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Record Build Failure",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"error_message\": \"Test failure\",\n  \"error_code\": \"TEST_ERROR\",\n  \"component\": \"test\",\n  \"details\": {\"step\": \"validation\", \"reason\": \"test failure\"}\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/builds/{{testBuildId}}/failure",
              "host": ["{{baseUrl}}"],
              "path": ["builds", "{{testBuildId}}", "failure"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Dashboard",
      "item": [
        {
          "name": "Get Dashboard Summary",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/dashboard/summary",
              "host": ["{{baseUrl}}"],
              "path": ["dashboard", "summary"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Dashboard contains expected fields\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.total_builds).to.be.a('number');",
                  "    pm.expect(jsonData.status_counts).to.be.an('object');",
                  "    pm.expect(jsonData.recent_builds).to.be.an('array');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}