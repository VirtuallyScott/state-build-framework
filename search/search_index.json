{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"State-Based Build Framework","text":"<p>A complete framework for implementing resumable, state-based CI/CD pipelines for multi-cloud IaaS image creation. Includes both API service and CLI tools for managing build states across AWS, Azure, GCP, and private clouds.</p>"},{"location":"#what-this-is","title":"\ud83c\udfaf What This Is","text":"<p>The State-Based Build Framework solves the critical problem of non-resumable build pipelines that lose all progress when interrupted. By implementing numerical state codes (0-100) and resumable workflows, this framework enables reliable, fault-tolerant image building across multiple cloud providers.</p> <p>Why State-Based? Traditional monolithic pipelines fail completely on interruption. State-based pipelines can resume from any failure point, saving hours of rebuild time and ensuring consistent, reliable deployments.</p>"},{"location":"#components","title":"\ud83d\udce6 Components","text":""},{"location":"#1-api-service-api_service","title":"1. API Service (<code>api_service/</code>)","text":"<p>FastAPI-based REST API for managing build states with authentication and authorization.</p> <p>Features: - \u2705 JWT and API key authentication - \u2705 Scope-based authorization (read, write, admin) - \u2705 RESTful API for all resources - \u2705 Horizontal scaling with Nginx load balancer - \u2705 PostgreSQL/SQLite support - \u2705 Redis caching - \u2705 Comprehensive error handling - \u2705 Soft deletes for audit compliance - \u2705 Interactive API docs (Swagger/ReDoc)</p> <p>Quick Start: <pre><code>cd api_service/docker\ndocker compose up -d\n\n# API available at http://localhost:8080\n# Docs at http://localhost:8080/docs\n</code></pre></p> <p>Documentation: - API Reference - Complete endpoint documentation - Authentication Guide - Auth &amp; authorization - Architecture - System design - Deployment Guide - Production setup</p>"},{"location":"#2-cli-tool-bldst_cli","title":"2. CLI Tool (<code>bldst_cli/</code>)","text":"<p>Modern command-line interface for managing build infrastructure.</p> <p>Features: - \u2705 Type-safe Pydantic models - \u2705 Rich terminal output - \u2705 Secure credential storage (system keyring) - \u2705 JSON and table output formats - \u2705 Shell completion support - \u2705 Perfect for CI/CD integration</p> <p>Quick Start: <pre><code>cd bldst_cli\npip install -e .\n\n# Configure\nbldst config set-url http://localhost:8080\nbldst auth set-key dev-key-12345\n\n# Use\nbldst platform list\nbldst os-version list\nbldst build list\n</code></pre></p> <p>Documentation: - CLI Documentation - Complete reference - Quick Start Guide - 5-minute guide - Usage Examples - Common workflows</p>"},{"location":"#3-framework-documentation-docs","title":"3. Framework Documentation (<code>docs/</code>)","text":"<p>Complete framework design, problem statement, and implementation guides.</p> <p>Documentation: - Problem Statement - Why this framework exists and how it helps - Artifact Storage - Distributed artifact tracking - Database Architecture - Database schema and design - CI/CD Pipeline - Automated builds and versioning - Resumable Builds Design - Advanced resumability</p>"},{"location":"#quick-start","title":"\ud83d\ude80 Quick Start","text":""},{"location":"#1-start-the-api","title":"1. Start the API","text":"<pre><code># Start all services (API, database, Redis, Nginx)\ncd api_service/docker\ndocker compose up -d\n\n# Verify services\ndocker compose ps\ncurl http://localhost:8080/health\n</code></pre>"},{"location":"#2-install-the-cli","title":"2. Install the CLI","text":"<pre><code># Install CLI\ncd bldst_cli\npip install -e .\n\n# Configure\nbldst config set-url http://localhost:8080\nbldst auth set-key dev-key-12345\n\n# Test\nbldst platform list\n</code></pre>"},{"location":"#3-create-your-first-build","title":"3. Create Your First Build","text":"<pre><code># List available resources\nbldst platform list\nbldst os-version list  \nbldst image-type list\n\n# Create a project\nbldst project create \\\n  --name \"rhel-9-base\" \\\n  --description \"RHEL 9 base images\"\n\n# View dashboard\ncurl -H \"X-API-Key: dev-key-12345\" http://localhost:8080/dashboard/summary\n</code></pre>"},{"location":"#complete-documentation","title":"\ud83d\udcda Complete Documentation","text":""},{"location":"#api-documentation","title":"API Documentation","text":"<ul> <li>API Reference - All endpoints, request/response schemas, examples</li> <li>Authentication Guide - JWT tokens, API keys, scopes, best practices</li> <li>Architecture Overview - System design, scaling, database</li> <li>Deployment Guide - Production deployment, Docker, configuration</li> </ul>"},{"location":"#cli-documentation","title":"CLI Documentation","text":"<ul> <li>CLI Documentation - Complete command reference</li> <li>Quick Start Guide - Get started fast</li> <li>API Integration - CI/CD examples</li> </ul>"},{"location":"#framework-documentation","title":"Framework Documentation","text":"<ul> <li>Problem Statement - Why this framework exists and how it solves the problems</li> <li>Artifact Storage - Distributed build artifact tracking</li> <li>Database Architecture - Data model and schema design</li> </ul>"},{"location":"#cicd-devops","title":"CI/CD &amp; DevOps","text":"<ul> <li>CI/CD Pipeline - Automated builds, semantic versioning, container registry</li> <li>Resumable Builds Design - Advanced resumability architecture</li> <li>Resumable Builds Quick Start - Usage guide</li> </ul>"},{"location":"#key-concepts","title":"\ud83c\udf93 Key Concepts","text":""},{"location":"#state-codes-0-100","title":"State Codes (0-100)","text":"<p>Build progress is tracked with numerical codes in increments of 5: - 0 - Pending/Not started - 5-15 - Preparation and validation - 20-45 - Image building (Packer) - 50-75 - Configuration (Ansible) - 80-95 - Testing and validation - 100 - Completed</p>"},{"location":"#authorization-scopes","title":"Authorization Scopes","text":"<p>Three permission levels control API access: - read - View resources (monitoring, dashboards) - write - Create and update (build pipelines) - admin - Delete resources (maintenance)</p>"},{"location":"#soft-deletes","title":"Soft Deletes","text":"<p>Resources are never permanently deleted. They're marked with <code>deactivated_at</code> timestamp for audit compliance.</p>"},{"location":"#multi-cloud-support","title":"Multi-Cloud Support","text":"<p>Single API manages builds across: - AWS (commercial, GovCloud, China) - Azure (commercial, government) - Google Cloud Platform - Oracle Cloud - Private clouds (OpenStack, etc.)</p>"},{"location":"#architecture","title":"\ud83c\udfd7\ufe0f Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Nginx Load Balancer                 \u2502\n\u2502                    (localhost:8080)                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502               \u2502               \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502   API 01     \u2502 \u2502   API 02   \u2502 \u2502   API 03   \u2502\n         \u2502 (FastAPI)    \u2502 \u2502 (FastAPI)  \u2502 \u2502 (FastAPI)  \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502               \u2502               \u2502\n                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                \u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502                        \u2502\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502   PostgreSQL   \u2502      \u2502    Redis     \u2502\n            \u2502   (Database)   \u2502      \u2502   (Cache)    \u2502\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"#usage-examples","title":"\ud83d\udca1 Usage Examples","text":""},{"location":"#api-direct-usage","title":"API Direct Usage","text":"<pre><code># Authenticate with API key\nexport API_KEY=\"dev-key-12345\"\nexport API_URL=\"http://localhost:8080\"\n\n# List platforms\ncurl -H \"X-API-Key: $API_KEY\" $API_URL/platforms/\n\n# Create a build\ncurl -X POST $API_URL/builds \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"project_id\": \"rhel-9\",\n    \"platform_id\": \"aws-commercial\",\n    \"os_version_id\": \"rhel-9.3\",\n    \"image_type_id\": \"base\",\n    \"build_number\": \"2024.02.001\"\n  }'\n\n# Update build state\ncurl -X POST $API_URL/builds/{build-id}/state \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"state_code\": 25,\n    \"status\": \"in_progress\",\n    \"message\": \"Installing packages\"\n  }'\n</code></pre>"},{"location":"#cli-usage","title":"CLI Usage","text":"<pre><code># Configure once\nbldst config set-url http://localhost:8080\nbldst auth set-key dev-key-12345\n\n# Create resources\nbldst platform create --name \"Production AWS\" --cloud-provider aws --region us-east-1\nbldst os-version create --name \"Ubuntu\" --version \"22.04\"\nbldst image-type create --name \"web-server\" --description \"Nginx web server\"\n\n# Query resources\nbldst platform list --output json | jq '.[] | select(.cloud_provider == \"aws\")'\n\n# Manage builds\nbldst build list --status in_progress\nbldst build get {build-id}\n</code></pre>"},{"location":"#cicd-integration-concourse","title":"CI/CD Integration (Concourse)","text":"<pre><code>resources:\n  - name: buildstate-api\n    type: http-api\n    source:\n      uri: ((buildstate-api-url))\n      headers:\n        X-API-Key: ((buildstate-api-key))\n\njobs:\n  - name: build-image\n    plan:\n      - task: create-build\n        config:\n          run:\n            path: bash\n            args:\n              - -c\n              - |\n                # Install CLI\n                pip install -e bldst_cli\n\n                # Configure\n                bldst config set-url $API_URL\n                bldst auth set-key $API_KEY\n\n                # Create build\n                BUILD_ID=$(bldst build create \\\n                  --project-id rhel-9 \\\n                  --platform-id aws-commercial \\\n                  --os-version-id rhel-9.3 \\\n                  --image-type-id base \\\n                  --build-number $BUILD_NUMBER \\\n                  --output json | jq -r '.id')\n\n                echo $BUILD_ID &gt; build-id.txt\n        params:\n          API_URL: ((buildstate-api-url))\n          API_KEY: ((buildstate-api-key))\n</code></pre>"},{"location":"#security","title":"\ud83d\udd12 Security","text":""},{"location":"#test-credentials-development-only","title":"Test Credentials (Development Only)","text":"<p>API Keys: - <code>readonly-key-888</code> - Read-only access - <code>dev-key-12345</code> - Read + write access - <code>admin-key-99999</code> - Full admin access</p> <p>Users: - Username: <code>admin</code>, Password: <code>admin123</code> (admin scope) - Username: <code>user</code>, Password: <code>user123</code> (write scope) - Username: <code>readonly</code>, Password: <code>readonly123</code> (read scope)</p> <p>\u26a0\ufe0f Change these in production!</p>"},{"location":"#production-security","title":"Production Security","text":"<ul> <li>Use HTTPS/TLS for all API communication</li> <li>Store API keys in secret managers (Vault, AWS Secrets Manager, etc.)</li> <li>Rotate keys regularly</li> <li>Use least-privilege principle</li> <li>Enable audit logging</li> <li>Monitor authentication failures</li> </ul>"},{"location":"#testing","title":"\ud83e\uddea Testing","text":""},{"location":"#api-tests","title":"API Tests","text":"<pre><code>cd api_service\npytest tests/\n\n# Or with coverage\npytest --cov=app tests/\n</code></pre>"},{"location":"#cli-tests","title":"CLI Tests","text":"<pre><code>cd bldst_cli\npytest tests/\n</code></pre>"},{"location":"#integration-tests","title":"Integration Tests","text":"<pre><code># Start services\ncd api_service/docker\ndocker compose up -d\n\n# Run tests\ncd ../tests\n../../scripts/test-api.sh\n</code></pre>"},{"location":"#state-code-reference","title":"\ud83d\udcca State Code Reference","text":"<p>Quick reference for common state codes:</p> Code Category Description 0 Init Build pending 5 Prep Environment preparation 10 Prep Dependencies validated 15 Prep Configuration validated 20 Build Packer build started 25 Build Base image created 30 Build Packages installing 40 Build Packer build complete 50 Config Ansible started 60 Config System configuration 70 Config Application configuration 75 Config Ansible complete 80 Test Testing started 90 Test Tests passed 95 Finalize Creating artifacts 100 Complete Build successful <p>See Problem Statement for complete framework documentation.</p>"},{"location":"#deployment","title":"\ud83d\ude80 Deployment","text":""},{"location":"#development","title":"Development","text":"<pre><code># Start all services\ncd api_service/docker\ndocker compose up -d\n</code></pre>"},{"location":"#production","title":"Production","text":"<p>See Deployment Guide for: - Production Docker configuration - Database setup (PostgreSQL) - SSL/TLS configuration - Scaling guidelines - Monitoring setup - Backup strategies</p>"},{"location":"#contributing","title":"\ud83e\udd1d Contributing","text":"<p>We welcome contributions! Please see our Contributing Guide for:</p> <ul> <li>Development workflow and Git Flow branching strategy</li> <li>Code standards and style guidelines</li> <li>Naming conventions (hyphens for files, underscores for directories)</li> <li>Database migration requirements</li> <li>Testing requirements</li> <li>Pull request process</li> </ul> <p>Quick Start:</p> <ol> <li>Fork the repository</li> <li>Create a feature branch (<code>git checkout -b feature/amazing-feature</code>)</li> <li>Make your changes with tests</li> <li>Run tests and linting</li> <li>Commit changes (<code>git commit -m 'feat: Add amazing feature'</code>)</li> <li>Push to branch (<code>git push origin feature/amazing-feature</code>)</li> <li>Open a Pull Request</li> </ol> <p>See CONTRIBUTING.md for detailed guidelines.</p>"},{"location":"#license","title":"\ud83d\udcdd License","text":"<p>MIT License - see LICENSE file for details.</p>"},{"location":"#support","title":"\ud83c\udd98 Support","text":"<ul> <li>Documentation: See links above for complete documentation</li> <li>API Issues: Check API Reference and Authentication Guide</li> <li>CLI Issues: Check CLI Documentation</li> <li>Framework Questions: See Problem Statement</li> </ul>"},{"location":"#roadmap","title":"\ud83d\uddfa\ufe0f Roadmap","text":"<ul> <li> GraphQL API support</li> <li> Real-time state updates (WebSocket)</li> <li> Advanced metrics and monitoring</li> <li> Build artifact storage integration</li> <li> Multi-region API deployment</li> <li> Enhanced CLI with progress bars</li> <li> Web UI dashboard</li> </ul> <p>Built for reliable, resumable multi-cloud image builds \ud83d\ude80</p>"},{"location":"#2-install-the-cli_1","title":"2. Install the CLI","text":"<pre><code># Install CLI\ncd bldst_cli\npip install -e .\n\n# Configure\nbldst config set-url http://localhost:8080\nbldst auth set-key dev-key-12345\n\n# Test\nbldst platform list\n</code></pre>"},{"location":"#3-create-your-first-build_1","title":"3. Create Your First Build","text":"<pre><code># List available resources\nbldst platform list\nbldst os-version list  \nbldst image-type list\n\n# Create a project\nbldst project create \\\n  --name \"rhel-9-base\" \\\n  --description \"RHEL 9 base images\"\n\n# View dashboard\ncurl -H \"X-API-Key: dev-key-12345\" http://localhost:8080/dashboard/summary\n</code></pre>"},{"location":"#complete-documentation_1","title":"\ud83d\udcda Complete Documentation","text":""},{"location":"#api-documentation_1","title":"API Documentation","text":"<ul> <li>API Reference - All endpoints, request/response schemas, examples</li> <li>Authentication Guide - JWT tokens, API keys, scopes, best practices</li> <li>Architecture Overview - System design, scaling, database</li> <li>Deployment Guide - Production deployment, Docker, configuration</li> </ul>"},{"location":"#cli-documentation_1","title":"CLI Documentation","text":"<ul> <li>CLI Documentation - Complete command reference</li> <li>Quick Start Guide - Get started fast</li> <li>API Integration - CI/CD examples</li> </ul>"},{"location":"#framework-documentation_1","title":"Framework Documentation","text":"<ul> <li>Problem Statement - Why this framework exists and how it solves the problems</li> <li>Artifact Storage - Distributed build artifact tracking</li> <li>Database Architecture - Data model and schema design</li> </ul>"},{"location":"#key-concepts_1","title":"\ud83c\udf93 Key Concepts","text":""},{"location":"artifact-storage/","title":"Artifact Storage Tracking","text":""},{"location":"artifact-storage/#overview","title":"Overview","text":"<p>The Build State API provides comprehensive artifact storage tracking to enable resumable builds and distributed build systems. Artifacts are tracked in two complementary ways:</p> <ol> <li>Build States Table - Quick artifact reference for each build state transition</li> <li>Build Artifacts Table - Comprehensive artifact registry with full metadata and lifecycle management</li> </ol> <p>This dual approach allows for: - Quick lookups during state transitions (via <code>build_states</code>) - Full artifact lifecycle management for resumable builds (via <code>build_artifacts</code>) - Distributed build systems where multiple servers share artifacts via cloud storage - Integrity verification using SHA256 checksums</p>"},{"location":"artifact-storage/#use-cases","title":"Use Cases","text":""},{"location":"artifact-storage/#1-distributed-build-systems","title":"1. Distributed Build Systems","text":"<p>In a distributed build environment:</p> <ol> <li>Build Server A completes state 10 and produces an artifact (e.g., a base VM image)</li> <li>Build Server A uploads the artifact to shared storage (e.g., S3)</li> <li>Build Server A records the artifact location in the database</li> <li>Build Server B picks up state 20 for the same build</li> <li>Build Server B queries the artifact registry to find the artifact from state 10</li> <li>Build Server B downloads the artifact from the shared storage location</li> <li>Build Server B verifies integrity using SHA256 checksum</li> <li>Build Server B uses the artifact as the base for state 20 work</li> </ol>"},{"location":"artifact-storage/#2-resumable-builds","title":"2. Resumable Builds","text":"<p>When a build fails:</p> <ol> <li>Query <code>build_artifacts</code> for resumable artifacts (<code>is_resumable = TRUE</code>)</li> <li>Find the last successful state with a resumable artifact</li> <li>Restore VM/environment from the stored artifact</li> <li>Resume build from the next state</li> <li>Save hours of rebuild time</li> </ol>"},{"location":"artifact-storage/#database-schema","title":"Database Schema","text":""},{"location":"artifact-storage/#build-states-table-quick-reference","title":"Build States Table (Quick Reference)","text":"<p>The <code>build_states</code> table includes artifact tracking fields for quick lookups:</p> Column Type Description <code>artifact_storage_type</code> VARCHAR(50) Type of storage backend (s3, nfs, ebs, ceph, local, etc.) <code>artifact_storage_path</code> TEXT Full path/URI to the stored artifact <code>artifact_size_bytes</code> BIGINT Size of the artifact in bytes <code>artifact_checksum</code> VARCHAR(128) SHA256 or MD5 checksum for verification <code>artifact_metadata</code> JSONB Additional metadata about the artifact"},{"location":"artifact-storage/#build-artifacts-table-full-registry","title":"Build Artifacts Table (Full Registry)","text":"<p>The <code>build_artifacts</code> table provides comprehensive artifact management:</p> Column Type Description <code>id</code> TEXT (UUID) Unique artifact identifier <code>build_id</code> TEXT (UUID) Build this artifact belongs to <code>state_code</code> INTEGER State at which this artifact was created <code>artifact_name</code> TEXT Unique name within the build <code>artifact_type</code> TEXT Type: vm_snapshot, ami, disk_image, config_file, etc. <code>artifact_path</code> TEXT Full path/URL to the artifact <code>storage_backend</code> TEXT Backend: s3, azure_blob, gcp_storage, local, vsphere, nfs, etc. <code>storage_region</code> TEXT Storage region (if applicable) <code>storage_bucket</code> TEXT Bucket or container name <code>storage_key</code> TEXT Key/path within bucket <code>size_bytes</code> BIGINT Size of artifact in bytes <code>checksum</code> TEXT SHA256 checksum for integrity verification <code>checksum_algorithm</code> TEXT Algorithm used (default: sha256) <code>is_resumable</code> BOOLEAN Can this artifact be used to resume builds? <code>is_final</code> BOOLEAN Is this the final deliverable? <code>expires_at</code> TIMESTAMP When to clean up temporary artifacts <code>metadata</code> JSONB Additional metadata (VM IDs, snapshot IDs, etc.) <code>created_at</code> TIMESTAMP When the artifact was registered <code>updated_at</code> TIMESTAMP Last update time <code>deleted_at</code> TIMESTAMP Soft delete timestamp for audit <p>Indexes: - <code>idx_build_artifacts_build_id</code> - Fast lookups by build - <code>idx_build_artifacts_state_code</code> - Find artifacts by state - <code>idx_build_artifacts_type</code> - Filter by artifact type - <code>idx_build_artifacts_resumable</code> - Find resumable artifacts only - Unique constraint on <code>(build_id, artifact_name)</code></p>"},{"location":"artifact-storage/#supported-storage-types","title":"Supported Storage Types","text":"<p>The <code>artifact_storage_type</code> field accepts any string value, but common values include:</p> <ul> <li><code>s3</code> - Amazon S3 or S3-compatible object storage</li> <li><code>nfs</code> - Network File System</li> <li><code>ebs</code> - Amazon Elastic Block Store (multi-mounted volumes)</li> <li><code>ceph</code> - Ceph distributed storage</li> <li><code>azure-blob</code> - Azure Blob Storage</li> <li><code>gcs</code> - Google Cloud Storage</li> <li><code>local</code> - Local filesystem (for testing only)</li> <li><code>smb</code> - Windows SMB/CIFS shares</li> <li><code>glusterfs</code> - GlusterFS distributed filesystem</li> </ul>"},{"location":"artifact-storage/#storage-path-examples","title":"Storage Path Examples","text":""},{"location":"artifact-storage/#s3","title":"S3","text":"<pre><code>s3://my-build-artifacts/project-123/build-456/state-10/artifact.qcow2\ns3://company-builds/builds/2026-02-16/abc123-def456-state25.tar.gz\n</code></pre>"},{"location":"artifact-storage/#nfs","title":"NFS","text":"<pre><code>/mnt/nfs/build-artifacts/project-123/build-456/state-10/artifact.qcow2\nnfs://nfs-server.example.com/exports/builds/abc123/state-10.img\n</code></pre>"},{"location":"artifact-storage/#ebs-multi-attach","title":"EBS (Multi-Attach)","text":"<pre><code>/mnt/ebs-shared/build-artifacts/project-123/build-456/state-10/artifact.qcow2\n</code></pre>"},{"location":"artifact-storage/#ceph","title":"Ceph","text":"<pre><code>rbd:pool/build-artifacts/project-123/build-456/state-10\nceph://cluster-name/pool-name/abc123-state10\n</code></pre>"},{"location":"artifact-storage/#azure-blob","title":"Azure Blob","text":"<pre><code>https://myaccount.blob.core.windows.net/build-artifacts/project-123/build-456/state-10/artifact.vhd\n</code></pre>"},{"location":"artifact-storage/#google-cloud-storage","title":"Google Cloud Storage","text":"<pre><code>gs://my-build-bucket/artifacts/project-123/build-456/state-10/artifact.tar.gz\n</code></pre>"},{"location":"artifact-storage/#api-usage","title":"API Usage","text":""},{"location":"artifact-storage/#creating-a-build-state-with-artifact-information","title":"Creating a Build State with Artifact Information","text":"<p>When transitioning to a new build state, include artifact storage information:</p> <p>Request: <pre><code>curl -X POST \"http://localhost:8080/builds/{build_id}/state\" \\\n  -H \"X-API-Key: dev-key-12345\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"state_name\": \"package-installation\",\n    \"message\": \"Packages installed successfully\",\n    \"artifact_storage_type\": \"s3\",\n    \"artifact_storage_path\": \"s3://my-builds/project-123/build-456/state-25/base-image.qcow2\",\n    \"artifact_size_bytes\": 2147483648,\n    \"artifact_checksum\": \"sha256:abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n    \"artifact_metadata\": {\n      \"compression\": \"gzip\",\n      \"format\": \"qcow2\",\n      \"virtual_size_gb\": 100,\n      \"upload_duration_seconds\": 45\n    }\n  }'\n</code></pre></p> <p>Response: <pre><code>{\n  \"id\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"build_id\": \"7c9e6679-7425-40de-944b-e07fc1f90ae7\",\n  \"state\": 25,\n  \"status\": \"completed\",\n  \"start_time\": \"2026-02-16T10:30:00Z\",\n  \"end_time\": \"2026-02-16T10:45:00Z\",\n  \"duration_seconds\": 900,\n  \"artifact_storage_type\": \"s3\",\n  \"artifact_storage_path\": \"s3://my-builds/project-123/build-456/state-25/base-image.qcow2\",\n  \"artifact_size_bytes\": 2147483648,\n  \"artifact_checksum\": \"sha256:abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"artifact_metadata\": {\n    \"compression\": \"gzip\",\n    \"format\": \"qcow2\",\n    \"virtual_size_gb\": 100,\n    \"upload_duration_seconds\": 45\n  },\n  \"created_at\": \"2026-02-16T10:30:00Z\"\n}\n</code></pre></p>"},{"location":"artifact-storage/#managing-build-artifacts-full-registry","title":"Managing Build Artifacts (Full Registry)","text":"<p>The Build Artifacts API provides comprehensive artifact lifecycle management for resumable builds.</p>"},{"location":"artifact-storage/#creating-a-build-artifact","title":"Creating a Build Artifact","text":"<p>Register an artifact with full metadata and checksum:</p> <p>Request: <pre><code>curl -X POST \"http://localhost:8080/builds/{build_id}/artifacts\" \\\n  -H \"X-API-Key: dev-key-12345\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"state_code\": 20,\n    \"artifact_name\": \"base-vm-snapshot\",\n    \"artifact_type\": \"vm_snapshot\",\n    \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n    \"storage_backend\": \"s3\",\n    \"storage_region\": \"us-east-1\",\n    \"storage_bucket\": \"my-builds\",\n    \"storage_key\": \"project-123/build-456/state-20/snapshot.qcow2\",\n    \"size_bytes\": 2147483648,\n    \"checksum\": \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n    \"checksum_algorithm\": \"sha256\",\n    \"is_resumable\": true,\n    \"is_final\": false,\n    \"metadata\": {\n      \"vm_id\": \"vm-abc123\",\n      \"snapshot_id\": \"snap-xyz789\",\n      \"disk_format\": \"qcow2\",\n      \"compression\": \"none\"\n    }\n  }'\n</code></pre></p> <p>Response: <pre><code>{\n  \"id\": \"artifact-uuid-123\",\n  \"build_id\": \"build-uuid-456\",\n  \"state_code\": 20,\n  \"artifact_name\": \"base-vm-snapshot\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n  \"storage_backend\": \"s3\",\n  \"storage_region\": \"us-east-1\",\n  \"storage_bucket\": \"my-builds\",\n  \"storage_key\": \"project-123/build-456/state-20/snapshot.qcow2\",\n  \"size_bytes\": 2147483648,\n  \"checksum\": \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"checksum_algorithm\": \"sha256\",\n  \"is_resumable\": true,\n  \"is_final\": false,\n  \"metadata\": {\n    \"vm_id\": \"vm-abc123\",\n    \"snapshot_id\": \"snap-xyz789\",\n    \"disk_format\": \"qcow2\",\n    \"compression\": \"none\"\n  },\n  \"created_at\": \"2026-02-16T10:30:00Z\",\n  \"updated_at\": \"2026-02-16T10:30:00Z\"\n}\n</code></pre></p>"},{"location":"artifact-storage/#listing-resumable-artifacts","title":"Listing Resumable Artifacts","text":"<p>Find all resumable artifacts for a build (for recovery):</p> <pre><code>curl \"http://localhost:8080/builds/{build_id}/artifacts?is_resumable=true\" \\\n  -H \"X-API-Key: dev-key-12345\"\n</code></pre> <p>Response: <pre><code>[\n  {\n    \"id\": \"artifact-uuid-123\",\n    \"build_id\": \"build-uuid-456\",\n    \"state_code\": 20,\n    \"artifact_name\": \"base-vm-snapshot\",\n    \"artifact_type\": \"vm_snapshot\",\n    \"artifact_path\": \"s3://my-builds/...qcow2\",\n    \"storage_backend\": \"s3\",\n    \"size_bytes\": 2147483648,\n    \"checksum\": \"abcdef0123...\",\n    \"is_resumable\": true,\n    \"is_final\": false,\n    \"created_at\": \"2026-02-16T10:30:00Z\"\n  },\n  {\n    \"id\": \"artifact-uuid-456\",\n    \"build_id\": \"build-uuid-456\",\n    \"state_code\": 35,\n    \"artifact_name\": \"configured-vm-snapshot\",\n    \"artifact_type\": \"vm_snapshot\",\n    \"artifact_path\": \"s3://my-builds/...qcow2\",\n    \"storage_backend\": \"s3\",\n    \"size_bytes\": 3221225472,\n    \"checksum\": \"fedcba9876...\",\n    \"is_resumable\": true,\n    \"is_final\": false,\n    \"created_at\": \"2026-02-16T11:15:00Z\"\n  }\n]\n</code></pre></p>"},{"location":"artifact-storage/#querying-build-state-history-for-artifacts","title":"Querying Build State History for Artifacts","text":"<p>Get all build states to find artifacts:</p> <pre><code>curl \"http://localhost:8080/builds/{build_id}/states\" \\\n  -H \"X-API-Key: readonly-key-888\"\n</code></pre> <p>Query the database directly to find the latest artifact for a specific state:</p> <pre><code>SELECT \n    artifact_storage_type,\n    artifact_storage_path,\n    artifact_size_bytes,\n    artifact_checksum,\n    artifact_metadata\nFROM build_states\nWHERE build_id = '7c9e6679-7425-40de-944b-e07fc1f90ae7' \n  AND state = 25\n  AND artifact_storage_path IS NOT NULL\nORDER BY created_at DESC\nLIMIT 1;\n</code></pre>"},{"location":"artifact-storage/#cli-usage","title":"CLI Usage","text":"<p>The BuildState CLI (<code>bldst</code>) provides convenient commands for managing artifacts.</p>"},{"location":"artifact-storage/#quick-reference-with-build-states","title":"Quick Reference with Build States","text":"<p>Add a build state with artifact information (for basic tracking):</p> <pre><code>bldst build add-state {build-id} \\\n  --state 25 \\\n  --status completed \\\n  --storage-type s3 \\\n  --storage-path \"s3://my-builds/project-123/build-456/state-25/base-image.qcow2\" \\\n  --artifact-size 2147483648 \\\n  --checksum \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\"\n</code></pre>"},{"location":"artifact-storage/#full-artifact-management-recommended-for-resumable-builds","title":"Full Artifact Management (Recommended for Resumable Builds)","text":""},{"location":"artifact-storage/#register-a-new-artifact","title":"Register a New Artifact","text":"<pre><code># After uploading an artifact to storage, register it in the system\nbldst artifact create {build-id} \\\n  --name \"base-vm-snapshot\" \\\n  --type \"vm_snapshot\" \\\n  --path \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\" \\\n  --state 20 \\\n  --backend \"s3\" \\\n  --region \"us-east-1\" \\\n  --bucket \"my-builds\" \\\n  --key \"project-123/build-456/state-20/snapshot.qcow2\" \\\n  --size 2147483648 \\\n  --checksum \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\" \\\n  --resumable\n</code></pre>"},{"location":"artifact-storage/#list-all-artifacts-for-a-build","title":"List All Artifacts for a Build","text":"<pre><code>bldst artifact list {build-id}\n</code></pre>"},{"location":"artifact-storage/#list-only-resumable-artifacts-for-recovery","title":"List Only Resumable Artifacts (for Recovery)","text":"<pre><code># Find artifacts that can be used to resume a failed build\nbldst artifact list-resumable {build-id}\n</code></pre> <p>Example Output: <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Artifact ID  \u2502 Name              \u2502 Type        \u2502 State Code \u2502 Size     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 abc123...    \u2502 base-vm-snapshot  \u2502 vm_snapshot \u2502 20         \u2502 2.0 GB   \u2502\n\u2502 def456...    \u2502 configured-vm     \u2502 vm_snapshot \u2502 35         \u2502 3.0 GB   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre></p>"},{"location":"artifact-storage/#get-artifact-details","title":"Get Artifact Details","text":"<pre><code>bldst artifact get {build-id} {artifact-id}\n</code></pre> <p>Example Output: <pre><code>{\n  \"id\": \"abc123...\",\n  \"build_id\": \"build-uuid-456\",\n  \"state_code\": 20,\n  \"artifact_name\": \"base-vm-snapshot\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n  \"storage_backend\": \"s3\",\n  \"storage_region\": \"us-east-1\",\n  \"size_bytes\": 2147483648,\n  \"checksum\": \"abcdef01234...\",\n  \"checksum_algorithm\": \"sha256\",\n  \"is_resumable\": true,\n  \"is_final\": false,\n  \"metadata\": {\n    \"vm_id\": \"vm-abc123\",\n    \"snapshot_id\": \"snap-xyz789\"\n  },\n  \"created_at\": \"2026-02-16T10:30:00Z\"\n}\n</code></pre></p>"},{"location":"artifact-storage/#update-artifact-metadata","title":"Update Artifact Metadata","text":"<pre><code># Mark an artifact as final when build completes\nbldst artifact update {build-id} {artifact-id} \\\n  --final \\\n  --name \"rhel-9-base-final\"\n</code></pre>"},{"location":"artifact-storage/#cli-parameters","title":"CLI Parameters","text":"Parameter Description Required <code>--name</code> Unique artifact name within the build Yes <code>--type</code> Artifact type (vm_snapshot, ami, disk_image, etc.) Yes <code>--path</code> Full path/URI to the stored artifact Yes <code>--state</code> State code at which artifact was created Yes <code>--backend</code> Storage backend (s3, azure_blob, gcp_storage, etc.) Yes <code>--region</code> Storage region No <code>--bucket</code> Storage bucket or container name No <code>--key</code> Storage key/path within bucket No <code>--size</code> Size in bytes No <code>--checksum</code> SHA256 checksum No <code>--checksum-algorithm</code> Checksum algorithm (default: sha256) No <code>--resumable</code> Mark as resumable (default: true) No <code>--final</code> Mark as final deliverable No"},{"location":"artifact-storage/#best-practices","title":"Best Practices","text":""},{"location":"artifact-storage/#1-always-include-storage-type-and-path-together","title":"1. Always Include Storage Type and Path Together","text":"<p>When uploading an artifact, always provide both <code>artifact_storage_type</code> and <code>artifact_storage_path</code>:</p> <pre><code>{\n  \"artifact_storage_type\": \"s3\",\n  \"artifact_storage_path\": \"s3://bucket/path/to/artifact\"\n}\n</code></pre>"},{"location":"artifact-storage/#2-use-checksums-for-verification","title":"2. Use Checksums for Verification","text":"<p>Always include checksums to verify artifact integrity:</p> <pre><code>{\n  \"artifact_checksum\": \"sha256:abc123...\"\n}\n</code></pre>"},{"location":"artifact-storage/#3-include-size-for-optimization","title":"3. Include Size for Optimization","text":"<p>Recording artifact size helps with: - Storage planning - Download estimation - Resource allocation</p> <pre><code>{\n  \"artifact_size_bytes\": 2147483648\n}\n</code></pre>"},{"location":"artifact-storage/#4-use-metadata-for-additional-context","title":"4. Use Metadata for Additional Context","text":"<p>Store helpful metadata about the artifact:</p> <pre><code>{\n  \"artifact_metadata\": {\n    \"format\": \"qcow2\",\n    \"compression\": \"gzip\",\n    \"virtual_size_gb\": 100,\n    \"created_by\": \"packer\",\n    \"packer_version\": \"1.9.0\",\n    \"upload_duration_seconds\": 45,\n    \"region\": \"us-east-1\"\n  }\n}\n</code></pre>"},{"location":"artifact-storage/#5-use-uris-for-clarity","title":"5. Use URIs for Clarity","text":"<p>Use full URIs for storage paths to avoid ambiguity:</p> <p>Good: <pre><code>s3://my-bucket/builds/abc123/state-10.qcow2\nnfs://server.example.com/exports/builds/abc123.img\n</code></pre></p> <p>Not Recommended: <pre><code>/builds/abc123/state-10.qcow2  (ambiguous - local or NFS?)\nabc123/state-10.qcow2          (missing protocol)\n</code></pre></p>"},{"location":"artifact-storage/#6-consistent-naming-conventions","title":"6. Consistent Naming Conventions","text":"<p>Establish a consistent naming pattern for artifacts:</p> <pre><code>{storage-type}://{location}/{project-id}/{build-id}/state-{state-code}/{filename}\n</code></pre> <p>Example: <pre><code>s3://build-artifacts/project-a1b2c3/build-d4e5f6/state-25/base-image.qcow2\n</code></pre></p>"},{"location":"artifact-storage/#migration","title":"Migration","text":""},{"location":"artifact-storage/#applying-the-migration","title":"Applying the Migration","text":"<p>For existing databases, run the migration script:</p> <pre><code>psql -U buildstate -d buildstate -f api_service/artifact_storage_migration.sql\n</code></pre>"},{"location":"artifact-storage/#migration-script","title":"Migration Script","text":"<p>The migration adds the following columns to <code>build_states</code>:</p> <pre><code>ALTER TABLE build_states \nADD COLUMN IF NOT EXISTS artifact_storage_type VARCHAR(50),\nADD COLUMN IF NOT EXISTS artifact_storage_path TEXT,\nADD COLUMN IF NOT EXISTS artifact_size_bytes BIGINT,\nADD COLUMN IF NOT EXISTS artifact_checksum VARCHAR(128),\nADD COLUMN IF NOT EXISTS artifact_metadata JSONB;\n\nCREATE INDEX IF NOT EXISTS idx_build_states_artifact_storage_type \nON build_states(artifact_storage_type);\n\nCREATE INDEX IF NOT EXISTS idx_build_states_build_id_state \nON build_states(build_id, state);\n</code></pre>"},{"location":"artifact-storage/#example-workflow","title":"Example Workflow","text":""},{"location":"artifact-storage/#complete-build-workflow-with-artifacts","title":"Complete Build Workflow with Artifacts","text":"<pre><code>#!/bin/bash\n# Example: Distributed build workflow with artifact tracking\n\nAPI_URL=\"http://localhost:8080\"\nAPI_KEY=\"dev-key-12345\"\nBUILD_ID=\"7c9e6679-7425-40de-944b-e07fc1f90ae7\"\nPROJECT_BUCKET=\"s3://my-build-artifacts\"\n\n# State 10: Create base VM image\necho \"State 10: Creating base image...\"\npacker build base-image.pkr.hcl\nBASE_IMAGE=\"base-image.qcow2\"\n\n# Upload to S3\necho \"Uploading base image to S3...\"\nCHECKSUM=$(sha256sum \"$BASE_IMAGE\" | awk '{print $1}')\nSIZE=$(stat -f%z \"$BASE_IMAGE\")\naws s3 cp \"$BASE_IMAGE\" \"$PROJECT_BUCKET/$BUILD_ID/state-10/$BASE_IMAGE\"\n\n# Record artifact location\ncurl -X POST \"$API_URL/builds/$BUILD_ID/state\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\n    \\\"state_name\\\": \\\"base-image-created\\\",\n    \\\"message\\\": \\\"Base image created and uploaded\\\",\n    \\\"artifact_storage_type\\\": \\\"s3\\\",\n    \\\"artifact_storage_path\\\": \\\"$PROJECT_BUCKET/$BUILD_ID/state-10/$BASE_IMAGE\\\",\n    \\\"artifact_size_bytes\\\": $SIZE,\n    \\\"artifact_checksum\\\": \\\"sha256:$CHECKSUM\\\"\n  }\"\n\n# State 20: Install packages (may run on different server)\necho \"State 20: Installing packages...\"\n\n# Download previous artifact\nPREV_ARTIFACT=$(curl -s \"$API_URL/builds/$BUILD_ID/states\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  | jq -r '.[] | select(.state == 10) | .artifact_storage_path')\n\necho \"Downloading artifact from: $PREV_ARTIFACT\"\naws s3 cp \"$PREV_ARTIFACT\" \"base-image.qcow2\"\n\n# Verify checksum\nEXPECTED_CHECKSUM=$(curl -s \"$API_URL/builds/$BUILD_ID/states\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  | jq -r '.[] | select(.state == 10) | .artifact_checksum' \\\n  | sed 's/sha256://')\n\nACTUAL_CHECKSUM=$(sha256sum base-image.qcow2 | awk '{print $1}')\n\nif [ \"$EXPECTED_CHECKSUM\" != \"$ACTUAL_CHECKSUM\" ]; then\n  echo \"ERROR: Checksum mismatch!\"\n  exit 1\nfi\n\necho \"Checksum verified successfully!\"\n\n# Continue with package installation...\n# ... build process continues ...\n</code></pre>"},{"location":"artifact-storage/#troubleshooting","title":"Troubleshooting","text":""},{"location":"artifact-storage/#artifact-not-found","title":"Artifact Not Found","text":"<p>If a build server cannot find an artifact:</p> <ol> <li> <p>Verify the build state was recorded correctly:    <pre><code>curl \"$API_URL/builds/{build_id}/states\" -H \"X-API-Key: $API_KEY\" | jq\n</code></pre></p> </li> <li> <p>Check the artifact exists in storage:    <pre><code>aws s3 ls s3://bucket/path/to/artifact\n</code></pre></p> </li> <li> <p>Verify access permissions to the storage backend</p> </li> </ol>"},{"location":"artifact-storage/#checksum-mismatch","title":"Checksum Mismatch","text":"<p>If checksums don't match:</p> <ol> <li>Re-download the artifact</li> <li>Check for network corruption</li> <li>Verify the upload was successful</li> <li>Consider re-uploading the artifact</li> </ol>"},{"location":"artifact-storage/#performance-issues","title":"Performance Issues","text":"<p>For large artifacts:</p> <ol> <li>Use compression when possible</li> <li>Consider multi-part uploads for large files</li> <li>Use storage in the same region as build servers</li> <li>Implement caching strategies for frequently accessed artifacts</li> </ol>"},{"location":"artifact-storage/#security-considerations","title":"Security Considerations","text":"<ol> <li>Access Control: Ensure build servers have appropriate IAM roles or credentials for storage access</li> <li>Encryption: Use encryption at rest and in transit (e.g., S3 SSE, TLS)</li> <li>Checksums: Always verify checksums to detect corruption or tampering</li> <li>Lifecycle Policies: Implement storage lifecycle policies to manage costs</li> <li>Audit Logging: Enable audit logging on storage backends for compliance</li> </ol>"},{"location":"artifact-storage/#future-enhancements","title":"Future Enhancements","text":"<p>Potential future enhancements to artifact storage tracking:</p> <ul> <li>Automatic artifact cleanup/expiration</li> <li>Artifact retention policies</li> <li>Multi-region artifact replication</li> <li>Artifact caching layer</li> <li>Automatic checksum verification in API</li> <li>Artifact version tracking</li> <li>Artifact dependency graphs</li> </ul> <p>Last Updated: February 16, 2026</p>"},{"location":"ci-cd-pipeline/","title":"CI/CD Pipeline and Semantic Versioning","text":"<p>This document describes the CI/CD infrastructure for the Build State project, including semantic versioning, automated builds, and container registry publishing.</p>"},{"location":"ci-cd-pipeline/#table-of-contents","title":"Table of Contents","text":"<ul> <li>Overview</li> <li>Semantic Versioning</li> <li>GitHub Actions Workflows</li> <li>Container Registry</li> <li>Version Management</li> <li>Release Process</li> <li>Usage Examples</li> </ul>"},{"location":"ci-cd-pipeline/#overview","title":"Overview","text":"<p>The Build State project uses a lightweight, file-based semantic versioning approach with GitHub Actions for automated builds and container publishing. This provides:</p> <ul> <li>Semantic versioning via a VERSION file at the project root</li> <li>Automated container builds for every push to main/develop</li> <li>GitHub Container Registry (ghcr.io) for hosting Docker images</li> <li>Git flow branching model (main, develop, feature/*)</li> <li>Lightweight tooling - no heavy dependencies like gitversion</li> </ul>"},{"location":"ci-cd-pipeline/#semantic-versioning","title":"Semantic Versioning","text":""},{"location":"ci-cd-pipeline/#version-format","title":"Version Format","text":"<p>We follow Semantic Versioning 2.0.0:</p> <pre><code>MAJOR.MINOR.PATCH[-PRERELEASE][+BUILDMETADATA]\n</code></pre> <ul> <li>MAJOR: Breaking changes</li> <li>MINOR: New features (backwards compatible)</li> <li>PATCH: Bug fixes (backwards compatible)</li> <li>PRERELEASE: Optional pre-release identifier (e.g., <code>-beta.1</code>, <code>-rc.2</code>)</li> <li>BUILDMETADATA: Build information (e.g., <code>+abc1234</code>, <code>+abc1234-dirty</code>)</li> </ul>"},{"location":"ci-cd-pipeline/#version-file","title":"Version File","text":"<p>The authoritative version is stored in the <code>VERSION</code> file at the project root:</p> <pre><code>$ cat VERSION\n2.0.0\n</code></pre>"},{"location":"ci-cd-pipeline/#version-script","title":"Version Script","text":"<p>The <code>scripts/version.sh</code> script provides version management:</p> <pre><code># View current version\n./scripts/version.sh current\n\n# View version with git info\n./scripts/version.sh full\n# Output: 2.0.0+abc1234\n\n# Bump version\n./scripts/version.sh bump patch    # 2.0.0 \u2192 2.0.1\n./scripts/version.sh bump minor    # 2.0.1 \u2192 2.1.0\n./scripts/version.sh bump major    # 2.1.0 \u2192 3.0.0\n\n# Set specific version\n./scripts/version.sh set 2.5.0\n\n# Create git tag\n./scripts/version.sh tag\n\n# Calculate next version from conventional commits\n./scripts/version.sh next\n</code></pre>"},{"location":"ci-cd-pipeline/#github-actions-workflows","title":"GitHub Actions Workflows","text":""},{"location":"ci-cd-pipeline/#1-build-and-publish-build-and-publishyml","title":"1. Build and Publish (<code>build-and-publish.yml</code>)","text":"<p>Triggers: - Push to <code>main</code> or <code>develop</code> branches - Push tags matching <code>v*</code> - Pull requests to <code>main</code> or <code>develop</code> - Manual workflow dispatch</p> <p>What it does: 1. Determines version from VERSION file, git tag, or manual input 2. Builds API service Docker image 3. Builds Nginx load balancer Docker image 4. Builds Python CLI package 5. Pushes images to GitHub Container Registry 6. Tags images with multiple tags:    - Semantic version (e.g., <code>2.0.0</code>)    - Full version with SHA (e.g., <code>2.0.0+abc1234</code>)    - Branch name (e.g., <code>develop</code>, <code>main</code>)    - Git SHA (e.g., <code>main-abc1234</code>)    - <code>latest</code> for main branch    - <code>develop</code> for develop branch</p> <p>Images published: - <code>ghcr.io/&lt;owner&gt;/state-builds-api:&lt;version&gt;</code> - <code>ghcr.io/&lt;owner&gt;/state-builds-nginx:&lt;version&gt;</code></p>"},{"location":"ci-cd-pipeline/#2-version-and-release-version-and-releaseyml","title":"2. Version and Release (<code>version-and-release.yml</code>)","text":"<p>Triggers: - Manual workflow dispatch only</p> <p>Inputs: - <code>bump</code>: Version bump type (major, minor, patch) - <code>create_tag</code>: Whether to create a git tag (default: true) - <code>create_release</code>: Whether to create GitHub release (default: false)</p> <p>What it does: 1. Bumps version in VERSION file 2. Updates version in <code>bldst_cli/pyproject.toml</code> 3. Commits changes 4. Creates git tag (if requested) 5. Creates GitHub release with changelog (if requested)</p>"},{"location":"ci-cd-pipeline/#3-test-build-testyml","title":"3. Test Build (<code>test.yml</code>)","text":"<p>Triggers: - Pull requests to <code>main</code> or <code>develop</code> - Manual workflow dispatch</p> <p>What it does: 1. Lints Python code with ruff 2. Tests CLI installation 3. Performs test Docker builds (without pushing)</p>"},{"location":"ci-cd-pipeline/#container-registry","title":"Container Registry","text":""},{"location":"ci-cd-pipeline/#authentication","title":"Authentication","text":"<p>Images are published to GitHub Container Registry (ghcr.io). To pull images:</p> <pre><code># Public images (no auth needed)\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:latest\n\n# Private images (requires GitHub token)\necho $GITHUB_TOKEN | docker login ghcr.io -u &lt;username&gt; --password-stdin\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:latest\n</code></pre>"},{"location":"ci-cd-pipeline/#image-tags","title":"Image Tags","text":"<p>Each build produces multiple tags:</p> Tag Pattern Example Description <code>&lt;version&gt;</code> <code>2.0.0</code> Semantic version <code>&lt;version&gt;+&lt;sha&gt;</code> <code>2.0.0+abc1234</code> Full version with git SHA <code>&lt;branch&gt;</code> <code>develop</code> Branch name <code>&lt;branch&gt;-&lt;sha&gt;</code> <code>main-abc1234</code> Branch + short SHA <code>latest</code> <code>latest</code> Latest main branch build <code>develop</code> <code>develop</code> Latest develop branch build"},{"location":"ci-cd-pipeline/#using-images","title":"Using Images","text":"<p>Update your <code>docker-compose.yml</code> to use registry images:</p> <pre><code>services:\n  api:\n    image: ghcr.io/&lt;owner&gt;/state-builds-api:2.0.0\n    # ... rest of config\n\n  nginx:\n    image: ghcr.io/&lt;owner&gt;/state-builds-nginx:2.0.0\n    # ... rest of config\n</code></pre>"},{"location":"ci-cd-pipeline/#version-management","title":"Version Management","text":""},{"location":"ci-cd-pipeline/#conventional-commits","title":"Conventional Commits","text":"<p>We recommend using Conventional Commits for automatic version bumping:</p> <pre><code># Patch bump (2.0.0 \u2192 2.0.1)\ngit commit -m \"fix: resolve authentication bug\"\n\n# Minor bump (2.0.0 \u2192 2.1.0)\ngit commit -m \"feat: add artifact compression support\"\n\n# Major bump (2.0.0 \u2192 3.0.0)\ngit commit -m \"feat!: redesign API endpoints\n\nBREAKING CHANGE: All /api/v1 endpoints moved to /api/v2\"\n</code></pre>"},{"location":"ci-cd-pipeline/#manual-version-bumps","title":"Manual Version Bumps","text":"<pre><code># Bump version locally\n./scripts/version.sh bump patch\n\n# Commit and push\ngit add VERSION bldst_cli/pyproject.toml\ngit commit -m \"chore: bump version to $(cat VERSION)\"\ngit push\n\n# Create and push tag\n./scripts/version.sh tag\ngit push origin v$(cat VERSION)\n</code></pre>"},{"location":"ci-cd-pipeline/#automated-version-bumps","title":"Automated Version Bumps","text":"<p>Use the \"Version and Release\" workflow:</p> <ol> <li>Go to Actions \u2192 Version and Release</li> <li>Click \"Run workflow\"</li> <li>Select bump type (major, minor, patch)</li> <li>Choose whether to create tag and release</li> <li>Run workflow</li> </ol>"},{"location":"ci-cd-pipeline/#release-process","title":"Release Process","text":""},{"location":"ci-cd-pipeline/#standard-release-git-flow","title":"Standard Release (Git Flow)","text":"<pre><code># 1. Create feature branch\ngit flow feature start awesome-feature\n\n# 2. Make changes and commit\ngit add .\ngit commit -m \"feat: implement awesome feature\"\n\n# 3. Finish feature (merges to develop)\ngit flow feature finish awesome-feature\n\n# 4. Push develop\ngit push origin develop\n\n# 5. When ready for release, use GitHub Actions:\n#    - Go to Actions \u2192 Version and Release\n#    - Select bump type and run workflow\n#    - This creates tag and merges to main\n\n# 6. Merge to main (or use release branch)\ngit checkout main\ngit merge develop\ngit push origin main\n\n# 7. GitHub Actions automatically builds and publishes containers\n</code></pre>"},{"location":"ci-cd-pipeline/#hotfix-release","title":"Hotfix Release","text":"<pre><code># 1. Create hotfix branch\ngit flow hotfix start critical-fix\n\n# 2. Fix the issue\ngit commit -m \"fix: critical security issue\"\n\n# 3. Finish hotfix (merges to main and develop)\ngit flow hotfix finish critical-fix\n\n# 4. Use GitHub Actions to bump patch version\n</code></pre>"},{"location":"ci-cd-pipeline/#pre-release","title":"Pre-release","text":"<pre><code># 1. Manually set pre-release version\n./scripts/version.sh set 2.1.0-beta.1\n\n# 2. Commit and tag\ngit add VERSION\ngit commit -m \"chore: release 2.1.0-beta.1\"\n./scripts/version.sh tag\ngit push origin v2.1.0-beta.1\n\n# 3. Build and publish as pre-release\n</code></pre>"},{"location":"ci-cd-pipeline/#usage-examples","title":"Usage Examples","text":""},{"location":"ci-cd-pipeline/#checking-action-status","title":"Checking Action Status","text":"<p>Use <code>gh</code> CLI to check workflow runs:</p> <pre><code># List recent workflow runs\ngh run list\n\n# View specific workflow\ngh run list --workflow=build-and-publish.yml\n\n# Watch running workflow\ngh run watch\n\n# View workflow details\ngh run view &lt;run-id&gt;\n\n# View logs\ngh run view &lt;run-id&gt; --log\n</code></pre>"},{"location":"ci-cd-pipeline/#building-locally-with-version","title":"Building Locally with Version","text":"<pre><code># Get current version\nVERSION=$(./scripts/version.sh current)\nGIT_SHA=$(git rev-parse --short HEAD)\nFULL_VERSION=\"${VERSION}+${GIT_SHA}\"\n\n# Build with version\ndocker build \\\n  --build-arg VERSION=$FULL_VERSION \\\n  -t state-builds-api:$VERSION \\\n  -f api_service/docker/Dockerfile \\\n  api_service/\n\n# Tag with multiple tags\ndocker tag state-builds-api:$VERSION state-builds-api:latest\ndocker tag state-builds-api:$VERSION state-builds-api:develop\n</code></pre>"},{"location":"ci-cd-pipeline/#pulling-specific-versions","title":"Pulling Specific Versions","text":"<pre><code># Pull specific version\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:2.0.0\n\n# Pull latest develop\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:develop\n\n# Pull latest stable\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:latest\n\n# Pull specific commit\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:main-abc1234\n</code></pre>"},{"location":"ci-cd-pipeline/#inspecting-image-version","title":"Inspecting Image Version","text":"<pre><code># Check version label\ndocker inspect ghcr.io/&lt;owner&gt;/state-builds-api:latest \\\n  | jq '.[0].Config.Labels'\n\n# Run container and check version endpoint\ndocker run --rm ghcr.io/&lt;owner&gt;/state-builds-api:latest \\\n  python -c \"from app.core.config import settings; print(settings.VERSION)\"\n</code></pre>"},{"location":"ci-cd-pipeline/#cicd-best-practices","title":"CI/CD Best Practices","text":""},{"location":"ci-cd-pipeline/#branch-protection","title":"Branch Protection","text":"<p>Configure branch protection rules: - main: Require PR, require status checks, no direct pushes - develop: Require PR for external contributors</p>"},{"location":"ci-cd-pipeline/#secrets-management","title":"Secrets Management","text":"<p>Required GitHub secrets: - <code>GITHUB_TOKEN</code>: Automatically provided (for container registry) - <code>PYPI_API_TOKEN</code>: Optional, for publishing CLI to PyPI</p>"},{"location":"ci-cd-pipeline/#caching","title":"Caching","text":"<p>GitHub Actions uses Docker layer caching: - <code>cache-from: type=gha</code> - <code>cache-to: type=gha,mode=max</code></p> <p>This speeds up builds significantly.</p>"},{"location":"ci-cd-pipeline/#multi-architecture-builds","title":"Multi-architecture Builds","text":"<p>To build for multiple architectures:</p> <pre><code>- name: Build and push\n  uses: docker/build-push-action@v5\n  with:\n    platforms: linux/amd64,linux/arm64\n    # ... rest of config\n</code></pre>"},{"location":"ci-cd-pipeline/#security-scanning","title":"Security Scanning","text":"<p>Add security scanning to workflow:</p> <pre><code>- name: Run Trivy vulnerability scanner\n  uses: aquasecurity/trivy-action@master\n  with:\n    image-ref: ${{ env.IMAGE_BASE }}/state-builds-api:${{ needs.version.outputs.version }}\n    format: 'sarif'\n    output: 'trivy-results.sarif'\n\n- name: Upload Trivy results to GitHub Security\n  uses: github/codeql-action/upload-sarif@v2\n  with:\n    sarif_file: 'trivy-results.sarif'\n</code></pre>"},{"location":"ci-cd-pipeline/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ci-cd-pipeline/#workflow-fails-to-push-images","title":"Workflow Fails to Push Images","text":"<p>Error: <code>denied: permission_denied: write_package</code></p> <p>Solution: 1. Go to Settings \u2192 Actions \u2192 General 2. Under \"Workflow permissions\", select \"Read and write permissions\" 3. Save changes</p>"},{"location":"ci-cd-pipeline/#version-file-out-of-sync","title":"Version File Out of Sync","text":"<p>Error: Version mismatch between VERSION file and git tags</p> <p>Solution: <pre><code># Check current versions\ncat VERSION\ngit describe --tags --abbrev=0\n\n# Sync VERSION file to latest tag\ngit describe --tags --abbrev=0 | sed 's/^v//' &gt; VERSION\ngit add VERSION\ngit commit -m \"chore: sync VERSION file with git tag\"\n</code></pre></p>"},{"location":"ci-cd-pipeline/#docker-build-fails","title":"Docker Build Fails","text":"<p>Error: Build fails in GitHub Actions but works locally</p> <p>Solution: 1. Check architecture compatibility 2. Verify all files are committed (<code>.dockerignore</code> might be hiding files) 3. Check build args are properly passed 4. Review build logs for specific errors</p>"},{"location":"ci-cd-pipeline/#cannot-pull-images","title":"Cannot Pull Images","text":"<p>Error: <code>Error response from daemon: unauthorized</code></p> <p>Solution: <pre><code># Ensure you're logged in\necho $GITHUB_TOKEN | docker login ghcr.io -u &lt;username&gt; --password-stdin\n\n# Check image exists and is public\ngh api /users/&lt;owner&gt;/packages/container/state-builds-api\n\n# Make package public (if needed)\n# Go to: https://github.com/users/&lt;owner&gt;/packages/container/state-builds-api/settings\n</code></pre></p>"},{"location":"ci-cd-pipeline/#resources","title":"Resources","text":"<ul> <li>GitHub Actions Documentation</li> <li>GitHub Container Registry</li> <li>Semantic Versioning</li> <li>Conventional Commits</li> <li>Git Flow</li> <li>Docker Build Push Action</li> </ul>"},{"location":"ci-cd-quickstart/","title":"CI/CD Quick Reference","text":"<p>Quick commands and workflows for managing CI/CD in the Build State project.</p>"},{"location":"ci-cd-quickstart/#version-management","title":"Version Management","text":"<pre><code># View current version\n./scripts/version.sh current\n\n# View version with git info\n./scripts/version.sh full\n\n# Bump version\n./scripts/version.sh bump patch    # 2.0.0 \u2192 2.0.1\n./scripts/version.sh bump minor    # 2.0.1 \u2192 2.1.0  \n./scripts/version.sh bump major    # 2.1.0 \u2192 3.0.0\n\n# Create git tag\n./scripts/version.sh tag\ngit push origin v$(cat VERSION)\n\n# Calculate next version from conventional commits\n./scripts/version.sh next\n</code></pre>"},{"location":"ci-cd-quickstart/#github-actions","title":"GitHub Actions","text":"<pre><code># List recent workflow runs\n./scripts/gh-actions-status.sh list\n\n# Watch running workflow\n./scripts/gh-actions-status.sh watch\n\n# View specific workflow\n./scripts/gh-actions-status.sh workflow build-and-publish.yml\n\n# View logs for a run\n./scripts/gh-actions-status.sh logs &lt;run-id&gt;\n\n# Manually trigger workflow\n./scripts/gh-actions-status.sh trigger build-and-publish.yml\n\n# Show summary\n./scripts/gh-actions-status.sh summary\n</code></pre> <p>Or use <code>gh</code> CLI directly:</p> <pre><code># List runs\ngh run list\n\n# Watch run\ngh run watch\n\n# View run\ngh run view &lt;run-id&gt;\n\n# View logs\ngh run view &lt;run-id&gt; --log\n\n# Trigger workflow manually\ngh workflow run build-and-publish.yml\n</code></pre>"},{"location":"ci-cd-quickstart/#container-registry","title":"Container Registry","text":""},{"location":"ci-cd-quickstart/#pull-images","title":"Pull Images","text":"<pre><code># Latest stable\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:latest\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-nginx:latest\n\n# Specific version\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:2.0.0\n\n# Latest develop\ndocker pull ghcr.io/&lt;owner&gt;/state-builds-api:develop\n</code></pre>"},{"location":"ci-cd-quickstart/#login-to-ghcr","title":"Login to GHCR","text":"<pre><code># Create personal access token with read:packages scope\n# Then login\necho $GITHUB_TOKEN | docker login ghcr.io -u &lt;username&gt; --password-stdin\n</code></pre>"},{"location":"ci-cd-quickstart/#use-registry-images","title":"Use Registry Images","text":"<pre><code># Using docker-compose.registry.yml\nexport GHCR_OWNER=&lt;your-github-username&gt;\nexport IMAGE_VERSION=2.0.0\ndocker compose -f docker-compose.registry.yml up -d\n</code></pre>"},{"location":"ci-cd-quickstart/#git-flow-workflow","title":"Git Flow Workflow","text":""},{"location":"ci-cd-quickstart/#feature-development","title":"Feature Development","text":"<pre><code># Start feature\ngit flow feature start my-awesome-feature\n\n# Work on feature\ngit add .\ngit commit -m \"feat: add awesome feature\"\n\n# Finish feature (merges to develop)\ngit flow feature finish my-awesome-feature\ngit push origin develop\n\n# Trigger build\n# Push to develop automatically triggers GitHub Actions\n</code></pre>"},{"location":"ci-cd-quickstart/#release-process","title":"Release Process","text":"<pre><code># Option 1: Manual via GitHub Actions\n# Go to Actions \u2192 Version and Release \u2192 Run workflow\n# Select bump type (major, minor, patch)\n# Creates tag and optionally GitHub release\n\n# Option 2: Manual via scripts\n./scripts/version.sh bump minor\ngit add VERSION bldst_cli/pyproject.toml\ngit commit -m \"chore: bump version to $(cat VERSION)\"\ngit push origin develop\n\n./scripts/version.sh tag\ngit push origin v$(cat VERSION)\n\n# Merge to main\ngit checkout main\ngit merge develop\ngit push origin main\n</code></pre>"},{"location":"ci-cd-quickstart/#hotfix","title":"Hotfix","text":"<pre><code># Start hotfix from main\ngit flow hotfix start fix-critical-bug\n\n# Fix the issue\ngit add .\ngit commit -m \"fix: critical security issue\"\n\n# Finish hotfix (merges to main and develop)\ngit flow hotfix finish fix-critical-bug\n\n# Bump patch version via GitHub Actions\n# Go to Actions \u2192 Version and Release \u2192 patch\n</code></pre>"},{"location":"ci-cd-quickstart/#conventional-commits","title":"Conventional Commits","text":"<p>Use conventional commit messages for automatic version bumping:</p> <pre><code># Patch bump (bug fixes)\ngit commit -m \"fix: resolve authentication bug\"\ngit commit -m \"fix(api): handle null values in response\"\n\n# Minor bump (new features)\ngit commit -m \"feat: add artifact compression\"\ngit commit -m \"feat(cli): add progress bars\"\n\n# Major bump (breaking changes)\ngit commit -m \"feat!: redesign API endpoints\"\n# or\ngit commit -m \"feat: redesign API\n\nBREAKING CHANGE: All /api/v1 endpoints moved to /api/v2\"\n\n# Other types (don't trigger version bump)\ngit commit -m \"docs: update README\"\ngit commit -m \"chore: update dependencies\"\ngit commit -m \"refactor: simplify auth logic\"\ngit commit -m \"test: add unit tests\"\ngit commit -m \"style: fix linting\"\ngit commit -m \"perf: optimize queries\"\n</code></pre>"},{"location":"ci-cd-quickstart/#build-locally","title":"Build Locally","text":"<pre><code># Get current version\nVERSION=$(./scripts/version.sh current)\nGIT_SHA=$(git rev-parse --short HEAD)\nFULL_VERSION=\"${VERSION}+${GIT_SHA}\"\n\n# Build API container\ndocker build \\\n  --build-arg VERSION=$FULL_VERSION \\\n  -t state-builds-api:$VERSION \\\n  -f api_service/docker/Dockerfile \\\n  api_service/\n\n# Build Nginx container\ndocker build \\\n  --build-arg VERSION=$FULL_VERSION \\\n  -t state-builds-nginx:$VERSION \\\n  -f api_service/docker/nginx.Dockerfile \\\n  api_service/\n\n# Tag as latest\ndocker tag state-builds-api:$VERSION state-builds-api:latest\ndocker tag state-builds-nginx:$VERSION state-builds-nginx:latest\n</code></pre>"},{"location":"ci-cd-quickstart/#publishing","title":"Publishing","text":""},{"location":"ci-cd-quickstart/#automatic-publishing","title":"Automatic Publishing","text":"<p>Push to branches triggers automatic builds: - <code>develop</code> \u2192 builds and tags with <code>develop</code> - <code>main</code> \u2192 builds and tags with <code>latest</code> - <code>v*</code> tags \u2192 builds and tags with version number</p>"},{"location":"ci-cd-quickstart/#manual-publishing","title":"Manual Publishing","text":"<pre><code># Trigger manual build via GitHub Actions UI\n# Go to Actions \u2192 Build and Publish \u2192 Run workflow\n# Enter version (optional)\n\n# Or via CLI\ngh workflow run build-and-publish.yml -f version=2.1.0\n</code></pre>"},{"location":"ci-cd-quickstart/#checking-image-versions","title":"Checking Image Versions","text":"<pre><code># Check version label\ndocker inspect ghcr.io/&lt;owner&gt;/state-builds-api:latest | jq '.[0].Config.Labels'\n\n# Check version in running container\ndocker run --rm ghcr.io/&lt;owner&gt;/state-builds-api:latest \\\n  python -c \"from app.core.config import settings; print(settings.VERSION)\"\n</code></pre>"},{"location":"ci-cd-quickstart/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ci-cd-quickstart/#workflow-not-triggering","title":"Workflow Not Triggering","text":"<pre><code># Check workflow status\ngh workflow list\n\n# Check if workflow is enabled\ngh workflow enable build-and-publish.yml\n\n# Check recent runs\ngh run list --workflow=build-and-publish.yml\n</code></pre>"},{"location":"ci-cd-quickstart/#build-failing","title":"Build Failing","text":"<pre><code># View logs\n./scripts/gh-actions-status.sh logs &lt;run-id&gt;\n\n# Or\ngh run view &lt;run-id&gt; --log\n\n# Rerun failed jobs\ngh run rerun &lt;run-id&gt;\n</code></pre>"},{"location":"ci-cd-quickstart/#cant-pull-images","title":"Can't Pull Images","text":"<pre><code># Check if logged in\ndocker info | grep Username\n\n# Login again\necho $GITHUB_TOKEN | docker login ghcr.io -u &lt;username&gt; --password-stdin\n\n# Make package public (if needed)\n# Go to: https://github.com/users/&lt;owner&gt;/packages/container/&lt;package&gt;/settings\n</code></pre>"},{"location":"ci-cd-quickstart/#version-out-of-sync","title":"Version Out of Sync","text":"<pre><code># Check versions\ncat VERSION\ngit describe --tags --abbrev=0\ncd bldst_cli &amp;&amp; grep \"^version\" pyproject.toml\n\n# Sync to git tag\ngit describe --tags --abbrev=0 | sed 's/^v//' &gt; VERSION\n\n# Sync CLI version\n./scripts/version.sh current\ncd bldst_cli\nsed -i \"s/^version = .*/version = \\\"$(cat ../VERSION)\\\"/\" pyproject.toml\n</code></pre>"},{"location":"ci-cd-quickstart/#resources","title":"Resources","text":"<ul> <li>Full documentation: CI-CD-PIPELINE.md</li> <li>Version script: <code>scripts/version.sh</code></li> <li>Actions status script: <code>scripts/gh-actions-status.sh</code></li> <li>GitHub Actions: <code>.github/workflows/</code></li> </ul>"},{"location":"database-architecture/","title":"Database Architecture","text":"<p>This document outlines the database schema for the State-Based Build Framework.</p>"},{"location":"database-architecture/#overview","title":"Overview","text":"<p>The database consists of 17 tables organized into the following logical groups: - Platform Configuration: platforms, os_versions, image_types - Project Management: projects - Build Tracking: builds, build_states, build_failures - Authentication &amp; Authorization: users, user_profiles, api_tokens - State Configuration: state_codes - Resumable Builds: build_artifacts, build_variables, resumable_states, resume_requests, build_jobs</p> <p>All artifacts are tracked with SHA256 checksums for integrity verification, supporting distributed build systems where multiple build servers access shared artifacts from cloud storage (S3, Azure Blob, GCP Storage, NFS, etc.).</p>"},{"location":"database-architecture/#tables","title":"Tables","text":""},{"location":"database-architecture/#platform-configuration-tables","title":"Platform Configuration Tables","text":""},{"location":"database-architecture/#platforms","title":"<code>platforms</code>","text":"<p>Stores information about cloud platforms.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>name</code> TEXT NOT NULL, UNIQUE e.g., 'aws-commercial' <code>display_name</code> TEXT NOT NULL e.g., 'AWS Commercial' <code>cloud_provider</code> TEXT NOT NULL 'azure', 'aws', 'gcp', etc. <code>region</code> TEXT NULL Optional region <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp"},{"location":"database-architecture/#os_versions","title":"<code>os_versions</code>","text":"<p>Stores information about operating system versions.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>name</code> TEXT NOT NULL, UNIQUE e.g., 'rhel-8.8' <code>display_name</code> TEXT NOT NULL e.g., 'RHEL 8.8' <code>os_family</code> TEXT NOT NULL 'rhel', 'sles', 'ubuntu' <code>major_version</code> INTEGER NOT NULL <code>minor_version</code> INTEGER NULL <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp"},{"location":"database-architecture/#image_types","title":"<code>image_types</code>","text":"<p>Stores information about image types.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>name</code> TEXT NOT NULL, UNIQUE e.g., 'base', 'hana' <code>display_name</code> TEXT NOT NULL e.g., 'Base', 'HANA' <code>description</code> TEXT NULL <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp"},{"location":"database-architecture/#projects","title":"<code>projects</code>","text":"<p>Stores project information and their relationships.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>name</code> TEXT NOT NULL, UNIQUE <code>description</code> TEXT NULL <code>parent_project_id</code> TEXT NULL, FOREIGN KEY Self-referencing to <code>projects.id</code> <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp"},{"location":"database-architecture/#builds","title":"<code>builds</code>","text":"<p>Main table for build records.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>build_number</code> TEXT NOT NULL, UNIQUE <code>project_id</code> TEXT NULL, FOREIGN KEY References <code>projects.id</code> <code>platform_id</code> TEXT NOT NULL, FOREIGN KEY References <code>platforms.id</code> <code>os_version_id</code> TEXT NOT NULL, FOREIGN KEY References <code>os_versions.id</code> <code>image_type_id</code> TEXT NOT NULL, FOREIGN KEY References <code>image_types.id</code> <code>current_state</code> INTEGER NOT NULL 0-100 <code>status</code> TEXT NOT NULL 'pending', 'running', etc. <code>start_time</code> TIMESTAMPTZ NULL ISO UTC timestamp <code>end_time</code> TIMESTAMPTZ NULL ISO UTC timestamp <code>duration_seconds</code> INTEGER NULL <code>packer_manifest</code> JSONB NULL JSON manifest from Packer <code>created_by</code> TEXT NULL <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp"},{"location":"database-architecture/#build_states","title":"<code>build_states</code>","text":"<p>History of state transitions for each build. Includes artifact storage tracking for quick reference.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>state</code> INTEGER NOT NULL 0-100 <code>status</code> TEXT NOT NULL 'started', 'completed', etc. <code>start_time</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>end_time</code> TIMESTAMPTZ NULL ISO UTC timestamp <code>duration_seconds</code> INTEGER NULL <code>error_message</code> TEXT NULL <code>retry_count</code> INTEGER NULL <code>artifact_storage_type</code> VARCHAR(50) NULL, INDEXED Type: s3, nfs, ebs, ceph, local, etc. <code>artifact_storage_path</code> TEXT NULL Full path/URI to stored artifact <code>artifact_size_bytes</code> BIGINT NULL Size of artifact in bytes <code>artifact_checksum</code> VARCHAR(128) NULL SHA256 or MD5 checksum <code>artifact_metadata</code> JSONB NULL Additional artifact metadata <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>builds</code></p> <p>Note: The <code>artifact_storage_*</code> fields provide quick artifact reference. For full artifact lifecycle management, use the <code>build_artifacts</code> table.</p>"},{"location":"database-architecture/#build_failures","title":"<code>build_failures</code>","text":"<p>Detailed failure tracking for builds.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>state</code> INTEGER NOT NULL <code>failure_type</code> TEXT NOT NULL <code>error_message</code> TEXT NOT NULL <code>error_details</code> JSONB NULL <code>component</code> TEXT NULL <code>retry_attempt</code> INTEGER NULL <code>resolved</code> BOOLEAN NULL <code>resolution_notes</code> TEXT NULL <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>resolved_at</code> TIMESTAMPTZ NULL"},{"location":"database-architecture/#authentication-authorization-tables","title":"Authentication &amp; Authorization Tables","text":""},{"location":"database-architecture/#users","title":"<code>users</code>","text":"<p>Stores user accounts for authentication and authorization.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>username</code> TEXT NOT NULL, UNIQUE, INDEXED Unique username <code>email</code> TEXT NOT NULL, UNIQUE, INDEXED User email address <code>first_name</code> TEXT NULL User's first name <code>last_name</code> TEXT NULL User's last name <code>employee_id</code> TEXT NULL Organization employee ID <code>hashed_password</code> TEXT NOT NULL Bcrypt hashed password <code>is_active</code> BOOLEAN DEFAULT TRUE Account active status <code>is_superuser</code> BOOLEAN DEFAULT FALSE Superuser privileges <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NULL ISO UTC timestamp <code>deactivated_at</code> TIMESTAMPTZ NULL When account was deactivated <p>Relationships: - One-to-many with <code>user_profiles</code> - One-to-many with <code>api_tokens</code></p>"},{"location":"database-architecture/#user_profiles","title":"<code>user_profiles</code>","text":"<p>Extended user profile information from IDM systems.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>user_id</code> TEXT NOT NULL, FOREIGN KEY References <code>users.id</code> <code>first_name</code> TEXT NOT NULL Profile first name <code>last_name</code> TEXT NOT NULL Profile last name <code>employee_id</code> TEXT NOT NULL Employee identifier <code>email</code> TEXT NOT NULL Profile email <code>start_date</code> TIMESTAMPTZ NOT NULL Employment start date <code>end_date</code> TIMESTAMPTZ NULL Employment end date <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>users</code></p>"},{"location":"database-architecture/#api_tokens","title":"<code>api_tokens</code>","text":"<p>API authentication tokens for programmatic access.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>user_id</code> TEXT NOT NULL, FOREIGN KEY References <code>users.id</code> <code>name</code> TEXT NOT NULL Token description/name <code>token_hash</code> TEXT NOT NULL Hashed API token <code>scopes</code> JSON NULL Token permissions/scopes <code>expires_at</code> TIMESTAMPTZ NULL Expiration timestamp <code>is_active</code> BOOLEAN DEFAULT TRUE Token active status <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>deactivated_at</code> TIMESTAMPTZ NULL When token was deactivated <p>Relationships: - Many-to-one with <code>users</code></p>"},{"location":"database-architecture/#state-configuration-tables","title":"State Configuration Tables","text":""},{"location":"database-architecture/#state_codes","title":"<code>state_codes</code>","text":"<p>Defines valid state codes for projects with metadata.</p> Column Data Type Constraints Description <code>id</code> UUID PRIMARY KEY UUID <code>project_id</code> UUID NOT NULL, FOREIGN KEY References <code>projects.id</code> <code>name</code> TEXT NOT NULL State name (e.g., '10_CREATE_VM') <code>description</code> TEXT NULL Human-readable description <code>is_initial</code> BOOLEAN DEFAULT FALSE Is this an initial state? <code>is_final</code> BOOLEAN DEFAULT FALSE Is this a final/terminal state? <code>is_error</code> BOOLEAN DEFAULT FALSE Is this an error state? <code>start_date</code> TIMESTAMPTZ NOT NULL When this state became valid <code>end_date</code> TIMESTAMPTZ NULL When this state was deprecated <p>Relationships: - Many-to-one with <code>projects</code></p>"},{"location":"database-architecture/#resumable-builds-tables","title":"Resumable Builds Tables","text":""},{"location":"database-architecture/#build_artifacts","title":"<code>build_artifacts</code>","text":"<p>Tracks artifacts created during builds for resumption and delivery.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>state_code</code> INTEGER NOT NULL, INDEXED State that created artifact <code>artifact_name</code> TEXT NOT NULL Artifact identifier <code>artifact_type</code> TEXT NOT NULL, INDEXED 'vm_snapshot', 'ami', 'disk_image', etc. <code>artifact_path</code> TEXT NOT NULL Full path/URL to artifact <code>storage_backend</code> TEXT NOT NULL 's3', 'azure_blob', 'gcp_storage', 'local' <code>storage_region</code> TEXT NULL Storage region <code>storage_bucket</code> TEXT NULL Bucket/container name <code>storage_key</code> TEXT NULL Key/path within bucket <code>size_bytes</code> BIGINT NULL Artifact size in bytes <code>checksum</code> TEXT NULL SHA256 checksum <code>checksum_algorithm</code> TEXT DEFAULT 'sha256' Checksum algorithm <code>is_resumable</code> BOOLEAN DEFAULT TRUE, INDEXED Can be used for resume? <code>is_final</code> BOOLEAN DEFAULT FALSE Is final deliverable? <code>expires_at</code> TIMESTAMPTZ NULL, INDEXED Cleanup time for temp artifacts <code>metadata</code> JSONB NULL VM ID, snapshot ID, AMI ID, etc. <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>deleted_at</code> TIMESTAMPTZ NULL, INDEXED Soft delete timestamp <p>Relationships: - Many-to-one with <code>builds</code></p> <p>Constraints: - Unique constraint on <code>(build_id, artifact_name)</code></p>"},{"location":"database-architecture/#build_variables","title":"<code>build_variables</code>","text":"<p>Stores build-specific variables needed for resumption (VM IDs, network config, etc.).</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>variable_key</code> TEXT NOT NULL Variable name <code>variable_value</code> TEXT NOT NULL Variable value <code>variable_type</code> TEXT DEFAULT 'string' 'string', 'json', 'encrypted' <code>set_at_state</code> INTEGER NULL Which state set this variable <code>is_sensitive</code> BOOLEAN DEFAULT FALSE Should be encrypted/masked? <code>is_required_for_resume</code> BOOLEAN DEFAULT FALSE, INDEXED Required for resumption? <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>builds</code></p> <p>Constraints: - Unique constraint on <code>(build_id, variable_key)</code></p>"},{"location":"database-architecture/#resumable_states","title":"<code>resumable_states</code>","text":"<p>Defines which state codes are resumable and their requirements.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>project_id</code> TEXT NOT NULL, FOREIGN KEY References <code>projects.id</code> <code>state_code</code> INTEGER NOT NULL State code number <code>is_resumable</code> BOOLEAN DEFAULT TRUE, INDEXED Can resume from this state? <code>resume_strategy</code> TEXT NULL 'from_artifact', 'rerun_state', 'skip_to_next' <code>required_artifacts</code> JSONB NULL Array of required artifact types <code>required_variables</code> JSONB NULL Array of required variable keys <code>resume_command</code> TEXT NULL Command/script for resumption <code>resume_timeout_seconds</code> INTEGER DEFAULT 3600 Timeout for resume operation <code>description</code> TEXT NULL Human-readable description <code>notes</code> TEXT NULL Additional notes <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>projects</code></p> <p>Constraints: - Unique constraint on <code>(project_id, state_code)</code></p>"},{"location":"database-architecture/#resume_requests","title":"<code>resume_requests</code>","text":"<p>Tracks requests to resume builds and their status.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>resume_from_state</code> INTEGER NOT NULL State to resume from <code>resume_to_state</code> INTEGER NULL Target state (NULL = completion) <code>resume_reason</code> TEXT NULL Reason for resume request <code>requested_by</code> TEXT NULL User/system that requested <code>request_source</code> TEXT NULL 'api', 'webhook', 'cli', 'auto' <code>orchestration_job_id</code> TEXT NULL CI/CD job ID <code>orchestration_job_url</code> TEXT NULL CI/CD job URL <code>orchestration_status</code> TEXT NULL, INDEXED 'pending', 'triggered', 'running', 'completed', 'failed' <code>triggered_at</code> TIMESTAMPTZ NULL When job was triggered <code>completed_at</code> TIMESTAMPTZ NULL When job completed <code>error_message</code> TEXT NULL Error details if failed <code>metadata</code> JSONB NULL Additional metadata <code>created_at</code> TIMESTAMPTZ NOT NULL, INDEXED ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>builds</code></p>"},{"location":"database-architecture/#build_jobs","title":"<code>build_jobs</code>","text":"<p>Links builds to CI/CD job information for tracking and coordination.</p> Column Data Type Constraints Description <code>id</code> TEXT PRIMARY KEY UUID <code>build_id</code> TEXT NOT NULL, FOREIGN KEY References <code>builds.id</code> <code>platform</code> TEXT NOT NULL, INDEXED 'concourse', 'jenkins', 'github-actions' <code>pipeline_name</code> TEXT NULL Pipeline name <code>job_name</code> TEXT NOT NULL Job name <code>job_url</code> TEXT NULL URL to job in CI/CD system <code>job_id</code> TEXT NULL, INDEXED Platform-specific job ID <code>build_number</code> TEXT NULL Build number in CI/CD <code>triggered_by</code> TEXT NULL Who triggered the job <code>trigger_source</code> TEXT NULL 'manual', 'webhook', 'schedule', 'resume' <code>status</code> TEXT NULL, INDEXED 'pending', 'running', 'success', 'failed', 'aborted' <code>started_at</code> TIMESTAMPTZ NULL Job start time <code>completed_at</code> TIMESTAMPTZ NULL Job completion time <code>is_resume_job</code> BOOLEAN DEFAULT FALSE, INDEXED Is this a resume job? <code>resumed_from_state</code> INTEGER NULL State resumed from <code>parent_job_id</code> TEXT NULL, FOREIGN KEY References <code>build_jobs.id</code> (self-reference) <code>created_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <code>updated_at</code> TIMESTAMPTZ NOT NULL ISO UTC timestamp <p>Relationships: - Many-to-one with <code>builds</code> - Self-referencing for parent-child job relationships</p>"},{"location":"database-architecture/#indexes","title":"Indexes","text":""},{"location":"database-architecture/#core-build-tables","title":"Core Build Tables","text":"<ul> <li><code>idx_builds_project_id</code>: on <code>builds(project_id)</code></li> <li><code>idx_builds_platform_id</code>: on <code>builds(platform_id)</code></li> <li><code>idx_builds_os_version_id</code>: on <code>builds(os_version_id)</code></li> <li><code>idx_builds_image_type_id</code>: on <code>builds(image_type_id)</code></li> <li><code>idx_builds_status</code>: on <code>builds(status)</code></li> <li><code>idx_build_states_build_id</code>: on <code>build_states(build_id)</code></li> <li><code>idx_build_states_artifact_storage_type</code>: on <code>build_states(artifact_storage_type)</code></li> <li><code>idx_build_states_build_id_state</code>: on <code>build_states(build_id, state)</code></li> <li><code>idx_build_failures_build_id</code>: on <code>build_failures(build_id)</code></li> <li><code>idx_projects_parent_project_id</code>: on <code>projects(parent_project_id)</code></li> </ul>"},{"location":"database-architecture/#authentication-tables","title":"Authentication Tables","text":"<ul> <li><code>idx_users_username</code>: on <code>users(username)</code> - Unique index</li> <li><code>idx_users_email</code>: on <code>users(email)</code> - Unique index</li> <li><code>idx_users_active</code>: on <code>users(is_active)</code> WHERE <code>is_active = TRUE</code></li> <li><code>idx_user_profiles_user_id</code>: on <code>user_profiles(user_id)</code></li> <li><code>idx_user_profiles_employee_id</code>: on <code>user_profiles(employee_id)</code></li> <li><code>idx_api_tokens_user_id</code>: on <code>api_tokens(user_id)</code></li> <li><code>idx_api_tokens_active</code>: on <code>api_tokens(is_active)</code> WHERE <code>is_active = TRUE</code></li> </ul>"},{"location":"database-architecture/#build-artifacts-tables","title":"Build Artifacts Tables","text":"<ul> <li><code>idx_build_artifacts_build_id</code>: on <code>build_artifacts(build_id)</code></li> <li><code>idx_build_artifacts_state_code</code>: on <code>build_artifacts(state_code)</code></li> <li><code>idx_build_artifacts_type</code>: on <code>build_artifacts(artifact_type)</code></li> <li><code>idx_build_artifacts_resumable</code>: on <code>build_artifacts(is_resumable)</code> WHERE <code>is_resumable = TRUE</code></li> <li><code>idx_build_artifacts_expires</code>: on <code>build_artifacts(expires_at)</code> WHERE <code>expires_at IS NOT NULL</code></li> <li><code>idx_build_artifacts_deleted</code>: on <code>build_artifacts(deleted_at)</code> WHERE <code>deleted_at IS NULL</code></li> </ul>"},{"location":"database-architecture/#build-variables-tables","title":"Build Variables Tables","text":"<ul> <li><code>idx_build_variables_build_id</code>: on <code>build_variables(build_id)</code></li> <li><code>idx_build_variables_required</code>: on <code>build_variables(is_required_for_resume)</code> WHERE <code>is_required_for_resume = TRUE</code></li> </ul>"},{"location":"database-architecture/#resumable-states-tables","title":"Resumable States Tables","text":"<ul> <li><code>idx_resumable_states_project</code>: on <code>resumable_states(project_id)</code> (when project_id FK exists)</li> <li><code>idx_resumable_states_resumable</code>: on <code>resumable_states(is_resumable)</code> WHERE <code>is_resumable = TRUE</code></li> </ul>"},{"location":"database-architecture/#resume-requests-tables","title":"Resume Requests Tables","text":"<ul> <li><code>idx_resume_requests_build_id</code>: on <code>resume_requests(build_id)</code></li> <li><code>idx_resume_requests_status</code>: on <code>resume_requests(orchestration_status)</code></li> <li><code>idx_resume_requests_created</code>: on <code>resume_requests(created_at DESC)</code></li> </ul>"},{"location":"database-architecture/#build-jobs-tables","title":"Build Jobs Tables","text":"<ul> <li><code>idx_build_jobs_build_id</code>: on <code>build_jobs(build_id)</code></li> <li><code>idx_build_jobs_platform_job</code>: on <code>build_jobs(platform, job_id)</code></li> <li><code>idx_build_jobs_status</code>: on <code>build_jobs(status)</code></li> <li><code>idx_build_jobs_is_resume</code>: on <code>build_jobs(is_resume_job)</code> WHERE <code>is_resume_job = TRUE</code></li> </ul>"},{"location":"database-architecture/#database-views","title":"Database Views","text":""},{"location":"database-architecture/#build_resume_status","title":"<code>build_resume_status</code>","text":"<p>Aggregated view showing builds with their resume capability.</p> <p>Columns: - <code>build_id</code>: Build UUID - <code>build_number</code>: Build number - <code>status</code>: Build status - <code>platform_id</code>: Platform UUID - <code>project_id</code>: Project UUID - <code>artifact_count</code>: Total artifact count - <code>resumable_artifact_count</code>: Count of resumable artifacts - <code>variable_count</code>: Total variable count - <code>required_variable_count</code>: Count of required variables - <code>resume_request_count</code>: Number of resume requests - <code>current_state_code</code>: Latest state code - <code>last_state_change</code>: Timestamp of last state change</p>"},{"location":"database-architecture/#latest_resume_requests","title":"<code>latest_resume_requests</code>","text":"<p>Shows the most recent resume request for each build.</p> <p>Columns: All columns from <code>resume_requests</code> table</p>"},{"location":"database-architecture/#database-functions","title":"Database Functions","text":""},{"location":"database-architecture/#get_resume_contextp_build_id-text","title":"<code>get_resume_context(p_build_id TEXT)</code>","text":"<p>Returns comprehensive resume context for a build as JSON.</p> <p>Returns: <pre><code>{\n  \"build\": {...},  // Full build record\n  \"artifacts\": [...],  // Array of resumable artifacts\n  \"variables\": {...},  // Key-value pairs of variables\n  \"last_state\": 45  // Last completed state code\n}\n</code></pre></p> <p>Usage: <pre><code>SELECT get_resume_context('build-uuid-here');\n</code></pre></p>"},{"location":"database-architecture/#database-triggers","title":"Database Triggers","text":""},{"location":"database-architecture/#update_updated_at_column","title":"<code>update_updated_at_column()</code>","text":"<p>Automatically updates the <code>updated_at</code> timestamp on row updates.</p> <p>Applied to: - <code>build_artifacts</code> - <code>build_variables</code> - <code>resumable_states</code> - <code>resume_requests</code> - <code>build_jobs</code></p>"},{"location":"database-architecture/#erd","title":"ERD","text":"<pre><code>erDiagram\n    %% Platform Configuration\n    PLATFORMS {\n        UUID id PK\n        TEXT name\n        TEXT cloud_provider\n        TEXT region\n    }\n\n    OS_VERSIONS {\n        UUID id PK\n        TEXT name\n        TEXT os_family\n        INTEGER major_version\n    }\n\n    IMAGE_TYPES {\n        UUID id PK\n        TEXT name\n        TEXT display_name\n    }\n\n    %% Project Management\n    PROJECTS {\n        UUID id PK\n        TEXT name\n        TEXT description\n        TEXT parent_project_id FK\n    }\n\n    %% Build Core\n    BUILDS {\n        UUID id PK\n        TEXT build_number\n        TEXT project_id FK\n        TEXT platform_id FK\n        TEXT os_version_id FK\n        TEXT image_type_id FK\n        INTEGER current_state\n        TEXT status\n        TIMESTAMPTZ start_time\n        TIMESTAMPTZ end_time\n    }\n\n    BUILD_STATES {\n        UUID id PK\n        UUID build_id FK\n        INTEGER state\n        TEXT status\n        TIMESTAMPTZ start_time\n        TIMESTAMPTZ end_time\n        VARCHAR artifact_storage_type\n        TEXT artifact_storage_path\n        BIGINT artifact_size_bytes\n        VARCHAR artifact_checksum\n        JSONB artifact_metadata\n    }\n\n    BUILD_FAILURES {\n        UUID id PK\n        UUID build_id FK\n        INTEGER state\n        TEXT failure_type\n        JSONB error_details\n    }\n\n    %% Authentication\n    USERS {\n        TEXT id PK\n        TEXT username UK\n        TEXT email UK\n        TEXT hashed_password\n        BOOLEAN is_active\n        BOOLEAN is_superuser\n    }\n\n    USER_PROFILES {\n        TEXT id PK\n        TEXT user_id FK\n        TEXT first_name\n        TEXT last_name\n        TEXT employee_id\n        TIMESTAMPTZ start_date\n    }\n\n    API_TOKENS {\n        TEXT id PK\n        TEXT user_id FK\n        TEXT name\n        TEXT token_hash\n        JSON scopes\n        TIMESTAMPTZ expires_at\n    }\n\n    %% State Configuration\n    STATE_CODES {\n        UUID id PK\n        UUID project_id FK\n        TEXT name\n        TEXT description\n        BOOLEAN is_initial\n        BOOLEAN is_final\n        BOOLEAN is_error\n    }\n\n    %% Resumable Builds\n    BUILD_ARTIFACTS {\n        TEXT id PK\n        TEXT build_id FK\n        INTEGER state_code\n        TEXT artifact_name\n        TEXT artifact_type\n        TEXT artifact_path\n        TEXT storage_backend\n        TEXT storage_region\n        TEXT storage_bucket\n        TEXT storage_key\n        BIGINT size_bytes\n        TEXT checksum\n        TEXT checksum_algorithm\n        BOOLEAN is_resumable\n        BOOLEAN is_final\n        TIMESTAMPTZ expires_at\n        JSONB metadata\n        TIMESTAMPTZ created_at\n        TIMESTAMPTZ deleted_at\n    }\n\n    BUILD_VARIABLES {\n        TEXT id PK\n        TEXT build_id FK\n        TEXT variable_key\n        TEXT variable_value\n        TEXT variable_type\n        INTEGER set_at_state\n        BOOLEAN is_required_for_resume\n    }\n\n    RESUMABLE_STATES {\n        TEXT id PK\n        TEXT project_id FK\n        INTEGER state_code\n        BOOLEAN is_resumable\n        TEXT resume_strategy\n        JSONB required_artifacts\n        JSONB required_variables\n    }\n\n    RESUME_REQUESTS {\n        TEXT id PK\n        TEXT build_id FK\n        INTEGER resume_from_state\n        INTEGER resume_to_state\n        TEXT requested_by\n        TEXT orchestration_status\n        TIMESTAMPTZ triggered_at\n    }\n\n    BUILD_JOBS {\n        TEXT id PK\n        TEXT build_id FK\n        TEXT platform\n        TEXT job_name\n        TEXT job_id\n        TEXT status\n        BOOLEAN is_resume_job\n        TEXT parent_job_id FK\n    }\n\n    %% Core Relationships\n    PROJECTS }|--|| PROJECTS : \"is parent of\"\n    PROJECTS ||--|{ BUILDS : \"has\"\n    PROJECTS ||--|{ STATE_CODES : \"defines states\"\n    PROJECTS ||--|{ RESUMABLE_STATES : \"has resumable states\"\n\n    PLATFORMS ||--|{ BUILDS : \"runs on\"\n    OS_VERSIONS ||--|{ BUILDS : \"uses\"\n    IMAGE_TYPES ||--|{ BUILDS : \"is of type\"\n\n    BUILDS ||--|{ BUILD_STATES : \"has history\"\n    BUILDS ||--|{ BUILD_FAILURES : \"has failures\"\n\n    %% Authentication Relationships\n    USERS ||--|{ USER_PROFILES : \"has profiles\"\n    USERS ||--|{ API_TOKENS : \"has tokens\"\n\n    %% Resumable Builds Relationships\n    BUILDS ||--|{ BUILD_ARTIFACTS : \"produces\"\n    BUILDS ||--|{ BUILD_VARIABLES : \"stores variables\"\n    BUILDS ||--|{ RESUME_REQUESTS : \"can be resumed\"\n    BUILDS ||--|{ BUILD_JOBS : \"tracked by\"\n\n    BUILD_JOBS }|--|| BUILD_JOBS : \"parent of\"</code></pre>"},{"location":"database-architecture/#schema-evolution","title":"Schema Evolution","text":"<p>This schema has evolved through the following major additions:</p> <ol> <li>Initial Schema (v1.0): Core build tracking with platforms, OS versions, image types, projects, builds, build states, and build failures</li> <li>Authentication System (v1.1): Added users, user_profiles, and api_tokens for authentication and authorization</li> <li>State Configuration (v1.2): Added state_codes table for project-specific state definitions</li> <li>Resumable Builds (v2.0): Added build_artifacts, build_variables, resumable_states, resume_requests, and build_jobs for comprehensive build resumption support</li> </ol>"},{"location":"database-architecture/#key-design-decisions","title":"Key Design Decisions","text":""},{"location":"database-architecture/#uuid-vs-integer-ids","title":"UUID vs. Integer IDs","text":"<ul> <li>Most tables use UUID/TEXT for <code>id</code> fields to support distributed systems and avoid ID collisions</li> <li>State codes use INTEGER for sequential ordering and human-friendly references</li> </ul>"},{"location":"database-architecture/#artifact-integrity-checksums","title":"Artifact Integrity &amp; Checksums","text":"<ul> <li>All artifacts tracked with SHA256 checksums (default algorithm)</li> <li><code>checksum</code> field stores the hash value for verification</li> <li><code>checksum_algorithm</code> field allows flexibility (sha256, md5, etc.)</li> <li>Enables integrity verification when downloading artifacts from storage</li> <li>Critical for distributed build systems where artifacts move between servers</li> </ul>"},{"location":"database-architecture/#soft-deletes","title":"Soft Deletes","text":"<ul> <li><code>build_artifacts</code> uses soft deletes (<code>deleted_at</code>) for audit trails</li> <li>Users have <code>deactivated_at</code> instead of hard deletes</li> <li>Preserves history while marking records as inactive</li> </ul>"},{"location":"database-architecture/#indexing-strategy","title":"Indexing Strategy","text":"<ul> <li>Partial indexes on boolean fields (e.g., <code>WHERE is_resumable = TRUE</code>) to optimize common queries</li> <li>Composite indexes on frequently joined columns (e.g., <code>platform, job_id</code>)</li> <li>Descending index on <code>created_at</code> for recent-first queries</li> <li>Artifact storage type indexed for quick lookups by storage backend</li> </ul>"},{"location":"database-architecture/#jsonjsonb-usage","title":"JSON/JSONB Usage","text":"<ul> <li>Flexible metadata storage in <code>metadata</code> columns</li> <li>Configuration arrays in <code>required_artifacts</code> and <code>required_variables</code></li> <li>Token scopes stored as JSON for extensibility</li> <li>Artifact metadata stores VM IDs, snapshot IDs, AMI IDs, and custom data</li> </ul>"},{"location":"database-architecture/#timestamp-strategy","title":"Timestamp Strategy","text":"<ul> <li>All timestamps use <code>TIMESTAMPTZ</code> (timestamp with time zone) for global consistency</li> <li><code>server_default=func.now()</code> ensures database-level timestamp accuracy</li> <li>Separate <code>created_at</code> and <code>updated_at</code> fields with trigger-based updates</li> </ul>"},{"location":"database-architecture/#dual-artifact-tracking","title":"Dual Artifact Tracking","text":"<ul> <li>build_states table: Quick artifact reference for state transitions</li> <li>build_artifacts table: Full lifecycle management with resumability support</li> <li>Provides both performance (quick lookups) and flexibility (comprehensive tracking)</li> </ul>"},{"location":"problem-statement/","title":"Problem Statement: State-Based Build Management","text":""},{"location":"problem-statement/#the-problem","title":"The Problem","text":"<p>Organizations building infrastructure-as-a-service (IaaS) images face several critical challenges:</p>"},{"location":"problem-statement/#1-build-fragility-and-non-resumability","title":"1. Build Fragility and Non-Resumability","text":"<ul> <li>Multi-cloud image builds can take 30-90 minutes or more</li> <li>A failure at minute 75 means starting completely over from minute 0</li> <li>Network timeouts, package installation failures, or cloud API issues waste hours of compute time</li> <li>No visibility into where a build actually failed in complex multi-step processes</li> </ul>"},{"location":"problem-statement/#2-lack-of-cross-platform-visibility","title":"2. Lack of Cross-Platform Visibility","text":"<ul> <li>Different cloud providers (AWS, Azure, GCP, private clouds) use different tools and processes</li> <li>No unified way to track build progress across heterogeneous environments</li> <li>Pipeline teams struggle to answer \"where did this build fail?\" across different platforms</li> <li>Build state is often locked in proprietary systems or buried in logs</li> </ul>"},{"location":"problem-statement/#3-communication-breakdown","title":"3. Communication Breakdown","text":"<ul> <li>Build pipelines can't communicate their state to external systems</li> <li>Dashboards show \"running\" or \"failed\" but not specific progress</li> <li>Downstream systems don't know when artifacts are ready for consumption</li> <li>Manual checking required to determine build status and readiness</li> </ul>"},{"location":"problem-statement/#4-distributed-build-coordination","title":"4. Distributed Build Coordination","text":"<ul> <li>Multiple build servers in a pool can't share work effectively</li> <li>Artifacts from one build stage can't be reliably accessed by another server</li> <li>No standardized way to track where intermediate artifacts are stored</li> <li>Build resumption requires manual intervention and knowledge transfer</li> </ul>"},{"location":"problem-statement/#5-scalability-and-maintenance","title":"5. Scalability and Maintenance","text":"<ul> <li>Adding new build steps requires renumbering all subsequent steps</li> <li>Can't insert steps without breaking existing pipelines</li> <li>No clear milestone structure for complex builds</li> <li>Hard to maintain consistency across multiple image types and variants</li> </ul>"},{"location":"problem-statement/#the-solution-state-based-build-management-framework","title":"The Solution: State-Based Build Management Framework","text":"<p>This framework introduces a standardized state code system (0-100) with centralized state tracking and artifact management to solve these challenges.</p>"},{"location":"problem-statement/#core-components","title":"Core Components","text":""},{"location":"problem-statement/#1-state-code-system-0-100","title":"1. State Code System (0-100)","text":"<ul> <li>Numerical milestones representing build progress</li> <li>Increments of 5 allow insertion of new states without renumbering</li> <li>Universal across cloud providers - state 25 means the same thing everywhere</li> <li>Clear completion percentage - state 50 = 50% complete</li> </ul> <p>Example State Codes: - 0: Initial state - nothing started - 10: Base OS image created (bootable) - 25: Security baseline applied - 50: Application runtimes installed - 75: Testing and validation complete - 100: Image published and delivered</p>"},{"location":"problem-statement/#2-fastapi-state-management-service","title":"2. FastAPI State Management Service","text":"<ul> <li>Centralized state tracking for all builds across all platforms</li> <li>RESTful API accessible from any build environment</li> <li>PostgreSQL backend for reliable state persistence</li> <li>Real-time dashboards showing build progress across the organization</li> <li>Historical tracking for trend analysis and optimization</li> </ul>"},{"location":"problem-statement/#3-artifact-storage-tracking","title":"3. Artifact Storage Tracking","text":"<ul> <li>Record artifact locations when build states complete</li> <li>Support for multiple storage backends (S3, NFS, EBS, Ceph, etc.)</li> <li>Distributed build server coordination - any server can resume from any state</li> <li>Checksum verification ensures artifact integrity</li> <li>Metadata tracking for artifact details (size, format, compression)</li> </ul>"},{"location":"problem-statement/#4-command-line-interface-cli","title":"4. Command-Line Interface (CLI)","text":"<ul> <li>Easy integration with existing CI/CD pipelines</li> <li>Simple state updates from shell scripts and Ansible playbooks</li> <li>Build lifecycle management (create, update, query, resume)</li> <li>Authentication handling with API keys and tokens</li> </ul>"},{"location":"problem-statement/#how-it-solves-the-problems","title":"How It Solves the Problems","text":""},{"location":"problem-statement/#resumable-builds","title":"\u2705 Resumable Builds","text":"<p>Problem: Failure at minute 75 = start over from minute 0</p> <p>Solution:  - State 10 completes and artifact is stored in S3 - State 25 completes and artifact is stored in S3 - State 50 fails - Resume from state 50 using the artifact from state 25 - Only retry the failed portion, saving 50 minutes of work</p> <p>Example: <pre><code># Build fails at state 50\nbldst build get {build-id}\n# Shows: current_state=50, status=failed\n\n# Retry just state 50\n# Downloads artifact from state 25 automatically\n# Resumes work without repeating states 0-25\n</code></pre></p>"},{"location":"problem-statement/#universal-progress-tracking","title":"\u2705 Universal Progress Tracking","text":"<p>Problem: No visibility into build progress across platforms</p> <p>Solution: - All platforms report to the same API using standard state codes - Dashboard shows all builds, all platforms, in real-time - State 35 means \"runtime prerequisites installed\" everywhere - Consistent progress reporting across AWS, Azure, GCP, and private clouds</p> <p>Example: <pre><code># From anywhere\nbldst build list\n\n# Returns:\n# AWS Build #123:    State 45 - Storage configuration (45% complete)\n# Azure Build #124:  State 75 - Testing complete (75% complete)  \n# GCP Build #125:    State 100 - Delivered (100% complete)\n</code></pre></p>"},{"location":"problem-statement/#artifact-distribution-for-distributed-builds","title":"\u2705 Artifact Distribution for Distributed Builds","text":"<p>Problem: Build Server A creates artifact, Build Server B can't find it</p> <p>Solution: - Server A completes state 25, uploads artifact to S3, records location in state database - Server B picks up state 50, queries database for state 25 artifact, downloads from S3 - Any server in the pool can resume any build from any state</p> <p>Example: <pre><code># Server A completes state 25\nbldst build add-state {build-id} \\\n  --state 25 \\\n  --status completed \\\n  --storage-type s3 \\\n  --storage-path \"s3://builds/proj-123/build-456/state-25/image.qcow2\" \\\n  --checksum \"sha256:abc123...\"\n\n# Server B picks up state 50\n# Queries API: \"Where is the artifact from state 25?\"\n# Downloads from s3://builds/proj-123/build-456/state-25/image.qcow2\n# Verifies checksum\n# Continues build\n</code></pre></p>"},{"location":"problem-statement/#scalable-state-management","title":"\u2705 Scalable State Management","text":"<p>Problem: Adding a step between state 40 and 50 requires renumbering</p> <p>Solution: - States increment by 5 (0, 5, 10, 15, 20, 25...) - New step? Insert at 42 or 43 or 44 - Existing pipelines unaffected - No renumbering cascade</p> <p>Example: <pre><code>Original:\n  40: Network config\n  45: Storage config\n\nNeed new step for VPN setup?\n  40: Network config\n  42: VPN setup \u2190 NEW, no renumbering needed\n  45: Storage config\n</code></pre></p>"},{"location":"problem-statement/#integration-with-existing-tools","title":"\u2705 Integration with Existing Tools","text":"<p>Problem: Our tools (Packer, Ansible, Concourse) don't track state</p> <p>Solution: - Lightweight CLI integrates with existing scripts - Update state from Ansible playbooks, Packer provisioners, shell scripts - No major refactoring of existing pipelines - Gradual adoption - start with one pipeline, expand from there</p> <p>Example Integration: <pre><code>#!/bin/bash\n# Existing Packer build script\n\n# Add: Report state 5 (starting kickstart)\nbldst build add-state $BUILD_ID --state 5 --status in_progress\n\npacker build kickstart.pkr.hcl\n\n# Add: Report state 10 (kickstart complete)\nbldst build add-state $BUILD_ID --state 10 --status completed \\\n  --storage-type s3 \\\n  --storage-path \"s3://builds/$BUILD_ID/base-image.qcow2\"\n\n# Continue with Ansible...\n</code></pre></p>"},{"location":"problem-statement/#state-vs-status-a-key-distinction","title":"State vs Status: A Key Distinction","text":"<p>The framework separates state codes (progress milestones) from status (success/failure):</p> <ul> <li>State: WHERE you are in the build process (0-100)</li> <li>Status: HOW that state attempt went (pending, in_progress, completed, failed)</li> </ul> <p>Example: - Build reaches state 25 (security baseline) - Security scan fails  - State remains 25 (we attempted the milestone) - Status becomes \"failed\" (we didn't complete it) - On retry, attempt state 25 again - If successful, advance to state 30</p> <p>This approach ensures: - \u2705 Progress is never lost (you know you reached state 25) - \u2705 Failures are clearly marked for debugging - \u2705 Retry logic knows exactly where to resume - \u2705 History shows multiple attempts with failure reasons</p>"},{"location":"problem-statement/#real-world-use-cases","title":"Real-World Use Cases","text":""},{"location":"problem-statement/#use-case-1-multi-region-aws-build","title":"Use Case 1: Multi-Region AWS Build","text":"<p>Scenario: Building RHEL 8 images for 6 AWS regions</p> <p>Without Framework: - Build fails in region 4 after 60 minutes - Restart from beginning, wait another 60 minutes - May fail in region 5 this time - Repeat until all 6 succeed (could take 6+ hours)</p> <p>With Framework: - State 0-50: Base configuration (once, 30 minutes) - Upload artifact to S3 - States 60-100: Deploy to each region in parallel - Region 4 fails? Retry just region 4 from state 60 (10 minutes) - Other regions continue independently - Total time: ~40 minutes instead of 6+ hours</p>"},{"location":"problem-statement/#use-case-2-distributed-database-image-build","title":"Use Case 2: Distributed Database Image Build","text":"<p>Scenario: Complex database image requiring multiple build servers</p> <p>Without Framework: - Server A builds base OS - Manually transfer artifact to Server B - Server B builds database layer - If Server B fails, manual coordination to retry - No visibility into overall progress</p> <p>With Framework: - Server A: States 0-30 (base OS), stores artifact to NFS - API records: state 30 complete, artifact at /mnt/nfs/builds/db-123/state-30.qcow2 - Server B: Queries API, downloads state 30 artifact, runs states 35-100 - If Server B fails at state 50, Server C can pick up automatically - Dashboard shows progress across all servers in real-time</p>"},{"location":"problem-statement/#use-case-3-azure-aws-hybrid-cloud","title":"Use Case 3: Azure + AWS Hybrid Cloud","text":"<p>Scenario: Same image type needed for both Azure and AWS</p> <p>Without Framework: - Separate pipelines for each cloud - No visibility into which cloud is ahead/behind - Can't compare build times or failure rates - Manual dashboard construction</p> <p>With Framework: - States 0-40: Common base image (cloud-agnostic) - State 45: Branch to cloud-specific configuration - API tracks both builds with same state codes - Dashboard shows: \"Azure Build 75% complete, AWS Build 80% complete\" - Consistent state meanings across clouds enables comparison</p>"},{"location":"problem-statement/#benefits-summary","title":"Benefits Summary","text":"Problem Solution Impact Builds start over after failure Resume from last completed state 50-80% time savings on retry No cross-platform visibility Universal state codes + centralized tracking Single dashboard for all clouds Can't find artifacts Artifact storage tracking in state database Any server can resume any build Hard to add new steps State codes increment by 5 No renumbering, easy evolution Manual status checking CLI + API + dashboards Automated progress reporting Long build times Parallel state execution possible Faster time to delivery Debugging failures State history with error logs Faster root cause analysis"},{"location":"problem-statement/#migration-strategy","title":"Migration Strategy","text":""},{"location":"problem-statement/#phase-1-pilot-1-2-weeks","title":"Phase 1: Pilot (1-2 weeks)","text":"<ul> <li>Deploy API service and database</li> <li>Install CLI on build servers</li> <li>Instrument one simple pipeline</li> <li>Validate state tracking works</li> </ul>"},{"location":"problem-statement/#phase-2-gradual-adoption-1-2-months","title":"Phase 2: Gradual Adoption (1-2 months)","text":"<ul> <li>Add state tracking to critical pipelines</li> <li>Implement artifact storage tracking</li> <li>Build dashboards for visibility</li> <li>Train teams on CLI usage</li> </ul>"},{"location":"problem-statement/#phase-3-optimization-ongoing","title":"Phase 3: Optimization (Ongoing)","text":"<ul> <li>Implement smart retry logic based on state history</li> <li>Optimize parallel state execution</li> <li>Add predictive analytics for build time estimation</li> <li>Integrate with monitoring/alerting systems</li> </ul>"},{"location":"problem-statement/#technical-architecture","title":"Technical Architecture","text":""},{"location":"problem-statement/#high-level-components","title":"High-Level Components","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Build Pipelines                           \u2502\n\u2502  (Concourse, Jenkins, GitHub Actions, GitLab CI, etc.)          \u2502\n\u2502                                                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502  Packer  \u2502  \u2502 Ansible  \u2502  \u2502  Shell   \u2502  \u2502  Custom  \u2502      \u2502\n\u2502  \u2502 Scripts  \u2502  \u2502Playbooks \u2502  \u2502 Scripts  \u2502  \u2502  Tools   \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502       \u2502             \u2502             \u2502             \u2502              \u2502\n\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2502                       \u2502                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502 CLI Commands\n                        \u2502 (bldst build add-state, etc.)\n                        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    BuildState CLI                                \u2502\n\u2502  \u2022 Parse commands                                                \u2502\n\u2502  \u2022 Authenticate with API                                         \u2502\n\u2502  \u2022 Format input/output                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502 REST API\n                        \u2502 (HTTP/JSON)\n                        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    FastAPI Service                               \u2502\n\u2502  \u2022 Endpoint routing                                              \u2502\n\u2502  \u2022 Authentication/Authorization                                  \u2502\n\u2502  \u2022 Business logic                                                \u2502\n\u2502  \u2022 State validation                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502 SQL Queries\n                        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    PostgreSQL Database                           \u2502\n\u2502  \u2022 Build state records                                           \u2502\n\u2502  \u2022 Build history                                                 \u2502\n\u2502  \u2022 Artifact locations                                            \u2502\n\u2502  \u2022 User/API key management                                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n                        \u25b2\n                        \u2502 Query/Download\n                        \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502                                       \u2502\n\u250c\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502    S3    \u2502  \u2502   NFS    \u2502  \u2502  Ceph   \u2502   \u2502 Artifact Storage\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n</code></pre>"},{"location":"problem-statement/#database-schema-highlights","title":"Database Schema Highlights","text":"<p>builds table: - Tracks build metadata (project, platform, OS, image type) - Current state and overall status - Timestamps for audit trail</p> <p>build_states table: - Historical record of all state transitions - State code, status, timestamps - Artifact storage tracking fields:   - artifact_storage_type (s3, nfs, ebs, ceph, etc.)   - artifact_storage_path (full URI)   - artifact_size_bytes   - artifact_checksum (SHA256/MD5)   - artifact_metadata (JSON)</p> <p>state_codes table: - Defines available states per project - Descriptions, prerequisites, expected durations - Enables custom state codes per project type</p>"},{"location":"problem-statement/#conclusion","title":"Conclusion","text":"<p>The State-Based Build Management Framework solves the critical pain points of multi-cloud IaaS image creation:</p> <p>\u2705 Resumable builds save hours on retries \u2705 Universal state tracking provides visibility across all platforms \u2705 Artifact management enables distributed build coordination \u2705 Scalable architecture adapts to growing complexity \u2705 Easy integration with existing tools and pipelines  </p> <p>By introducing a simple, standardized state code system (0-100) backed by a robust API and database, organizations can:</p> <ul> <li>Reduce build time by 50-80% through intelligent resumption</li> <li>Improve reliability with clear failure tracking and retry logic</li> <li>Increase visibility with real-time dashboards and progress reporting</li> <li>Enable coordination across distributed build infrastructure</li> <li>Simplify maintenance with a scalable, extensible framework</li> </ul> <p>The framework is designed for gradual adoption - start with one pipeline, prove the value, then expand across your organization.</p> <p>Ready to get started? See QUICKSTART.md for installation and deployment instructions.</p> <p>Need more details? See ARTIFACT-STORAGE.md for artifact tracking documentation.</p> <p>Last Updated: February 16, 2026</p>"},{"location":"resumable-builds-design/","title":"Resumable Build System - Design Document","text":""},{"location":"resumable-builds-design/#executive-summary","title":"\ud83d\udccb Executive Summary","text":"<p>This document outlines the design for a resumable build system that enables long-running IaaS VM image builds to recover from failures without restarting from scratch. The system tracks build artifacts, state progression, and provides orchestration capabilities to resume builds from the last successful state.</p>"},{"location":"resumable-builds-design/#problem-statement","title":"\ud83c\udfaf Problem Statement","text":""},{"location":"resumable-builds-design/#current-challenges","title":"Current Challenges","text":"<p>Long-Running Monolithic Builds: - VM image builds can take 1+ hours to complete - A single failure means restarting the entire process - Network issues, quota limits, or transient errors waste hours - No visibility into which artifacts were successfully created</p> <p>Artifacts Without Context: - Intermediate VM snapshots are created but not tracked - Build scripts don't know what artifacts exist from previous runs - Manual intervention required to resume builds - Risk of artifact corruption or confusion</p>"},{"location":"resumable-builds-design/#use-case-example","title":"Use Case Example","text":"<pre><code>Build Pipeline: RHEL 9 Base Image for AWS\nTotal Time: ~75 minutes\n\nState 0:  Pending (0 min)\nState 5:  Validate configuration (2 min)\nState 10: Create base VM (5 min)\nState 15: Security hardening (8 min)\nState 20: Install packages (15 min)  \u2190 FAILS HERE (network timeout)\nState 25: Configure services (10 min)\nState 30: Install monitoring (8 min)\nState 35: Run tests (12 min)\nState 40: Create snapshot (10 min)\nState 45: Register AMI (5 min)\nState 100: Complete\n\nWithout resumability: Start over, waste 30 minutes\nWith resumability: Resume from State 20, waste 0 minutes\n</code></pre>"},{"location":"resumable-builds-design/#architecture-overview","title":"\ud83c\udfd7\ufe0f Architecture Overview","text":""},{"location":"resumable-builds-design/#high-level-components","title":"High-Level Components","text":"<pre><code>graph TB\n    subgraph \"CI/CD Platform\"\n        A[Concourse/Jenkins Job]\n        B[Build Script]\n        C[CLI Tool]\n    end\n\n    subgraph \"Build State API\"\n        D[REST API]\n        E[Database]\n        F[Artifact Registry]\n    end\n\n    subgraph \"Orchestrator\"\n        G[Resume Orchestrator]\n        H[Webhook Handler]\n        I[Job Trigger]\n    end\n\n    subgraph \"Storage Backends\"\n        J[AWS S3]\n        K[Azure Blob]\n        L[GCP Storage]\n        M[Local Disk]\n    end\n\n    A --&gt; B\n    B --&gt; C\n    C --&gt; D\n    D --&gt; E\n    D --&gt; F\n    F --&gt; J\n    F --&gt; K\n    F --&gt; L\n    F --&gt; M\n\n    A -.-&gt;|failure| H\n    H --&gt; G\n    G --&gt; I\n    I -.-&gt;|resume| A\n\n    style G fill:#f9f,stroke:#333\n    style F fill:#bbf,stroke:#333\n    style E fill:#bfb,stroke:#333</code></pre>"},{"location":"resumable-builds-design/#database-schema-design","title":"\ud83d\udcca Database Schema Design","text":""},{"location":"resumable-builds-design/#new-tables","title":"New Tables","text":""},{"location":"resumable-builds-design/#1-build_artifacts-table","title":"1. <code>build_artifacts</code> Table","text":"<p>Tracks all artifacts created during a build, with their storage locations and checksums.</p> <pre><code>CREATE TABLE build_artifacts (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    build_id UUID NOT NULL REFERENCES builds(id) ON DELETE CASCADE,\n    state_code INTEGER NOT NULL,\n\n    -- Artifact identification\n    artifact_name VARCHAR(255) NOT NULL,\n    artifact_type VARCHAR(50) NOT NULL,  -- 'vm_snapshot', 'ami', 'disk_image', 'config_file', etc.\n    artifact_path TEXT NOT NULL,         -- Full path/URL to artifact\n\n    -- Storage details\n    storage_backend VARCHAR(50) NOT NULL,  -- 's3', 'azure_blob', 'gcp_storage', 'local', 'vsphere'\n    storage_region VARCHAR(50),\n    storage_bucket VARCHAR(255),\n    storage_key TEXT,                     -- Key/path within bucket\n\n    -- Artifact metadata\n    size_bytes BIGINT,\n    checksum VARCHAR(64),                 -- SHA256 checksum\n    checksum_algorithm VARCHAR(20) DEFAULT 'sha256',\n\n    -- Artifact lifecycle\n    is_resumable BOOLEAN DEFAULT TRUE,    -- Can this artifact be used to resume?\n    is_final BOOLEAN DEFAULT FALSE,       -- Is this the final deliverable?\n    expires_at TIMESTAMP,                 -- When to clean up temporary artifacts\n\n    -- Additional metadata as JSON\n    metadata JSONB,                       -- VM ID, snapshot ID, AMI ID, etc.\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n    deleted_at TIMESTAMP,                 -- Soft delete for audit\n\n    UNIQUE(build_id, artifact_name)\n);\n\nCREATE INDEX idx_build_artifacts_build_id ON build_artifacts(build_id);\nCREATE INDEX idx_build_artifacts_state_code ON build_artifacts(state_code);\nCREATE INDEX idx_build_artifacts_type ON build_artifacts(artifact_type);\nCREATE INDEX idx_build_artifacts_resumable ON build_artifacts(is_resumable) WHERE is_resumable = TRUE;\nCREATE INDEX idx_build_artifacts_expires ON build_artifacts(expires_at) WHERE expires_at IS NOT NULL;\n</code></pre>"},{"location":"resumable-builds-design/#2-build_variables-table","title":"2. <code>build_variables</code> Table","text":"<p>Stores build-specific variables needed for resumption (VM IDs, network config, etc.).</p> <pre><code>CREATE TABLE build_variables (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    build_id UUID NOT NULL REFERENCES builds(id) ON DELETE CASCADE,\n\n    -- Variable details\n    variable_key VARCHAR(255) NOT NULL,\n    variable_value TEXT NOT NULL,\n    variable_type VARCHAR(50) DEFAULT 'string',  -- 'string', 'json', 'encrypted'\n\n    -- When was this variable set?\n    set_at_state INTEGER,                -- Which state code set this variable\n\n    -- Variable lifecycle\n    is_sensitive BOOLEAN DEFAULT FALSE,  -- Should this be encrypted/masked?\n    is_required_for_resume BOOLEAN DEFAULT FALSE,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(build_id, variable_key)\n);\n\nCREATE INDEX idx_build_variables_build_id ON build_variables(build_id);\nCREATE INDEX idx_build_variables_required ON build_variables(is_required_for_resume) WHERE is_required_for_resume = TRUE;\n</code></pre>"},{"location":"resumable-builds-design/#3-resumable_states-table","title":"3. <code>resumable_states</code> Table","text":"<p>Defines which state codes are resumable and their requirements.</p> <pre><code>CREATE TABLE resumable_states (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    project_id TEXT NOT NULL REFERENCES projects(id),\n    state_code INTEGER NOT NULL,\n\n    -- Resumability configuration\n    is_resumable BOOLEAN DEFAULT TRUE,\n    resume_strategy VARCHAR(50),  -- 'from_artifact', 'rerun_state', 'skip_to_next'\n\n    -- Requirements for resumption\n    required_artifacts JSONB,     -- Array of artifact names/types needed\n    required_variables JSONB,     -- Array of variable keys needed\n\n    -- Resume script/command\n    resume_command TEXT,          -- Command or script to execute on resume\n    resume_timeout_seconds INTEGER DEFAULT 3600,\n\n    -- Documentation\n    description TEXT,\n    notes TEXT,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(project_id, state_code)\n);\n\nCREATE INDEX idx_resumable_states_project ON resumable_states(project_id);\nCREATE INDEX idx_resumable_states_resumable ON resumable_states(is_resumable) WHERE is_resumable = TRUE;\n</code></pre>"},{"location":"resumable-builds-design/#4-resume_requests-table","title":"4. <code>resume_requests</code> Table","text":"<p>Tracks requests to resume builds and their status.</p> <pre><code>CREATE TABLE resume_requests (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    build_id UUID NOT NULL REFERENCES builds(id),\n\n    -- Resume details\n    resume_from_state INTEGER NOT NULL,\n    resume_to_state INTEGER,              -- NULL means resume to completion\n    resume_reason TEXT,\n\n    -- Request source\n    requested_by VARCHAR(255),            -- User/system that requested resume\n    request_source VARCHAR(50),           -- 'api', 'webhook', 'cli', 'auto'\n\n    -- Orchestration\n    orchestration_job_id TEXT,            -- Concourse/Jenkins job ID\n    orchestration_job_url TEXT,\n    orchestration_status VARCHAR(50),     -- 'pending', 'triggered', 'running', 'completed', 'failed'\n\n    -- Execution tracking\n    triggered_at TIMESTAMP,\n    completed_at TIMESTAMP,\n    error_message TEXT,\n\n    -- Metadata\n    metadata JSONB,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX idx_resume_requests_build_id ON resume_requests(build_id);\nCREATE INDEX idx_resume_requests_status ON resume_requests(orchestration_status);\nCREATE INDEX idx_resume_requests_created ON resume_requests(created_at DESC);\n</code></pre>"},{"location":"resumable-builds-design/#5-build_jobs-table","title":"5. <code>build_jobs</code> Table","text":"<p>Links builds to CI/CD job information.</p> <pre><code>CREATE TABLE build_jobs (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    build_id UUID NOT NULL REFERENCES builds(id),\n\n    -- CI/CD platform details\n    platform VARCHAR(50) NOT NULL,        -- 'concourse', 'jenkins', 'gitlab-ci', 'github-actions'\n    pipeline_name VARCHAR(255),\n    job_name VARCHAR(255) NOT NULL,\n    job_url TEXT,\n\n    -- Job identification\n    job_id TEXT,                          -- Platform-specific job ID\n    build_number VARCHAR(50),\n\n    -- Trigger information\n    triggered_by VARCHAR(255),\n    trigger_source VARCHAR(50),           -- 'manual', 'webhook', 'schedule', 'resume'\n\n    -- Job status\n    status VARCHAR(50),                   -- 'pending', 'running', 'success', 'failed', 'aborted'\n    started_at TIMESTAMP,\n    completed_at TIMESTAMP,\n\n    -- Resume context\n    is_resume_job BOOLEAN DEFAULT FALSE,\n    resumed_from_state INTEGER,\n    parent_job_id UUID REFERENCES build_jobs(id),\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX idx_build_jobs_build_id ON build_jobs(build_id);\nCREATE INDEX idx_build_jobs_platform_job ON build_jobs(platform, job_id);\nCREATE INDEX idx_build_jobs_status ON build_jobs(status);\n</code></pre>"},{"location":"resumable-builds-design/#schema-relationships","title":"Schema Relationships","text":"<pre><code>erDiagram\n    builds ||--o{ build_artifacts : has\n    builds ||--o{ build_variables : has\n    builds ||--o{ resume_requests : has\n    builds ||--o{ build_jobs : has\n    builds ||--o{ build_states : has\n    projects ||--o{ resumable_states : defines\n    resume_requests ||--o| build_jobs : triggers\n    build_jobs ||--o| build_jobs : resumes\n\n    builds {\n        uuid id PK\n        text project_id FK\n        text platform_id FK\n        text os_version_id FK\n        text image_type_id FK\n        int current_state\n        string status\n    }\n\n    build_artifacts {\n        uuid id PK\n        uuid build_id FK\n        int state_code\n        string artifact_name\n        string artifact_type\n        text artifact_path\n        string storage_backend\n        boolean is_resumable\n        boolean is_final\n    }\n\n    build_variables {\n        uuid id PK\n        uuid build_id FK\n        string variable_key\n        text variable_value\n        int set_at_state\n        boolean is_required_for_resume\n    }\n\n    resumable_states {\n        uuid id PK\n        text project_id FK\n        int state_code\n        boolean is_resumable\n        string resume_strategy\n        jsonb required_artifacts\n        text resume_command\n    }\n\n    resume_requests {\n        uuid id PK\n        uuid build_id FK\n        int resume_from_state\n        string orchestration_status\n        text orchestration_job_url\n    }\n\n    build_jobs {\n        uuid id PK\n        uuid build_id FK\n        string platform\n        string job_name\n        boolean is_resume_job\n        int resumed_from_state\n        uuid parent_job_id FK\n    }</code></pre>"},{"location":"resumable-builds-design/#build-workflow-with-resumability","title":"\ud83d\udd04 Build Workflow with Resumability","text":""},{"location":"resumable-builds-design/#normal-build-flow","title":"Normal Build Flow","text":"<pre><code>sequenceDiagram\n    participant CI as CI/CD Job\n    participant CLI as bldst CLI\n    participant API as Build State API\n    participant DB as Database\n    participant Storage as Cloud Storage\n\n    Note over CI,Storage: Initial Build Start\n\n    CI-&gt;&gt;CLI: bldst build create\n    CLI-&gt;&gt;API: POST /builds\n    API-&gt;&gt;DB: Create build record\n    API--&gt;&gt;CLI: build_id\n    CLI--&gt;&gt;CI: build_id\n\n    Note over CI,Storage: State Progression\n\n    loop Each Build Step\n        CI-&gt;&gt;CLI: bldst build update-state --state X\n        CLI-&gt;&gt;API: POST /builds/{id}/state\n        API-&gt;&gt;DB: Update current_state\n\n        alt Step produces artifact\n            CI-&gt;&gt;Storage: Upload artifact\n            CI-&gt;&gt;CLI: bldst artifact register\n            CLI-&gt;&gt;API: POST /builds/{id}/artifacts\n            API-&gt;&gt;DB: Store artifact metadata\n        end\n\n        alt Step needs variables\n            CI-&gt;&gt;CLI: bldst variable set key=value\n            CLI-&gt;&gt;API: POST /builds/{id}/variables\n            API-&gt;&gt;DB: Store variable\n        end\n    end\n\n    Note over CI,Storage: Build Complete\n    CI-&gt;&gt;CLI: bldst build update-state --state 100\n    CLI-&gt;&gt;API: POST /builds/{id}/state\n    API-&gt;&gt;DB: Mark build complete</code></pre>"},{"location":"resumable-builds-design/#build-failure-and-resume-flow","title":"Build Failure and Resume Flow","text":"<pre><code>sequenceDiagram\n    participant CI as CI/CD Job\n    participant CLI as bldst CLI\n    participant API as Build State API\n    participant Orch as Orchestrator\n    participant Webhook as Webhook Handler\n    participant DB as Database\n\n    Note over CI,Webhook: Build Fails at State 35\n\n    CI-&gt;&gt;CLI: bldst build record-failure --state 35\n    CLI-&gt;&gt;API: POST /builds/{id}/failure\n    API-&gt;&gt;DB: Record failure\n    API-&gt;&gt;Webhook: Trigger failure webhook\n\n    Note over CI,Webhook: Decision to Resume\n\n    Webhook-&gt;&gt;Orch: Build failed notification\n    Orch-&gt;&gt;API: GET /builds/{id}\n    API--&gt;&gt;Orch: Build details\n    Orch-&gt;&gt;API: GET /builds/{id}/artifacts?resumable=true\n    API--&gt;&gt;Orch: List of resumable artifacts\n\n    alt Auto-resume enabled\n        Orch-&gt;&gt;API: POST /builds/{id}/resume\n        API-&gt;&gt;DB: Create resume_request\n        Orch-&gt;&gt;CI: Trigger new job with resume params\n    else Manual resume\n        Note over Orch: Admin reviews failure\n        Orch-&gt;&gt;API: POST /builds/{id}/resume\n        API-&gt;&gt;DB: Create resume_request\n        API--&gt;&gt;Orch: resume_request_id\n        Orch-&gt;&gt;CI: Trigger new job with resume params\n    end\n\n    Note over CI,DB: Resume Job Starts\n\n    CI-&gt;&gt;CLI: bldst build resume {build_id}\n    CLI-&gt;&gt;API: GET /builds/{id}/resume-context\n    API-&gt;&gt;DB: Get artifacts + variables + last state\n    API--&gt;&gt;CLI: Resume context\n    CLI--&gt;&gt;CI: Resume from state 35\n\n    CI-&gt;&gt;CLI: Restore artifacts from state 30\n    CLI-&gt;&gt;API: GET /builds/{id}/artifacts?state=30\n    API--&gt;&gt;CLI: Artifact metadata\n    CLI--&gt;&gt;CI: Download from storage_path\n\n    Note over CI: Skip to failed state\n    CI-&gt;&gt;CLI: bldst build update-state --state 35\n    Note over CI: Continue from here</code></pre>"},{"location":"resumable-builds-design/#artifact-lifecycle","title":"Artifact Lifecycle","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Created: Artifact produced\n    Created --&gt; Registered: bldst artifact register\n    Registered --&gt; Validated: Checksum verified\n    Validated --&gt; Resumable: marked is_resumable=true\n    Resumable --&gt; Used: Used in resume\n    Used --&gt; Expired: TTL reached\n    Expired --&gt; Deleted: Cleanup job\n    Resumable --&gt; Final: marked is_final=true\n    Final --&gt; Archived: Long-term storage\n    Deleted --&gt; [*]\n    Archived --&gt; [*]</code></pre>"},{"location":"resumable-builds-design/#api-endpoints","title":"\ud83d\udd0c API Endpoints","text":""},{"location":"resumable-builds-design/#artifact-management","title":"Artifact Management","text":""},{"location":"resumable-builds-design/#post-buildsbuild_idartifacts","title":"POST <code>/builds/{build_id}/artifacts</code>","text":"<p>Register a new artifact for a build.</p> <p>Request: <pre><code>{\n  \"state_code\": 30,\n  \"artifact_name\": \"rhel9-base-snapshot-001\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-bucket/builds/abc123/snapshot-001.vmdk\",\n  \"storage_backend\": \"s3\",\n  \"storage_region\": \"us-east-1\",\n  \"storage_bucket\": \"my-bucket\",\n  \"storage_key\": \"builds/abc123/snapshot-001.vmdk\",\n  \"size_bytes\": 5368709120,\n  \"checksum\": \"a1b2c3d4...\",\n  \"is_resumable\": true,\n  \"is_final\": false,\n  \"expires_at\": \"2026-02-21T00:00:00Z\",\n  \"metadata\": {\n    \"vm_id\": \"i-0123456789abcdef\",\n    \"snapshot_id\": \"snap-0123456789abcdef\"\n  }\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"art-uuid-123\",\n  \"build_id\": \"build-uuid-456\",\n  \"state_code\": 30,\n  \"artifact_name\": \"rhel9-base-snapshot-001\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-bucket/builds/abc123/snapshot-001.vmdk\",\n  \"storage_backend\": \"s3\",\n  \"is_resumable\": true,\n  \"created_at\": \"2026-02-14T12:00:00Z\"\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#get-buildsbuild_idartifacts","title":"GET <code>/builds/{build_id}/artifacts</code>","text":"<p>List all artifacts for a build.</p> <p>Query Parameters: - <code>state_code</code> (int) - Filter by state code - <code>artifact_type</code> (string) - Filter by type - <code>is_resumable</code> (bool) - Only resumable artifacts - <code>is_final</code> (bool) - Only final artifacts</p> <p>Response: <pre><code>[\n  {\n    \"id\": \"art-uuid-123\",\n    \"artifact_name\": \"rhel9-base-snapshot-001\",\n    \"state_code\": 30,\n    \"artifact_type\": \"vm_snapshot\",\n    \"storage_backend\": \"s3\",\n    \"artifact_path\": \"s3://...\",\n    \"is_resumable\": true,\n    \"metadata\": {...}\n  }\n]\n</code></pre></p>"},{"location":"resumable-builds-design/#get-buildsbuild_idartifactsartifact_id","title":"GET <code>/builds/{build_id}/artifacts/{artifact_id}</code>","text":"<p>Get specific artifact details.</p>"},{"location":"resumable-builds-design/#delete-buildsbuild_idartifactsartifact_id","title":"DELETE <code>/builds/{build_id}/artifacts/{artifact_id}</code>","text":"<p>Soft delete an artifact (requires admin scope).</p>"},{"location":"resumable-builds-design/#variable-management","title":"Variable Management","text":""},{"location":"resumable-builds-design/#post-buildsbuild_idvariables","title":"POST <code>/builds/{build_id}/variables</code>","text":"<p>Set a build variable.</p> <p>Request: <pre><code>{\n  \"variable_key\": \"vm_instance_id\",\n  \"variable_value\": \"i-0123456789abcdef\",\n  \"variable_type\": \"string\",\n  \"set_at_state\": 20,\n  \"is_required_for_resume\": true,\n  \"is_sensitive\": false\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#get-buildsbuild_idvariables","title":"GET <code>/builds/{build_id}/variables</code>","text":"<p>Get all variables for a build.</p> <p>Query Parameters: - <code>required_for_resume</code> (bool) - Only required variables</p>"},{"location":"resumable-builds-design/#patch-buildsbuild_idvariableskey","title":"PATCH <code>/builds/{build_id}/variables/{key}</code>","text":"<p>Update a variable value.</p>"},{"location":"resumable-builds-design/#delete-buildsbuild_idvariableskey","title":"DELETE <code>/builds/{build_id}/variables/{key}</code>","text":"<p>Delete a variable.</p>"},{"location":"resumable-builds-design/#resume-operations","title":"Resume Operations","text":""},{"location":"resumable-builds-design/#post-buildsbuild_idresume","title":"POST <code>/builds/{build_id}/resume</code>","text":"<p>Request to resume a build.</p> <p>Request: <pre><code>{\n  \"resume_from_state\": 35,\n  \"resume_to_state\": null,\n  \"resume_reason\": \"Network timeout during package installation\",\n  \"requested_by\": \"ops-team\",\n  \"orchestration_config\": {\n    \"platform\": \"concourse\",\n    \"pipeline\": \"rhel9-images\",\n    \"job\": \"build-base-image\",\n    \"trigger_webhook\": \"https://concourse.example.com/api/v1/teams/main/pipelines/rhel9-images/jobs/build-base-image/builds\"\n  }\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"resume_request_id\": \"resume-uuid-789\",\n  \"build_id\": \"build-uuid-456\",\n  \"resume_from_state\": 35,\n  \"orchestration_status\": \"pending\",\n  \"created_at\": \"2026-02-14T13:00:00Z\"\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#get-buildsbuild_idresume-context","title":"GET <code>/builds/{build_id}/resume-context</code>","text":"<p>Get everything needed to resume a build.</p> <p>Response: <pre><code>{\n  \"build_id\": \"build-uuid-456\",\n  \"current_state\": 30,\n  \"last_successful_state\": 30,\n  \"failed_state\": 35,\n  \"resume_from_state\": 35,\n  \"artifacts\": [\n    {\n      \"state_code\": 20,\n      \"artifact_name\": \"base-vm\",\n      \"artifact_path\": \"s3://...\",\n      \"metadata\": {...}\n    },\n    {\n      \"state_code\": 30,\n      \"artifact_name\": \"snapshot-001\",\n      \"artifact_path\": \"s3://...\",\n      \"metadata\": {...}\n    }\n  ],\n  \"variables\": {\n    \"vm_instance_id\": \"i-0123456789abcdef\",\n    \"vpc_id\": \"vpc-0123456789\",\n    \"subnet_id\": \"subnet-0123456789\"\n  },\n  \"resumable_state_config\": {\n    \"resume_strategy\": \"from_artifact\",\n    \"required_artifacts\": [\"snapshot-001\"],\n    \"required_variables\": [\"vm_instance_id\"],\n    \"resume_command\": \"./scripts/resume-from-snapshot.sh\"\n  }\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#get-buildsbuild_idresume-requests","title":"GET <code>/builds/{build_id}/resume-requests</code>","text":"<p>List all resume requests for a build.</p>"},{"location":"resumable-builds-design/#get-resume-requestsrequest_id","title":"GET <code>/resume-requests/{request_id}</code>","text":"<p>Get details of a specific resume request.</p>"},{"location":"resumable-builds-design/#patch-resume-requestsrequest_id","title":"PATCH <code>/resume-requests/{request_id}</code>","text":"<p>Update resume request status (for orchestrator).</p> <p>Request: <pre><code>{\n  \"orchestration_status\": \"triggered\",\n  \"orchestration_job_id\": \"123456\",\n  \"orchestration_job_url\": \"https://ci.example.com/job/123456\",\n  \"triggered_at\": \"2026-02-14T13:05:00Z\"\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#resumable-state-configuration","title":"Resumable State Configuration","text":""},{"location":"resumable-builds-design/#post-projectsproject_idresumable-states","title":"POST <code>/projects/{project_id}/resumable-states</code>","text":"<p>Define which states are resumable.</p> <p>Request: <pre><code>{\n  \"state_code\": 35,\n  \"is_resumable\": true,\n  \"resume_strategy\": \"from_artifact\",\n  \"required_artifacts\": [\"vm_snapshot\", \"network_config\"],\n  \"required_variables\": [\"vm_id\", \"vpc_id\"],\n  \"resume_command\": \"./scripts/resume-package-install.sh\",\n  \"resume_timeout_seconds\": 3600,\n  \"description\": \"Resume package installation from snapshot\"\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#get-projectsproject_idresumable-states","title":"GET <code>/projects/{project_id}/resumable-states</code>","text":"<p>List resumable state configurations.</p>"},{"location":"resumable-builds-design/#get-projectsproject_idresumable-statesstate_code","title":"GET <code>/projects/{project_id}/resumable-states/{state_code}</code>","text":"<p>Get specific resumable state config.</p>"},{"location":"resumable-builds-design/#put-projectsproject_idresumable-statesstate_code","title":"PUT <code>/projects/{project_id}/resumable-states/{state_code}</code>","text":"<p>Update resumable state configuration.</p>"},{"location":"resumable-builds-design/#cli-commands","title":"\ud83c\udfae CLI Commands","text":""},{"location":"resumable-builds-design/#artifact-commands","title":"Artifact Commands","text":"<pre><code># Register an artifact\nbldst artifact register &lt;build-id&gt; \\\n  --state 30 \\\n  --name \"rhel9-snapshot-001\" \\\n  --type \"vm_snapshot\" \\\n  --path \"s3://bucket/path/to/snapshot.vmdk\" \\\n  --backend s3 \\\n  --resumable \\\n  --metadata '{\"vm_id\": \"i-abc123\", \"snapshot_id\": \"snap-xyz789\"}'\n\n# List artifacts for a build\nbldst artifact list &lt;build-id&gt;\n\n# List only resumable artifacts\nbldst artifact list &lt;build-id&gt; --resumable\n\n# Get artifact details\nbldst artifact get &lt;build-id&gt; &lt;artifact-id&gt;\n\n# Delete artifact\nbldst artifact delete &lt;build-id&gt; &lt;artifact-id&gt;\n</code></pre>"},{"location":"resumable-builds-design/#variable-commands","title":"Variable Commands","text":"<pre><code># Set a variable\nbldst variable set &lt;build-id&gt; vm_id=i-abc123 \\\n  --state 20 \\\n  --required-for-resume\n\n# Set multiple variables\nbldst variable set &lt;build-id&gt; \\\n  vm_id=i-abc123 \\\n  vpc_id=vpc-xyz789 \\\n  subnet_id=subnet-123 \\\n  --state 20\n\n# Get all variables\nbldst variable list &lt;build-id&gt;\n\n# Get variable value\nbldst variable get &lt;build-id&gt; vm_id\n\n# Delete variable\nbldst variable delete &lt;build-id&gt; vm_id\n</code></pre>"},{"location":"resumable-builds-design/#resume-commands","title":"Resume Commands","text":"<pre><code># Get resume context (what's needed to resume)\nbldst build resume-context &lt;build-id&gt;\n\n# Output in different formats\nbldst build resume-context &lt;build-id&gt; --output json\nbldst build resume-context &lt;build-id&gt; --output yaml\nbldst build resume-context &lt;build-id&gt; --output env  # For sourcing in shell\n\n# Request a resume\nbldst build resume &lt;build-id&gt; \\\n  --from-state 35 \\\n  --reason \"Network timeout during package installation\" \\\n  --platform concourse \\\n  --pipeline rhel9-images \\\n  --job build-base-image\n\n# List resume requests\nbldst build resume-requests &lt;build-id&gt;\n\n# Check resume request status\nbldst resume-request get &lt;request-id&gt;\n</code></pre>"},{"location":"resumable-builds-design/#resumable-state-configuration_1","title":"Resumable State Configuration","text":"<pre><code># Define a resumable state for a project\nbldst resumable-state create &lt;project-id&gt; \\\n  --state 35 \\\n  --strategy from_artifact \\\n  --required-artifacts \"vm_snapshot,network_config\" \\\n  --required-variables \"vm_id,vpc_id\" \\\n  --command \"./scripts/resume-package-install.sh\" \\\n  --timeout 3600\n\n# List resumable states for project\nbldst resumable-state list &lt;project-id&gt;\n\n# Get resumable state config\nbldst resumable-state get &lt;project-id&gt; 35\n\n# Update resumable state\nbldst resumable-state update &lt;project-id&gt; 35 \\\n  --timeout 7200\n</code></pre>"},{"location":"resumable-builds-design/#orchestrator-service","title":"\ud83e\udd16 Orchestrator Service","text":""},{"location":"resumable-builds-design/#architecture","title":"Architecture","text":"<pre><code>graph TB\n    subgraph \"Orchestrator Service\"\n        A[Webhook Listener]\n        B[Resume Queue]\n        C[Job Trigger]\n        D[Status Monitor]\n    end\n\n    subgraph \"External Systems\"\n        E[Build State API]\n        F[Concourse]\n        G[Jenkins]\n        H[GitLab CI]\n        I[SNS/SQS]\n    end\n\n    E --&gt;|failure webhook| A\n    I --&gt;|message| A\n    A --&gt; B\n    B --&gt; C\n    C --&gt;|trigger job| F\n    C --&gt;|trigger job| G\n    C --&gt;|trigger job| H\n    F --&gt;|job status| D\n    G --&gt;|job status| D\n    H --&gt;|job status| D\n    D --&gt;|update status| E\n\n    style A fill:#f96,stroke:#333\n    style C fill:#9cf,stroke:#333\n    style B fill:#fc9,stroke:#333</code></pre>"},{"location":"resumable-builds-design/#orchestrator-components","title":"Orchestrator Components","text":""},{"location":"resumable-builds-design/#1-webhook-handler","title":"1. Webhook Handler","text":"<p>Receives failure notifications and queues resume requests.</p> <p>Endpoints: <pre><code>POST /webhooks/build-failure\nPOST /webhooks/sns\nPOST /webhooks/sqs\n</code></pre></p> <p>Build Failure Webhook Payload: <pre><code>{\n  \"event\": \"build.failed\",\n  \"build_id\": \"build-uuid-456\",\n  \"current_state\": 35,\n  \"last_successful_state\": 30,\n  \"failure_reason\": \"Network timeout\",\n  \"timestamp\": \"2026-02-14T12:30:00Z\",\n  \"metadata\": {\n    \"ci_platform\": \"concourse\",\n    \"pipeline\": \"rhel9-images\",\n    \"job\": \"build-base-image\",\n    \"build_number\": \"123\"\n  }\n}\n</code></pre></p>"},{"location":"resumable-builds-design/#2-resume-queue","title":"2. Resume Queue","text":"<p>Manages pending resume requests with priority and retry logic.</p> <p>Features: - Priority queue (critical builds first) - Retry with exponential backoff - Rate limiting per CI platform - Dead letter queue for failed resumes</p>"},{"location":"resumable-builds-design/#3-job-trigger","title":"3. Job Trigger","text":"<p>Triggers CI/CD jobs with resume parameters.</p> <p>Concourse Example: <pre><code># Trigger Concourse job with resume params\nfly -t main trigger-job \\\n  --job rhel9-images/build-base-image \\\n  --var build_id=build-uuid-456 \\\n  --var resume_mode=true \\\n  --var resume_from_state=35\n</code></pre></p> <p>Jenkins Example: <pre><code># Trigger Jenkins job with resume params\ncurl -X POST \\\n  \"https://jenkins.example.com/job/rhel9-images/job/build-base-image/buildWithParameters\" \\\n  --user token:API_TOKEN \\\n  --data \"BUILD_ID=build-uuid-456\" \\\n  --data \"RESUME_MODE=true\" \\\n  --data \"RESUME_FROM_STATE=35\"\n</code></pre></p>"},{"location":"resumable-builds-design/#4-status-monitor","title":"4. Status Monitor","text":"<p>Monitors triggered jobs and updates resume request status.</p> <p>Polling Strategy: - Poll every 30 seconds for running jobs - Update API with job status - Detect stalled jobs (no progress for 10 minutes) - Send alerts on repeated failures</p>"},{"location":"resumable-builds-design/#orchestrator-configuration","title":"Orchestrator Configuration","text":"<pre><code>orchestrator:\n  enabled: true\n  workers: 3\n\n  queue:\n    backend: redis\n    max_queue_size: 1000\n    retry_attempts: 3\n    retry_backoff_seconds: [60, 300, 900]\n\n  webhooks:\n    enabled: true\n    port: 8090\n    secret: \"${WEBHOOK_SECRET}\"\n\n  platforms:\n    - name: concourse\n      enabled: true\n      base_url: \"https://concourse.example.com\"\n      team: main\n      username: \"${CONCOURSE_USER}\"\n      password: \"${CONCOURSE_PASS}\"\n      rate_limit: 10  # jobs per minute\n\n    - name: jenkins\n      enabled: true\n      base_url: \"https://jenkins.example.com\"\n      username: \"${JENKINS_USER}\"\n      token: \"${JENKINS_TOKEN}\"\n      rate_limit: 5\n\n  monitoring:\n    enabled: true\n    poll_interval_seconds: 30\n    stall_timeout_seconds: 600\n\n  notifications:\n    slack_webhook: \"${SLACK_WEBHOOK}\"\n    email_enabled: false\n</code></pre>"},{"location":"resumable-builds-design/#build-script-integration","title":"\ud83d\udcdd Build Script Integration","text":""},{"location":"resumable-builds-design/#initial-build-with-artifact-tracking","title":"Initial Build (with artifact tracking)","text":"<pre><code>#!/bin/bash\nset -euo pipefail\n\n# Configuration\nBUILD_ID=\"${BUILD_ID:-$(uuidgen)}\"\nPROJECT_ID=\"rhel9-base\"\nSTATE_CODE=0\n\n# Initialize build\necho \"Creating build record...\"\nBUILD_ID=$(bldst build create \\\n  --project-id \"$PROJECT_ID\" \\\n  --platform-id aws-commercial \\\n  --os-version-id rhel-9.3 \\\n  --image-type-id base \\\n  --build-number \"${CI_BUILD_NUMBER}\" \\\n  --output json | jq -r '.id')\n\necho \"Build ID: $BUILD_ID\"\n\n# Save build ID for subsequent steps\necho \"$BUILD_ID\" &gt; /tmp/build_id.txt\n\n# State 5: Validate configuration\nSTATE_CODE=5\necho \"State $STATE_CODE: Validating configuration...\"\nbldst build update-state \"$BUILD_ID\" \\\n  --state $STATE_CODE \\\n  --status in_progress \\\n  --message \"Validating Packer configuration\"\n\npacker validate rhel9-base.pkr.hcl\n\nbldst build update-state \"$BUILD_ID\" \\\n  --state $STATE_CODE \\\n  --status completed \\\n  --message \"Configuration validated\"\n\n# State 10: Create base VM\nSTATE_CODE=10\necho \"State $STATE_CODE: Creating base VM...\"\nbldst build update-state \"$BUILD_ID\" --state $STATE_CODE --status in_progress\n\n# Start packer build\npacker build \\\n  -var=\"build_id=$BUILD_ID\" \\\n  -var=\"build_state=10\" \\\n  rhel9-base.pkr.hcl &gt; /tmp/packer_output.log 2&gt;&amp;1\n\n# Extract VM ID from packer output\nVM_ID=$(grep \"Created instance\" /tmp/packer_output.log | awk '{print $NF}')\n\n# Store VM ID as variable\nbldst variable set \"$BUILD_ID\" vm_id=\"$VM_ID\" \\\n  --state 10 \\\n  --required-for-resume\n\nbldst build update-state \"$BUILD_ID\" --state $STATE_CODE --status completed\n\n# State 20: Install packages (long-running, resumable)\nSTATE_CODE=20\necho \"State $STATE_CODE: Installing packages...\"\nbldst build update-state \"$BUILD_ID\" --state $STATE_CODE --status in_progress\n\n# This might fail due to network issues\nif ! ansible-playbook -i \"$VM_ID,\" install-packages.yml; then\n  echo \"Package installation failed!\"\n\n  # Record failure\n  bldst build record-failure \"$BUILD_ID\" \\\n    --state $STATE_CODE \\\n    --error \"Package installation failed\" \\\n    --retryable\n\n  exit 1\nfi\n\n# Create snapshot after successful package installation\nSNAPSHOT_ID=$(aws ec2 create-snapshot \\\n  --volume-id vol-xyz \\\n  --description \"Build $BUILD_ID state 20\" \\\n  --query 'SnapshotId' \\\n  --output text)\n\n# Register artifact\nbldst artifact register \"$BUILD_ID\" \\\n  --state 20 \\\n  --name \"packages-installed-snapshot\" \\\n  --type \"ebs_snapshot\" \\\n  --path \"aws://snapshot/$SNAPSHOT_ID\" \\\n  --backend aws \\\n  --resumable \\\n  --metadata \"{\\\"snapshot_id\\\": \\\"$SNAPSHOT_ID\\\", \\\"vm_id\\\": \\\"$VM_ID\\\"}\"\n\nbldst build update-state \"$BUILD_ID\" --state $STATE_CODE --status completed\n\n# Continue with remaining states...\n</code></pre>"},{"location":"resumable-builds-design/#resume-build-script","title":"Resume Build Script","text":"<pre><code>#!/bin/bash\nset -euo pipefail\n\n# This script is triggered by the orchestrator with resume parameters\nBUILD_ID=\"${BUILD_ID}\"\nRESUME_MODE=\"${RESUME_MODE:-false}\"\nRESUME_FROM_STATE=\"${RESUME_FROM_STATE:-0}\"\n\necho \"Build ID: $BUILD_ID\"\necho \"Resume Mode: $RESUME_MODE\"\necho \"Resume From State: $RESUME_FROM_STATE\"\n\nif [ \"$RESUME_MODE\" = \"true\" ]; then\n  echo \"===== RESUMING BUILD =====\"\n\n  # Get resume context\n  RESUME_CONTEXT=$(bldst build resume-context \"$BUILD_ID\" --output json)\n\n  # Extract last successful state\n  LAST_STATE=$(echo \"$RESUME_CONTEXT\" | jq -r '.last_successful_state')\n  echo \"Last successful state: $LAST_STATE\"\n\n  # Get variables\n  VM_ID=$(echo \"$RESUME_CONTEXT\" | jq -r '.variables.vm_id')\n  SNAPSHOT_ID=$(echo \"$RESUME_CONTEXT\" | jq -r '.variables.snapshot_id // empty')\n\n  echo \"Restored variables:\"\n  echo \"  VM_ID: $VM_ID\"\n  echo \"  SNAPSHOT_ID: $SNAPSHOT_ID\"\n\n  # Get last snapshot artifact\n  if [ \"$RESUME_FROM_STATE\" -ge 20 ]; then\n    SNAPSHOT_ARTIFACT=$(echo \"$RESUME_CONTEXT\" | \\\n      jq -r '.artifacts[] | select(.state_code == 20 and .artifact_type == \"ebs_snapshot\") | .metadata.snapshot_id')\n\n    if [ -n \"$SNAPSHOT_ARTIFACT\" ]; then\n      echo \"Restoring from snapshot: $SNAPSHOT_ARTIFACT\"\n\n      # Create volume from snapshot\n      VOLUME_ID=$(aws ec2 create-volume \\\n        --snapshot-id \"$SNAPSHOT_ARTIFACT\" \\\n        --availability-zone us-east-1a \\\n        --query 'VolumeId' \\\n        --output text)\n\n      # Attach to instance\n      aws ec2 attach-volume \\\n        --volume-id \"$VOLUME_ID\" \\\n        --instance-id \"$VM_ID\" \\\n        --device /dev/sdf\n\n      echo \"Volume attached. Waiting for it to be available...\"\n      aws ec2 wait volume-in-use --volume-ids \"$VOLUME_ID\"\n    fi\n  fi\n\n  # Skip to the failed state\n  START_STATE=$RESUME_FROM_STATE\nelse\n  echo \"===== STARTING NEW BUILD =====\"\n  START_STATE=0\nfi\n\n# Execute states from START_STATE onwards\ncase $START_STATE in\n  0|5|10)\n    # Run states 0-10 if not resuming\n    run_state_10\n    run_state_20\n    run_state_30\n    # ... etc\n    ;;\n  20)\n    # Resume from state 20\n    echo \"Resuming from package installation...\"\n    run_state_20\n    run_state_30\n    # ... etc\n    ;;\n  30)\n    # Resume from state 30\n    echo \"Resuming from configuration...\"\n    run_state_30\n    run_state_40\n    # ... etc\n    ;;\nesac\n\necho \"Build completed!\"\n</code></pre>"},{"location":"resumable-builds-design/#implementation-phases","title":"\ud83c\udfaf Implementation Phases","text":""},{"location":"resumable-builds-design/#phase-1-database-core-api-week-1-2","title":"Phase 1: Database &amp; Core API (Week 1-2)","text":"<ul> <li> Create database migration for new tables</li> <li> Implement artifact management endpoints</li> <li> Implement variable management endpoints</li> <li> Add unit tests for new models and endpoints</li> </ul>"},{"location":"resumable-builds-design/#phase-2-cli-integration-week-2-3","title":"Phase 2: CLI Integration (Week 2-3)","text":"<ul> <li> Add artifact commands to CLI</li> <li> Add variable commands to CLI</li> <li> Add resume-context command to CLI</li> <li> Update CLI documentation</li> </ul>"},{"location":"resumable-builds-design/#phase-3-resume-api-week-3-4","title":"Phase 3: Resume API (Week 3-4)","text":"<ul> <li> Implement resume request endpoints</li> <li> Implement resumable state configuration</li> <li> Add resume-context aggregation logic</li> <li> Add integration tests</li> </ul>"},{"location":"resumable-builds-design/#phase-4-orchestrator-service-week-4-6","title":"Phase 4: Orchestrator Service (Week 4-6)","text":"<ul> <li> Build webhook handler</li> <li> Implement resume queue</li> <li> Build job triggers for Concourse/Jenkins</li> <li> Add status monitoring</li> <li> Deploy as separate service</li> </ul>"},{"location":"resumable-builds-design/#phase-5-example-scripts-documentation-week-6-7","title":"Phase 5: Example Scripts &amp; Documentation (Week 6-7)","text":"<ul> <li> Create example build scripts</li> <li> Create example resume scripts</li> <li> Write integration guide</li> <li> Create video walkthrough</li> </ul>"},{"location":"resumable-builds-design/#phase-6-production-hardening-week-7-8","title":"Phase 6: Production Hardening (Week 7-8)","text":"<ul> <li> Add monitoring and alerting</li> <li> Performance testing with large builds</li> <li> Security audit</li> <li> Production deployment guide</li> </ul>"},{"location":"resumable-builds-design/#example-scenarios","title":"\ud83d\udd0d Example Scenarios","text":""},{"location":"resumable-builds-design/#scenario-1-network-timeout-during-package-installation","title":"Scenario 1: Network Timeout During Package Installation","text":"<p>Initial Build: - State 0-15: Success (prep work) - State 20: FAIL (network timeout installing packages)</p> <p>Resume Flow: 1. Orchestrator detects failure at state 20 2. Queries API for last successful state (15) 3. Gets artifact from state 15 (base VM snapshot) 4. Triggers new job with:    - <code>BUILD_ID</code> (same as original)    - <code>RESUME_MODE=true</code>    - <code>RESUME_FROM_STATE=20</code> 5. New job:    - Restores snapshot from state 15    - Skips states 0-15    - Retries state 20    - Continues to completion</p> <p>Time Saved: 15 minutes (prep) + 5 minutes (VM creation) = 20 minutes</p>"},{"location":"resumable-builds-design/#scenario-2-configuration-error-at-state-60","title":"Scenario 2: Configuration Error at State 60","text":"<p>Initial Build: - States 0-55: Success (VM built, packages installed) - State 60: FAIL (Ansible configuration error)</p> <p>Resume Flow: 1. Engineer fixes Ansible playbook 2. Manually requests resume via CLI:    <pre><code>bldst build resume build-xyz \\\n  --from-state 60 \\\n  --reason \"Fixed Ansible syntax error\"\n</code></pre> 3. Orchestrator triggers job with resume params 4. Job restores from snapshot at state 55 5. Reruns state 60 with fixed playbook 6. Continues to completion</p> <p>Time Saved: ~40 minutes (all previous states)</p>"},{"location":"resumable-builds-design/#scenario-3-quota-limit-during-ami-registration","title":"Scenario 3: Quota Limit During AMI Registration","text":"<p>Initial Build: - States 0-90: Success (VM fully built and tested) - State 95: FAIL (AWS AMI quota exceeded)</p> <p>Resume Flow: 1. Ops team increases AMI quota 2. Build auto-resumes after 1 hour (configurable) 3. Job gets snapshot from state 90 4. Skips to state 95 (AMI registration) 5. Successfully registers AMI 6. Complete</p> <p>Time Saved: ~60 minutes (entire build except final step)</p>"},{"location":"resumable-builds-design/#success-metrics","title":"\ud83d\udcc8 Success Metrics","text":""},{"location":"resumable-builds-design/#metrics-to-track","title":"Metrics to Track","text":"<ol> <li>Resume Success Rate</li> <li>% of resumes that complete successfully</li> <li> <p>Target: &gt;90%</p> </li> <li> <p>Time Savings</p> </li> <li>Average time saved per resume</li> <li>Total hours saved per month</li> <li> <p>Target: 20+ hours/month</p> </li> <li> <p>Build Recovery Rate</p> </li> <li>% of failed builds successfully resumed</li> <li> <p>Target: &gt;80%</p> </li> <li> <p>Artifact Storage</p> </li> <li>Total storage used for artifacts</li> <li>Storage cost per build</li> <li> <p>Cleanup effectiveness</p> </li> <li> <p>Resume Latency</p> </li> <li>Time from failure to resume trigger</li> <li>Time from resume trigger to job start</li> <li>Target: &lt;5 minutes</li> </ol>"},{"location":"resumable-builds-design/#api-metrics-endpoints","title":"API Metrics Endpoints","text":"<pre><code># Resume statistics\nGET /metrics/resumes/stats\n\n# Time savings\nGET /metrics/resumes/time-saved?period=30d\n\n# Storage usage\nGET /metrics/artifacts/storage-usage\n\n# Success rates\nGET /metrics/builds/resume-success-rate?period=7d\n</code></pre>"},{"location":"resumable-builds-design/#design-decisions-trade-offs","title":"\ud83e\udd14 Design Decisions &amp; Trade-offs","text":""},{"location":"resumable-builds-design/#1-artifact-storage-strategy","title":"1. Artifact Storage Strategy","text":"<p>Decision: Store artifact metadata in database, actual files in cloud storage</p> <p>Rationale: - Database stores paths, checksums, and metadata - Actual artifacts in S3/Azure/GCP for scalability - Deduplication happens at storage layer - Easy to implement cleanup policies</p> <p>Trade-offs: - Additional storage costs - Need to manage lifecycle policies - Network transfer time on resume</p>"},{"location":"resumable-builds-design/#2-state-granularity","title":"2. State Granularity","text":"<p>Decision: Not all states need to be resumable</p> <p>Rationale: - Quick states (&lt;5 min) can just re-run - Focus on long-running states (&gt;10 min) - Reduces artifact storage costs - Simpler resume logic</p> <p>Trade-offs: - Some time wasted re-running quick states - Need clear documentation on which states are resumable</p>"},{"location":"resumable-builds-design/#3-orchestrator-as-separate-service","title":"3. Orchestrator as Separate Service","text":"<p>Decision: Build orchestrator as independent service</p> <p>Rationale: - Can scale independently - Doesn't affect API availability - Can support multiple CI/CD platforms - Easier to deploy in different environments</p> <p>Trade-offs: - Another service to maintain - Additional deployment complexity - Need message queue/webhooks for communication</p>"},{"location":"resumable-builds-design/#4-checksum-verification","title":"4. Checksum Verification","text":"<p>Decision: Store SHA256 checksums for all artifacts</p> <p>Rationale: - Detect corrupted artifacts before resume - Security benefit (detect tampering) - Relatively fast to compute</p> <p>Trade-offs: - CPU cost to calculate checksums - Storage for checksum values - Resume fails if checksum mismatch</p>"},{"location":"resumable-builds-design/#5-variable-storage","title":"5. Variable Storage","text":"<p>Decision: Store all variables in database, not as artifact files</p> <p>Rationale: - Fast access (no file download) - Easy to query and update - Support for sensitive values (encryption) - Version history built-in</p> <p>Trade-offs: - Limited to simple key-value pairs - Large values (&gt;1MB) need special handling - Can't easily restore from file backup</p>"},{"location":"resumable-builds-design/#next-steps","title":"\ud83d\ude80 Next Steps","text":"<ol> <li>Review this design document with team</li> <li>Prioritize use cases (which types of builds benefit most?)</li> <li>Choose initial CI/CD platform (Concourse? Jenkins?)</li> <li>Define resumable states for pilot project</li> <li>Start Phase 1 implementation (database schema)</li> </ol>"},{"location":"resumable-builds-design/#references","title":"\ud83d\udcda References","text":"<ul> <li>FastAPI Documentation</li> <li>Packer Build Artifacts</li> <li>Concourse Resources</li> <li>AWS EC2 Snapshots</li> <li>Azure Managed Disks</li> </ul> <p>Document Version: 1.0 Last Updated: February 14, 2026 Status: Design/Planning Phase Next Review: After team feedback</p>"},{"location":"resumable-builds-quickstart/","title":"Resumable Builds - Quick Start Guide","text":"<p>\ud83d\udca1 Note: Examples below use curl for demonstration. For production pipelines, use the <code>bldst</code> CLI tool for cleaner, more maintainable code.</p>"},{"location":"resumable-builds-quickstart/#whats-implemented","title":"\ud83c\udf89 What's Implemented","text":"<p>The resumable builds system is now live! Here's what you can do:</p>"},{"location":"resumable-builds-quickstart/#completed-features","title":"\u2705 Completed Features","text":"<ol> <li>Database Schema - 5 new tables created:</li> <li><code>build_artifacts</code> - Tracks snapshots, images, and other build outputs</li> <li><code>build_variables</code> - Stores VM IDs, network config, and other context</li> <li><code>resumable_states</code> - Defines which states can be resumed</li> <li><code>resume_requests</code> - Tracks resume operations</li> <li> <p><code>build_jobs</code> - Links to CI/CD job information</p> </li> <li> <p>API Endpoints - 15+ new endpoints:</p> </li> <li>Artifact management (<code>/builds/{id}/artifacts</code>)</li> <li>Variable management (<code>/builds/{id}/variables</code>)</li> <li>Resume context (<code>/builds/{id}/resume-context</code>)</li> <li>Resume requests (<code>/builds/{id}/resume</code>)</li> <li>Resumable state configuration (<code>/projects/{id}/resumable-states</code>)</li> <li> <p>Build job tracking (<code>/builds/{id}/jobs</code>)</p> </li> <li> <p>API Service - Running and accessible at http://localhost:8080</p> </li> </ol>"},{"location":"resumable-builds-quickstart/#quick-test","title":"\ud83d\ude80 Quick Test","text":""},{"location":"resumable-builds-quickstart/#1-view-api-documentation","title":"1. View API Documentation","text":"<p>Open your browser to see the new endpoints: - Swagger UI: http://localhost:8080/docs   - Look for the \"Artifacts\", \"Variables\", and \"Resume\" sections</p>"},{"location":"resumable-builds-quickstart/#2-test-artifact-registration","title":"2. Test Artifact Registration","text":"<pre><code># Register an artifact (replace BUILD_ID with actual build ID)\ncurl -X POST http://localhost:8080/builds/BUILD_ID/artifacts \\\n  -H \"X-API-Key: dev-key-12345\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"state_code\": 20,\n    \"artifact_name\": \"rhel9-snapshot-001\",\n    \"artifact_type\": \"vm_snapshot\",\n    \"artifact_path\": \"s3://my-bucket/snapshots/snapshot-001.vmdk\",\n    \"storage_backend\": \"s3\",\n    \"storage_region\": \"us-east-1\",\n    \"storage_bucket\": \"my-bucket\",\n    \"storage_key\": \"snapshots/snapshot-001.vmdk\",\n    \"is_resumable\": true,\n    \"metadata\": {\n      \"vm_id\": \"i-abc123\",\n      \"snapshot_id\": \"snap-xyz789\"\n    }\n  }'\n</code></pre>"},{"location":"resumable-builds-quickstart/#3-set-build-variables","title":"3. Set Build Variables","text":"<pre><code># Set a build variable\ncurl -X POST http://localhost:8080/builds/BUILD_ID/variables \\\n  -H \"X-API-Key: dev-key-12345\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"variable_key\": \"vm_instance_id\",\n    \"variable_value\": \"i-0123456789abcdef\",\n    \"set_at_state\": 20,\n    \"is_required_for_resume\": true\n  }'\n</code></pre>"},{"location":"resumable-builds-quickstart/#4-get-resume-context","title":"4. Get Resume Context","text":"<pre><code># Get everything needed to resume a build\ncurl -X GET http://localhost:8080/builds/BUILD_ID/resume-context \\\n  -H \"X-API-Key: dev-key-12345\"\n</code></pre> <p>Example response: <pre><code>{\n  \"build_id\": \"build-uuid-456\",\n  \"current_state\": 30,\n  \"last_successful_state\": 30,\n  \"failed_state\": 35,\n  \"resume_from_state\": 35,\n  \"artifacts\": [\n    {\n      \"id\": \"art-123\",\n      \"artifact_name\": \"rhel9-snapshot-001\",\n      \"artifact_type\": \"vm_snapshot\",\n      \"state_code\": 20,\n      \"artifact_path\": \"s3://...\",\n      \"is_resumable\": true,\n      \"metadata\": {\"vm_id\": \"i-abc123\"}\n    }\n  ],\n  \"variables\": {\n    \"vm_instance_id\": \"i-0123456789abcdef\",\n    \"vpc_id\": \"vpc-123456\"\n  },\n  \"resumable_state_config\": null\n}\n</code></pre></p>"},{"location":"resumable-builds-quickstart/#5-request-build-resume","title":"5. Request Build Resume","text":"<pre><code># Request to resume a build\ncurl -X POST http://localhost:8080/builds/BUILD_ID/resume \\\n  -H \"X-API-Key: dev-key-12345\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"resume_from_state\": 35,\n    \"resume_reason\": \"Network timeout during package installation\",\n    \"requested_by\": \"ops-team\"\n  }'\n</code></pre>"},{"location":"resumable-builds-quickstart/#api-endpoint-reference","title":"\ud83d\udccb API Endpoint Reference","text":""},{"location":"resumable-builds-quickstart/#artifacts","title":"Artifacts","text":"Method Endpoint Description POST <code>/builds/{build_id}/artifacts</code> Register a new artifact GET <code>/builds/{build_id}/artifacts</code> List all artifacts (with filters) GET <code>/builds/{build_id}/artifacts/{artifact_id}</code> Get specific artifact PATCH <code>/builds/{build_id}/artifacts/{artifact_id}</code> Update artifact metadata DELETE <code>/builds/{build_id}/artifacts/{artifact_id}</code> Soft delete artifact (admin)"},{"location":"resumable-builds-quickstart/#variables","title":"Variables","text":"Method Endpoint Description POST <code>/builds/{build_id}/variables</code> Set a variable GET <code>/builds/{build_id}/variables</code> List all variables GET <code>/builds/{build_id}/variables/dict</code> Get as key-value dictionary GET <code>/builds/{build_id}/variables/{variable_key}</code> Get specific variable PATCH <code>/builds/{build_id}/variables/{variable_key}</code> Update variable DELETE <code>/builds/{build_id}/variables/{variable_key}</code> Delete variable"},{"location":"resumable-builds-quickstart/#resume-operations","title":"Resume Operations","text":"Method Endpoint Description GET <code>/builds/{build_id}/resume-context</code> Get complete resume context POST <code>/builds/{build_id}/resume</code> Request build resume GET <code>/builds/{build_id}/resume-requests</code> List resume requests GET <code>/resume-requests/{request_id}</code> Get resume request details PATCH <code>/resume-requests/{request_id}</code> Update resume request status"},{"location":"resumable-builds-quickstart/#resumable-state-configuration","title":"Resumable State Configuration","text":"Method Endpoint Description POST <code>/projects/{project_id}/resumable-states</code> Define resumable state GET <code>/projects/{project_id}/resumable-states</code> List resumable states GET <code>/projects/{project_id}/resumable-states/{state_code}</code> Get specific config PUT <code>/projects/{project_id}/resumable-states/{state_code}</code> Update config"},{"location":"resumable-builds-quickstart/#build-jobs","title":"Build Jobs","text":"Method Endpoint Description POST <code>/builds/{build_id}/jobs</code> Link CI/CD job to build GET <code>/builds/{build_id}/jobs</code> List all jobs for build PATCH <code>/builds/{build_id}/jobs/{job_id}</code> Update job status"},{"location":"resumable-builds-quickstart/#authentication","title":"\ud83d\udd10 Authentication","text":"<p>All endpoints require authentication via one of: - API Key: <code>X-API-Key: dev-key-12345</code> (header) - JWT Token: <code>Authorization: Bearer &lt;token&gt;</code> (header)</p> <p>Permission Levels: - Read: View artifacts, variables, resume context - Write: Create/update artifacts, variables, resume requests - Admin: Delete artifacts, manage system config</p> <p>Test Credentials (see CREDENTIALS.md): - <code>dev-key-12345</code> - read + write scopes - <code>admin-key-99999</code> - all scopes</p>"},{"location":"resumable-builds-quickstart/#workflow-integration","title":"\ud83d\udcdd Workflow Integration","text":""},{"location":"resumable-builds-quickstart/#in-your-build-script","title":"In Your Build Script","text":"<pre><code>#!/bin/bash\nBUILD_ID=\"your-build-id\"\nAPI_KEY=\"dev-key-12345\"\nAPI_URL=\"http://localhost:8080\"\n\n# State 20: Install packages (long-running)\necho \"Installing packages...\"\nif ansible-playbook install-packages.yml; then\n  # Success - create snapshot\n  SNAPSHOT_ID=$(aws ec2 create-snapshot ...)\n\n  # Register artifact\n  curl -X POST \"$API_URL/builds/$BUILD_ID/artifacts\" \\\n    -H \"X-API-Key: $API_KEY\" \\\n    -H \"Content-Type: application/json\" \\\n    -d \"{\n      \\\"state_code\\\": 20,\n      \\\"artifact_name\\\": \\\"packages-snapshot\\\",\n      \\\"artifact_type\\\": \\\"ebs_snapshot\\\",\n      \\\"artifact_path\\\": \\\"aws://snapshot/$SNAPSHOT_ID\\\",\n      \\\"storage_backend\\\": \\\"aws\\\",\n      \\\"is_resumable\\\": true,\n      \\\"metadata\\\": {\\\"snapshot_id\\\": \\\"$SNAPSHOT_ID\\\"}\n    }\"\nelse\n  # Failed - log error\n  echo \"Package installation failed\"\n  exit 1\nfi\n</code></pre>"},{"location":"resumable-builds-quickstart/#in-your-resume-script","title":"In Your Resume Script","text":"<pre><code>#!/bin/bash\nBUILD_ID=\"$1\"\nAPI_KEY=\"dev-key-12345\"\nAPI_URL=\"http://localhost:8080\"\n\n# Get resume context\nCONTEXT=$(curl -s -X GET \"$API_URL/builds/$BUILD_ID/resume-context\" \\\n  -H \"X-API-Key: $API_KEY\")\n\n# Extract last snapshot\nSNAPSHOT_ID=$(echo \"$CONTEXT\" | jq -r '.artifacts[] | select(.artifact_type == \"ebs_snapshot\") | .metadata.snapshot_id' | tail -1)\n\n# Restore from snapshot\necho \"Restoring from snapshot: $SNAPSHOT_ID\"\naws ec2 create-volume --snapshot-id \"$SNAPSHOT_ID\" ...\n\n# Continue build from last failed state\nRESUME_FROM=$(echo \"$CONTEXT\" | jq -r '.resume_from_state')\necho \"Resuming from state: $RESUME_FROM\"\n</code></pre>"},{"location":"resumable-builds-quickstart/#next-steps","title":"\ud83c\udfaf Next Steps","text":""},{"location":"resumable-builds-quickstart/#immediate-you-can-do-this-now","title":"Immediate (You can do this now!)","text":"<ol> <li>\u2705 Test the endpoints via Swagger UI (http://localhost:8080/docs)</li> <li>\u2705 Integrate artifact registration into your build scripts</li> <li>\u2705 Set up variable tracking for VM IDs and other context</li> </ol>"},{"location":"resumable-builds-quickstart/#phase-2-future","title":"Phase 2 (Future)","text":"<ol> <li>\u23f3 CLI support (<code>bldst artifact register</code>, <code>bldst build resume</code>, etc.)</li> <li>\u23f3 Orchestrator service for automated resume triggers</li> <li>\u23f3 Webhook integration with Concourse/Jenkins</li> <li>\u23f3 Cleanup jobs for expired artifacts</li> <li>\u23f3 Metrics and dashboards for resume success rates</li> </ol>"},{"location":"resumable-builds-quickstart/#documentation","title":"\ud83d\udcda Documentation","text":"<ul> <li>Design Document: docs/RESUMABLE-BUILDS-DESIGN.md</li> <li>API Reference: http://localhost:8080/docs</li> <li>Main Documentation: docs/INDEX.md</li> <li>Credentials: CREDENTIALS.md</li> </ul>"},{"location":"resumable-builds-quickstart/#troubleshooting","title":"\ud83d\udc1b Troubleshooting","text":""},{"location":"resumable-builds-quickstart/#check-api-status","title":"Check API Status","text":"<pre><code>curl http://localhost:8080/health\n</code></pre>"},{"location":"resumable-builds-quickstart/#view-api-logs","title":"View API Logs","text":"<pre><code>cd api_service/docker\ndocker compose logs api01 --tail=50\n</code></pre>"},{"location":"resumable-builds-quickstart/#verify-database-tables","title":"Verify Database Tables","text":"<pre><code>docker compose exec postgres psql -U buildapi -d builds -c \"\\dt build_*\"\n</code></pre>"},{"location":"resumable-builds-quickstart/#check-endpoints","title":"Check Endpoints","text":"<pre><code>curl -s http://localhost:8080/openapi.json | jq '.paths | keys[]' | grep artifact\n</code></pre>"},{"location":"resumable-builds-quickstart/#summary","title":"\u2728 Summary","text":"<p>You now have a fully functional resumable build system! </p> <p>The foundation is in place for: - Tracking artifacts at each build step - Storing variables needed for resumption - Requesting and managing build resumes - Configuring which states are resumable - Linking builds to CI/CD jobs</p> <p>Start integrating the artifact registration and variable tracking into your build scripts, and you'll be able to resume long-running builds from any point instead of starting over from scratch!</p> <p>Questions? Review the full design document or test the endpoints at http://localhost:8080/docs</p>"},{"location":"api/","title":"Build State API Service","text":"<p>A scalable, containerized FastAPI service for managing multi-cloud IaaS image build states with JWT and API key authentication.</p>"},{"location":"api/#architecture","title":"Architecture","text":"<ul> <li>Horizontal Scaling: Multiple API containers behind Nginx load balancer</li> <li>Authentication: JWT tokens and API keys</li> <li>Database: SQLite (default) or PostgreSQL</li> <li>Caching: Redis for dashboard caching and session management</li> <li>Containerization: Multi-stage Docker builds</li> <li>Load Balancing: Nginx with least-connections algorithm</li> </ul>"},{"location":"api/#features","title":"Features","text":"<ul> <li>\u2705 JWT and API key authentication</li> <li>\u2705 RESTful API for build state management</li> <li>\u2705 Horizontal scaling with multiple containers</li> <li>\u2705 Nginx reverse proxy with load balancing</li> <li>\u2705 Redis caching for performance</li> <li>\u2705 Health checks and monitoring</li> <li>\u2705 SQLite/PostgreSQL support</li> <li>\u2705 Multi-stage Docker builds</li> <li>\u2705 Comprehensive error handling</li> </ul>"},{"location":"api/#quick-start","title":"Quick Start","text":""},{"location":"api/#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker and Docker Compose</li> <li>Git</li> </ul>"},{"location":"api/#1-clone-and-setup","title":"1. Clone and Setup","text":"<pre><code>cd /path/to/your/project\ngit clone &lt;repository-url&gt; api_service\ncd api_service\n\n# Copy environment template\ncp .env.example .env\n\n# Edit environment variables\nnano .env\n</code></pre>"},{"location":"api/#2-build-and-run","title":"2. Build and Run","text":"<pre><code># Build and start all services\ndocker-compose up --build\n\n# Or run in background\ndocker-compose up -d --build\n</code></pre>"},{"location":"api/#3-verify-deployment","title":"3. Verify Deployment","text":"<pre><code># Check if services are running\ndocker-compose ps\n\n# Test API health\ncurl http://localhost:8080/\n\n# Get API documentation\nopen http://localhost:8080/docs\n</code></pre>"},{"location":"api/#api-usage","title":"API Usage","text":""},{"location":"api/#authentication","title":"Authentication","text":"<p>We provide the <code>bldst</code> CLI tool which eliminates the need for complex curl commands. The CLI handles authentication, formatting, and error handling automatically.</p>"},{"location":"api/#install-the-cli","title":"Install the CLI","text":"<pre><code>cd bldst_cli\npip install -e .\n</code></pre>"},{"location":"api/#configure-api-access","title":"Configure API Access","text":"<pre><code># Set the API URL\nbldst config set-url http://localhost:8080\n\n# Set API Key (recommended for automation)\nbldst auth set-key your-api-key\n\n# Or login with username/password (for interactive use)\nbldst auth login\n</code></pre>"},{"location":"api/#verify-configuration","title":"Verify Configuration","text":"<pre><code>bldst config show\nbldst health check\n</code></pre>"},{"location":"api/#core-endpoints","title":"Core Endpoints","text":"<p>Note: All examples below use the <code>bldst</code> CLI. For direct API access, see the API Reference.</p>"},{"location":"api/#create-build","title":"Create Build","text":"<pre><code># Create a new build (returns UUID for tracking)\nbldst build create \\\n  --build-number \"my-build-001\" \\\n  --project-id &lt;project-uuid&gt; \\\n  --platform-id &lt;platform-uuid&gt; \\\n  --os-version-id &lt;os-version-uuid&gt; \\\n  --image-type-id &lt;image-type-uuid&gt; \\\n  --created-by \"jenkins-pipeline\" \\\n  --concourse-url \"https://concourse.example.com/pipelines/my-pipeline\"\n\n# To get UUIDs for reference data:\nbldst platform list\nbldst os-version list\nbldst image-type list\nbldst project list\n</code></pre>"},{"location":"api/#update-build-state","title":"Update Build State","text":"<pre><code># Add a new state to a build (state progression: 0 \u2192 10 \u2192 25 \u2192 50 \u2192 75 \u2192 100)\nbldst build add-state &lt;build-uuid&gt; \\\n  --state 25 \\\n  --status \"Packer build completed successfully\"\n\n# Example state progression:\nbldst build add-state &lt;build-uuid&gt; --state 10 --status \"Starting preparation\"\nbldst build add-state &lt;build-uuid&gt; --state 25 --status \"Packer validation complete\"\nbldst build add-state &lt;build-uuid&gt; --state 50 --status \"Ansible configuration running\"\nbldst build add-state &lt;build-uuid&gt; --state 100 --status \"Build completed successfully\"\n</code></pre>"},{"location":"api/#record-failure","title":"Record Failure","text":"<pre><code># Record a build failure with details\nbldst build add-failure &lt;build-uuid&gt; \\\n  --state 25 \\\n  --type \"PACKER_TIMEOUT\" \\\n  --message \"Packer build failed: AMI creation timeout after 3600 seconds\"\n</code></pre>"},{"location":"api/#get-build-details","title":"Get Build Details","text":"<pre><code># Get complete build information\nbldst build get &lt;build-uuid&gt;\n\n# List recent builds\nbldst build list --limit 20\n</code></pre>"},{"location":"api/#dashboard-monitoring","title":"Dashboard &amp; Monitoring","text":"<pre><code># View comprehensive dashboard summary\nbldst dashboard summary\n\n# View recent builds\nbldst dashboard recent\n\n# Health check\nbldst health check\n</code></pre>"},{"location":"api/#health-and-status-endpoints","title":"Health and Status Endpoints","text":""},{"location":"api/#health-check-cli","title":"Health Check (CLI)","text":"<pre><code># Quick health check\nbldst health check\n\n# Check API readiness (verifies database and Redis connectivity)\nbldst health ready\n\n# Get comprehensive status of all components\nbldst health status\n</code></pre>"},{"location":"api/#health-check-direct-api","title":"Health Check (Direct API)","text":"<p>For monitoring systems that need direct HTTP access: <pre><code># Basic health\ncurl http://localhost:8080/health\n\n# Readiness check (database + Redis)\ncurl http://localhost:8080/ready\n\n# Full status (all components)\ncurl http://localhost:8080/status\n\n# Status server (requires /etc/hosts: 127.0.0.1 status.localbuild.api)\ncurl http://status.localbuild.api/\n</code></pre></p>"},{"location":"api/#concourse-pipeline-integration","title":"Concourse Pipeline Integration","text":"<p>The <code>bldst</code> CLI provides a much cleaner, more maintainable approach for CI/CD pipelines compared to curl commands.</p>"},{"location":"api/#key-benefits","title":"Key Benefits","text":"<ul> <li>\u2705 No more brittle curl commands - Clean, readable syntax</li> <li>\u2705 Built-in error handling - Automatic retry logic and clear error messages</li> <li>\u2705 Automatic authentication - Set once, use everywhere</li> <li>\u2705 Type safety - Validates input before sending to API</li> <li>\u2705 Output parsing - Structured JSON output for pipeline consumption</li> </ul>"},{"location":"api/#prerequisites_1","title":"Prerequisites","text":"<p>Create a Docker image with the CLI pre-installed:</p> <pre><code>FROM python:3.11-slim\n\n# Install bldst CLI\nRUN pip install buildstate-cli\n\n# Or install from source\n# COPY bldst_cli /tmp/bldst_cli\n# RUN cd /tmp/bldst_cli &amp;&amp; pip install -e .\n\nWORKDIR /workspace\n</code></pre>"},{"location":"api/#example-pipeline-task","title":"Example Pipeline Task","text":"<pre><code>jobs:\n- name: build-rhel-image\n  plan:\n  - task: create-build-record\n    config:\n      platform: linux\n      image_resource:\n        type: registry-image\n        source:\n          repository: your-registry/buildstate-cli\n          tag: latest\n      params:\n        BLDST_API_URL: http://build-api.example.com\n        BLDST_API_KEY: ((buildstate-api-key))  # From Concourse secrets\n      outputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n          - -c\n          - |\n            set -e\n\n            # Configure CLI (one time)\n            bldst config set-url ${BLDST_API_URL}\n            bldst auth set-key ${BLDST_API_KEY}\n\n            # Get reference data UUIDs (cache these in your pipeline if needed)\n            PLATFORM_ID=$(bldst platform list --output json | jq -r '.[] | select(.name==\"aws-commercial\") | .id')\n            OS_VERSION_ID=$(bldst os-version list --output json | jq -r '.[] | select(.version==\"rhel-8.8\") | .id')\n            IMAGE_TYPE_ID=$(bldst image-type list --output json | jq -r '.[] | select(.name==\"base\") | .id')\n            PROJECT_ID=$(bldst project list --output json | jq -r '.[] | select(.name==\"platform-images\") | .id')\n\n            # Create build record\n            BUILD_UUID=$(bldst build create \\\n              --build-number \"build-${BUILD_ID}\" \\\n              --project-id ${PROJECT_ID} \\\n              --platform-id ${PLATFORM_ID} \\\n              --os-version-id ${OS_VERSION_ID} \\\n              --image-type-id ${IMAGE_TYPE_ID} \\\n              --created-by \"concourse-${BUILD_PIPELINE_NAME}\" \\\n              --concourse-url \"${ATC_EXTERNAL_URL}/teams/${BUILD_TEAM_NAME}/pipelines/${BUILD_PIPELINE_NAME}\" \\\n              --output json | jq -r '.id')\n\n            echo ${BUILD_UUID} &gt; build-info/uuid.txt\n            echo \"\u2705 Build record created: ${BUILD_UUID}\"\n\n  - task: update-state-preparing\n    config:\n      platform: linux\n      image_resource:\n        type: registry-image\n        source:\n          repository: your-registry/buildstate-cli\n          tag: latest\n      params:\n        BLDST_API_URL: http://build-api.example.com\n        BLDST_API_KEY: ((buildstate-api-key))\n      inputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n          - -c\n          - |\n            set -e\n            bldst config set-url ${BLDST_API_URL}\n            bldst auth set-key ${BLDST_API_KEY}\n\n            BUILD_UUID=$(cat build-info/uuid.txt)\n            bldst build add-state ${BUILD_UUID} --state 10 --status \"Preparing build environment\"\n\n  - task: packer-build\n    config:\n      platform: linux\n      inputs:\n        - name: build-info\n        - name: packer-templates\n      outputs:\n        - name: build-artifacts\n      run:\n        path: sh\n        args:\n          - -c\n          - |\n            set -e\n\n            # Update state before starting\n            BUILD_UUID=$(cat build-info/uuid.txt)\n            bldst build add-state ${BUILD_UUID} --state 25 --status \"Running Packer build\"\n\n            # Run packer\n            packer build -var-file=vars.json packer-templates/template.json\n\n            # Update state on success\n            bldst build add-state ${BUILD_UUID} --state 50 --status \"Packer build completed\"\n    on_failure:\n      task: record-packer-failure\n      config:\n        platform: linux\n        inputs:\n          - name: build-info\n        run:\n          path: sh\n          args:\n            - -c\n            - |\n              BUILD_UUID=$(cat build-info/uuid.txt)\n              bldst build add-failure ${BUILD_UUID} \\\n                --state 25 \\\n                --type \"PACKER_BUILD_FAILED\" \\\n                --message \"Packer build failed - check logs for details\"\n\n  - task: ansible-configure\n    config:\n      platform: linux\n      inputs:\n        - name: build-info\n        - name: ansible-playbooks\n      run:\n        path: sh\n        args:\n          - -c\n          - |\n            set -e\n            BUILD_UUID=$(cat build-info/uuid.txt)\n\n            bldst build add-state ${BUILD_UUID} --state 75 --status \"Running Ansible configuration\"\n\n            ansible-playbook -i inventory ansible-playbooks/configure.yml\n\n            bldst build add-state ${BUILD_UUID} --state 100 --status \"Build completed successfully\"\n\n  - task: check-build-status\n    config:\n      platform: linux\n      inputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n          - -c\n          - |\n            BUILD_UUID=$(cat build-info/uuid.txt)\n\n            # Get full build details\n            bldst build get ${BUILD_UUID}\n\n            # Check dashboard\n            bldst dashboard recent --limit 5\n</code></pre>"},{"location":"api/#simplified-pipeline-with-error-handling","title":"Simplified Pipeline with Error Handling","text":"<pre><code>- task: build-with-tracking\n  config:\n    platform: linux\n    params:\n      BLDST_API_URL: http://build-api.example.com\n      BLDST_API_KEY: ((buildstate-api-key))\n    run:\n      path: bash\n      args:\n        - -c\n        - |\n          set -e\n\n          # Setup\n          bldst config set-url ${BLDST_API_URL}\n          bldst auth set-key ${BLDST_API_KEY}\n\n          # Initialize build tracking\n          BUILD_UUID=$(initialize_build)  # Your function to create build\n\n          # Trap to handle failures\n          trap 'handle_failure ${BUILD_UUID}' ERR\n\n          handle_failure() {\n            local uuid=$1\n            bldst build add-failure ${uuid} \\\n              --state $(get_current_state) \\\n              --type \"PIPELINE_ERROR\" \\\n              --message \"Pipeline failed: ${BASH_COMMAND}\"\n          }\n\n          # Your build steps with state updates\n          bldst build add-state ${BUILD_UUID} --state 10 --status \"Starting\"\n          # ... run your build commands ...\n          bldst build add-state ${BUILD_UUID} --state 100 --status \"Complete\"\n</code></pre>"},{"location":"api/#configuration","title":"Configuration","text":""},{"location":"api/#environment-variables","title":"Environment Variables","text":"Variable Description Default <code>JWT_SECRET_KEY</code> Secret key for JWT tokens Randomly generated <code>API_KEYS</code> Comma-separated API keys dev-key-12345 <code>DATABASE_URL</code> Database connection URL /app/data/builds.db <code>JWT_ACCESS_TOKEN_EXPIRE_MINUTES</code> JWT token expiration 30"},{"location":"api/#scaling","title":"Scaling","text":"<p>To scale the API service:</p> <pre><code># Add more API instances\ndocker-compose up -d --scale api01=2 --scale api02=2 --scale api03=2\n\n# Or use docker-compose scale\ndocker-compose up -d\ndocker-compose up -d --scale api01=3\n</code></pre>"},{"location":"api/#development","title":"Development","text":""},{"location":"api/#local-development","title":"Local Development","text":"<pre><code># Install dependencies\npip install -r requirements.txt\n\n# Run locally\nuvicorn app.main:app --reload\n\n# Run with environment file\nexport $(cat .env | xargs)\nuvicorn app.main:app --reload\n</code></pre>"},{"location":"api/#testing","title":"Testing","text":""},{"location":"api/#automated-api-testing-with-newman","title":"Automated API Testing with Newman","text":"<p>The API includes comprehensive Postman collections for automated testing using Newman:</p> <pre><code># Install Newman (if not already installed)\nnpm install -g newman\n\n# Run all API tests (basic + synthetic transactions)\n./test-api-newman.sh\n\n# Or run individual test suites:\n# Basic API tests\nnewman run --config newman-config.json\n\n# Synthetic transaction tests (real-world scenarios)\nnewman run --config newman-synthetic-config.json\n</code></pre> <p>Test Collections:</p> <ol> <li>Basic API Tests (<code>build-state-api-tests.postman_collection.json</code>)</li> <li>Health checks</li> <li>Authentication (JWT and IDM login)</li> <li>User management (CRUD operations)</li> <li>API token management</li> <li>Build management</li> <li> <p>Dashboard monitoring</p> </li> <li> <p>Synthetic Transactions (<code>build-state-synthetic-transactions.postman_collection.json</code>)</p> </li> <li>User onboarding flow</li> <li>Complete build pipeline simulation</li> <li>Failed build scenario</li> <li>Dashboard monitoring</li> <li>User deactivation flow</li> </ol> <p>Test Results: - Results are saved to JSON files: <code>test-results.json</code> and <code>synthetic-test-results.json</code> - Install <code>jq</code> for formatted results: <code>brew install jq</code></p>"},{"location":"api/#manual-testing","title":"Manual Testing","text":"<pre><code># Run manual API tests\n../../scripts/test-api.sh\n\n# Or run with pytest (if tests are added)\npython -m pytest tests/\n</code></pre>"},{"location":"api/#import-into-postman","title":"Import into Postman","text":"<ol> <li>Open Postman</li> <li>Import the collection files:</li> <li><code>build-state-api-tests.postman_collection.json</code></li> <li><code>build-state-synthetic-transactions.postman_collection.json</code></li> <li>Import the environment file:</li> <li><code>build-state-api-tests.postman_environment.json</code></li> <li>Update the <code>baseUrl</code> variable to match your setup</li> </ol>"},{"location":"api/#database-migration","title":"Database Migration","text":"<p>For PostgreSQL migration:</p> <ol> <li>Uncomment postgres service in <code>docker-compose.yml</code></li> <li>Update <code>DATABASE_URL</code> in <code>.env</code></li> <li>Create <code>init-db.sql</code> with schema</li> <li>Run <code>docker-compose up --build</code></li> </ol>"},{"location":"api/#monitoring","title":"Monitoring","text":""},{"location":"api/#health-checks","title":"Health Checks","text":"<ul> <li>API containers: <code>http://localhost:8000/</code> (per container)</li> <li>Nginx: <code>http://localhost:8080/health</code></li> <li>Load balancer status: Check container logs</li> </ul>"},{"location":"api/#logs","title":"Logs","text":"<pre><code># View all logs\ndocker-compose logs\n\n# View specific service logs\ndocker-compose logs nginx\ndocker-compose logs api01\n\n# Follow logs\ndocker-compose logs -f api01\n</code></pre>"},{"location":"api/#security","title":"Security","text":"<ul> <li>Use strong JWT secrets and API keys</li> <li>Rotate keys regularly</li> <li>Use HTTPS in production</li> <li>Implement proper user management for JWT</li> <li>Monitor for suspicious activity</li> </ul>"},{"location":"api/#production-deployment","title":"Production Deployment","text":"<ol> <li>Use production-grade secrets</li> <li>Configure HTTPS/TLS</li> <li>Set up monitoring and alerting</li> <li>Configure log aggregation</li> <li>Implement backup strategy for database</li> <li>Use managed database service</li> <li>Configure resource limits</li> </ol>"},{"location":"api/#troubleshooting","title":"Troubleshooting","text":""},{"location":"api/#common-issues","title":"Common Issues","text":"<ol> <li>API returns 401: Check authentication headers</li> <li>Database connection failed: Verify DATABASE_URL</li> <li>Nginx 502: Check if API containers are healthy</li> <li>Build state not updating: Verify build UUID</li> </ol>"},{"location":"api/#debug-mode","title":"Debug Mode","text":"<pre><code># Enable debug logging\nexport LOG_LEVEL=debug\ndocker-compose up --build\n</code></pre>"},{"location":"api/#api-documentation","title":"API Documentation","text":""},{"location":"api/#interactive-api-explorer","title":"Interactive API Explorer","text":"<p>Once running, visit <code>http://localhost:8080/docs</code> for interactive Swagger/OpenAPI documentation.</p> <p></p> <p>The interactive documentation provides: - \ud83d\udd0d Complete API reference with all endpoints - \ud83e\uddea Try-it-out functionality to test endpoints directly - \ud83d\udcdd Request/response schemas and examples - \ud83d\udd10 Authentication testing</p>"},{"location":"api/#recommended-usage","title":"Recommended Usage","text":"<p>For CI/CD Pipelines &amp; Automation: Use the <code>bldst</code> CLI tool - Clean, maintainable commands - Built-in error handling and retries - Type-safe operations - See examples throughout this document</p> <p>For Direct API Integration: Use the REST API - See API-REFERENCE.md for complete endpoint documentation - Interactive docs at <code>/docs</code> endpoint - OpenAPI spec at <code>/openapi.json</code></p> <p>For Exploration &amp; Testing: Use the interactive docs - Navigate to <code>http://localhost:8080/docs</code> - Authenticate using your API key or JWT token - Test endpoints directly in your browser</p>"},{"location":"api/api-reference/","title":"Build State API Reference","text":"<p>Complete API Reference for the Build State Management System.</p> <p>\ud83d\udca1 Recommended for Pipelines: Use the <code>bldst</code> CLI tool for cleaner, more maintainable pipeline code. See README.md for CLI examples.</p> <p>This document is the complete API reference for direct HTTP access, testing, and understanding the underlying API structure.</p>"},{"location":"api/api-reference/#base-url","title":"Base URL","text":"<pre><code>http://localhost:8080\n</code></pre> <p>In production, replace with your deployed API URL.</p>"},{"location":"api/api-reference/#authentication","title":"Authentication","text":"<p>All endpoints (except <code>/health</code>, <code>/ready</code>, and <code>/status</code>) require authentication. Two methods are supported:</p>"},{"location":"api/api-reference/#cli-authentication-recommended","title":"CLI Authentication (Recommended)","text":"<pre><code># One-time configuration\nbldst config set-url http://localhost:8080\nbldst auth set-key your-api-key\n\n# Use commands\nbldst platform list\nbldst build create --build-number \"my-build\" ...\n</code></pre>"},{"location":"api/api-reference/#api-key-direct-http-access","title":"API Key (Direct HTTP access)","text":"<pre><code>curl -H \"X-API-Key: your-api-key\" http://localhost:8080/platforms/\n</code></pre>"},{"location":"api/api-reference/#jwt-bearer-token-direct-http-access","title":"JWT Bearer Token (Direct HTTP access)","text":"<pre><code># Get token first\nTOKEN=$(curl -X POST http://localhost:8080/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"username=admin&amp;password=admin123\" | jq -r '.access_token')\n\n# Use token\ncurl -H \"Authorization: Bearer $TOKEN\" http://localhost:8080/platforms/\n</code></pre>"},{"location":"api/api-reference/#authorization-scopes","title":"Authorization Scopes","text":"<ul> <li>read - View resources (GET operations)</li> <li>write - Create and update resources (POST, PUT operations) + read</li> <li>admin - Delete resources (DELETE operations) + write + read</li> </ul>"},{"location":"api/api-reference/#api-endpoints","title":"API Endpoints","text":""},{"location":"api/api-reference/#health-status","title":"Health &amp; Status","text":""},{"location":"api/api-reference/#get-health","title":"GET /health","text":"<p>Check API health status.</p> <p>Authentication: None required</p> <p>Response: <pre><code>{\n  \"status\": \"healthy\",\n  \"timestamp\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-ready","title":"GET /ready","text":"<p>Check if API is ready to accept requests.</p> <p>Authentication: None required</p> <p>Response: <pre><code>{\n  \"ready\": true,\n  \"database\": \"connected\",\n  \"timestamp\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-status","title":"GET /status","text":"<p>Detailed system status including version and uptime.</p> <p>Authentication: None required</p> <p>Response: <pre><code>{\n  \"version\": \"1.0.0\",\n  \"uptime\": 123456,\n  \"status\": \"running\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#authentication_1","title":"Authentication","text":""},{"location":"api/api-reference/#post-token","title":"POST /token","text":"<p>Obtain JWT access token.</p> <p>Authentication: None required (uses form data for credentials)</p> <p>Request: <pre><code>curl -X POST http://localhost:8080/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"username=admin&amp;password=admin123\"\n</code></pre></p> <p>Response: <pre><code>{\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIs...\",\n  \"token_type\": \"bearer\",\n  \"expires_in\": 3600\n}\n</code></pre></p>"},{"location":"api/api-reference/#post-authidm","title":"POST /auth/idm","text":"<p>Alternative authentication endpoint for IDM integration.</p> <p>Authentication: None required</p> <p>Request: <pre><code>{\n  \"username\": \"admin\",\n  \"password\": \"admin123\"\n}\n</code></pre></p> <p>Response: Same as <code>/token</code></p>"},{"location":"api/api-reference/#platforms","title":"Platforms","text":"<p>Manage cloud platforms (AWS, Azure, GCP, etc.).</p>"},{"location":"api/api-reference/#post-platforms","title":"POST /platforms/","text":"<p>Create a new platform.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"aws-us-east-1\",\n  \"cloud_provider\": \"aws\",\n  \"region\": \"us-east-1\"\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"aws-us-east-1\",\n  \"name\": \"aws-us-east-1\",\n  \"cloud_provider\": \"aws\",\n  \"region\": \"us-east-1\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"deactivated_at\": null\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-platforms","title":"GET /platforms/","text":"<p>List all active platforms.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>skip</code> (int, default: 0) - Number of records to skip - <code>limit</code> (int, default: 100) - Maximum records to return - <code>include_deactivated</code> (bool, default: false) - Include soft-deleted platforms</p> <p>Response: <pre><code>[\n  {\n    \"id\": \"aws-commercial\",\n    \"name\": \"AWS Commercial\",\n    \"cloud_provider\": \"aws\",\n    \"region\": \"us-east-1\",\n    \"created_at\": \"2026-02-14T17:30:00Z\",\n    \"deactivated_at\": null\n  }\n]\n</code></pre></p>"},{"location":"api/api-reference/#get-platformsplatform_id","title":"GET /platforms/{platform_id}","text":"<p>Get a specific platform by ID.</p> <p>Authorization: <code>read</code> scope required</p> <p>Response: <pre><code>{\n  \"id\": \"aws-commercial\",\n  \"name\": \"AWS Commercial\",\n  \"cloud_provider\": \"aws\",\n  \"region\": \"us-east-1\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"deactivated_at\": null\n}\n</code></pre></p>"},{"location":"api/api-reference/#put-platformsplatform_id","title":"PUT /platforms/{platform_id}","text":"<p>Update a platform.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"AWS Commercial Updated\",\n  \"region\": \"us-west-2\"\n}\n</code></pre></p> <p>Response: Updated platform object</p>"},{"location":"api/api-reference/#delete-platformsplatform_id","title":"DELETE /platforms/{platform_id}","text":"<p>Soft delete a platform.</p> <p>Authorization: <code>admin</code> scope required</p> <p>Response: 204 No Content</p>"},{"location":"api/api-reference/#os-versions","title":"OS Versions","text":"<p>Manage operating system versions.</p>"},{"location":"api/api-reference/#post-os_versions","title":"POST /os_versions/","text":"<p>Create a new OS version.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"Red Hat Enterprise Linux\",\n  \"version\": \"9.3\"\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"cd515391-01e8-4b34-9004-ad0a32c2fb25\",\n  \"name\": \"Red Hat Enterprise Linux\",\n  \"version\": \"9.3\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"deactivated_at\": null\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-os_versions","title":"GET /os_versions/","text":"<p>List all active OS versions.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>skip</code> (int, default: 0) - <code>limit</code> (int, default: 100) - <code>include_deactivated</code> (bool, default: false)</p> <p>Response: Array of OS version objects</p>"},{"location":"api/api-reference/#get-os_versionsos_version_id","title":"GET /os_versions/{os_version_id}","text":"<p>Get a specific OS version.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#put-os_versionsos_version_id","title":"PUT /os_versions/{os_version_id}","text":"<p>Update an OS version.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"version\": \"9.4\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#delete-os_versionsos_version_id","title":"DELETE /os_versions/{os_version_id}","text":"<p>Soft delete an OS version.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#image-types","title":"Image Types","text":"<p>Manage image types (Base, Database Server, Application Server, etc.).</p>"},{"location":"api/api-reference/#post-image_types","title":"POST /image_types/","text":"<p>Create a new image type.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"kubernetes-node\",\n  \"description\": \"Kubernetes worker node image\"\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"ce74e171-83ce-4390-bb46-e8806908d818\",\n  \"name\": \"kubernetes-node\",\n  \"description\": \"Kubernetes worker node image\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"deactivated_at\": null\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-image_types","title":"GET /image_types/","text":"<p>List all active image types.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>skip</code> (int, default: 0) - <code>limit</code> (int, default: 100) - <code>include_deactivated</code> (bool, default: false)</p>"},{"location":"api/api-reference/#get-image_typesimage_type_id","title":"GET /image_types/{image_type_id}","text":"<p>Get a specific image type.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#put-image_typesimage_type_id","title":"PUT /image_types/{image_type_id}","text":"<p>Update an image type.</p> <p>Authorization: <code>write</code> scope required</p>"},{"location":"api/api-reference/#delete-image_typesimage_type_id","title":"DELETE /image_types/{image_type_id}","text":"<p>Soft delete an image type.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#projects","title":"Projects","text":"<p>Manage build projects.</p>"},{"location":"api/api-reference/#post-projects","title":"POST /projects/","text":"<p>Create a new project.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"rhel-8-base\",\n  \"description\": \"RHEL 8 base image builds\"\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"12345\",\n  \"name\": \"rhel-8-base\",\n  \"description\": \"RHEL 8 base image builds\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"deactivated_at\": null\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-projects","title":"GET /projects/","text":"<p>List all active projects.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#get-projectsproject_id","title":"GET /projects/{project_id}","text":"<p>Get a specific project.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#put-projectsproject_id","title":"PUT /projects/{project_id}","text":"<p>Update a project.</p> <p>Authorization: <code>write</code> scope required</p>"},{"location":"api/api-reference/#delete-projectsproject_id","title":"DELETE /projects/{project_id}","text":"<p>Soft delete a project.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#state-codes","title":"State Codes","text":"<p>Manage state codes within projects.</p>"},{"location":"api/api-reference/#post-projectsproject_idstate-codes","title":"POST /projects/{project_id}/state-codes","text":"<p>Create a state code definition for a project.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"state_code\": 5,\n  \"description\": \"Preparing build environment\",\n  \"is_blocking\": false\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"abc-123\",\n  \"project_id\": \"12345\",\n  \"state_code\": 5,\n  \"description\": \"Preparing build environment\",\n  \"is_blocking\": false,\n  \"created_at\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-projectsproject_idstate-codes","title":"GET /projects/{project_id}/state-codes","text":"<p>List state codes for a project.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#get-projectsproject_idstate-codesstate_code_id","title":"GET /projects/{project_id}/state-codes/{state_code_id}","text":"<p>Get a specific state code.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#put-projectsproject_idstate-codesstate_code_id","title":"PUT /projects/{project_id}/state-codes/{state_code_id}","text":"<p>Update a state code.</p> <p>Authorization: <code>write</code> scope required</p>"},{"location":"api/api-reference/#delete-projectsproject_idstate-codesstate_code_id","title":"DELETE /projects/{project_id}/state-codes/{state_code_id}","text":"<p>Delete a state code.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#builds","title":"Builds","text":"<p>Manage build instances and their states.</p>"},{"location":"api/api-reference/#post-builds","title":"POST /builds","text":"<p>Create a new build.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"project_id\": \"12345\",\n  \"platform_id\": \"aws-commercial\",\n  \"os_version_id\": \"rhel-9.3\",\n  \"image_type_id\": \"base\",\n  \"build_number\": \"2024.02.001\",\n  \"build_metadata\": {\n    \"initiated_by\": \"concourse-pipeline\",\n    \"commit_sha\": \"abc123\"\n  }\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"build-uuid-123\",\n  \"project_id\": \"12345\",\n  \"platform_id\": \"aws-commercial\",\n  \"os_version_id\": \"rhel-9.3\",\n  \"image_type_id\": \"base\",\n  \"build_number\": \"2024.02.001\",\n  \"current_state\": 0,\n  \"status\": \"pending\",\n  \"created_at\": \"2026-02-14T17:30:00Z\",\n  \"updated_at\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#post-buildsbuild_idstate","title":"POST /builds/{build_id}/state","text":"<p>Update build state (progress tracking).</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"state_code\": 15,\n  \"status\": \"in_progress\",\n  \"message\": \"Installing base packages\",\n  \"metadata\": {\n    \"progress_percent\": 30\n  },\n  \"artifact_storage_type\": \"s3\",\n  \"artifact_storage_path\": \"s3://my-builds/project-123/build-456/state-15/base-image.qcow2\",\n  \"artifact_size_bytes\": 2147483648,\n  \"artifact_checksum\": \"sha256:abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"artifact_metadata\": {\n    \"compression\": \"gzip\",\n    \"format\": \"qcow2\"\n  }\n}\n</code></pre></p> <p>Request Fields: - <code>state_code</code> (int, required) - State code number - <code>status</code> (string, required) - Status: pending, in_progress, completed, failed - <code>message</code> (string, optional) - Human-readable status message - <code>metadata</code> (object, optional) - Additional state metadata - <code>artifact_storage_type</code> (string, optional) - Storage type: s3, nfs, ebs, ceph, local, etc. - <code>artifact_storage_path</code> (string, optional) - Full path/URI to stored artifact - <code>artifact_size_bytes</code> (int, optional) - Size of artifact in bytes - <code>artifact_checksum</code> (string, optional) - SHA256 or MD5 checksum for verification - <code>artifact_metadata</code> (object, optional) - Additional artifact metadata</p> <p>Response: <pre><code>{\n  \"build_id\": \"build-uuid-123\",\n  \"state_code\": 15,\n  \"status\": \"in_progress\",\n  \"message\": \"Installing base packages\",\n  \"artifact_storage_type\": \"s3\",\n  \"artifact_storage_path\": \"s3://my-builds/project-123/build-456/state-15/base-image.qcow2\",\n  \"artifact_size_bytes\": 2147483648,\n  \"artifact_checksum\": \"sha256:abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"artifact_metadata\": {\n    \"compression\": \"gzip\",\n    \"format\": \"qcow2\"\n  },\n  \"timestamp\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p> <p>\ud83d\udcd6 For detailed information on artifact storage tracking, see Artifact Storage Tracking.</p>"},{"location":"api/api-reference/#post-buildsbuild_idfailure","title":"POST /builds/{build_id}/failure","text":"<p>Record build failure.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"state_code\": 25,\n  \"error_message\": \"Package installation failed\",\n  \"error_details\": {\n    \"package\": \"httpd\",\n    \"exit_code\": 1\n  },\n  \"is_retryable\": true\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-builds","title":"GET /builds","text":"<p>List all builds.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>skip</code> (int, default: 0) - <code>limit</code> (int, default: 100) - <code>project_id</code> (string, optional) - Filter by project - <code>status</code> (string, optional) - Filter by status (pending, in_progress, completed, failed)</p>"},{"location":"api/api-reference/#get-buildsbuild_id","title":"GET /builds/{build_id}","text":"<p>Get build details.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#get-buildsbuild_idstate","title":"GET /builds/{build_id}/state","text":"<p>Get current state of a build.</p> <p>Authorization: <code>read</code> scope required</p> <p>Response: <pre><code>{\n  \"build_id\": \"build-uuid-123\",\n  \"current_state\": 45,\n  \"status\": \"in_progress\",\n  \"last_updated\": \"2026-02-14T17:30:00Z\",\n  \"history\": [\n    {\n      \"state_code\": 0,\n      \"status\": \"pending\",\n      \"timestamp\": \"2026-02-14T17:00:00Z\"\n    },\n    {\n      \"state_code\": 15,\n      \"status\": \"in_progress\",\n      \"timestamp\": \"2026-02-14T17:15:00Z\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"api/api-reference/#build-artifacts","title":"Build Artifacts","text":"<p>Manage build artifacts for resumable builds. Artifacts represent intermediate or final outputs from build steps (VM snapshots, disk images, AMIs, configuration files, etc.).</p> <p>\ud83d\udcd6 Related Documentation: - Resumable Builds Design - Resumable Builds Quickstart - Artifact Storage Tracking</p>"},{"location":"api/api-reference/#post-buildsbuild_idartifacts","title":"POST /builds/{build_id}/artifacts","text":"<p>Create a new artifact for a build.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"state_code\": 20,\n  \"artifact_name\": \"base-vm-snapshot\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n  \"storage_backend\": \"s3\",\n  \"storage_region\": \"us-east-1\",\n  \"storage_bucket\": \"my-builds\",\n  \"storage_key\": \"project-123/build-456/state-20/snapshot.qcow2\",\n  \"size_bytes\": 2147483648,\n  \"checksum\": \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"checksum_algorithm\": \"sha256\",\n  \"is_resumable\": true,\n  \"is_final\": false,\n  \"metadata\": {\n    \"vm_id\": \"vm-abc123\",\n    \"snapshot_id\": \"snap-xyz789\",\n    \"disk_format\": \"qcow2\",\n    \"compression\": \"none\"\n  }\n}\n</code></pre></p> <p>Request Fields: - <code>state_code</code> (int, required) - State at which this artifact was created - <code>artifact_name</code> (string, required) - Unique name for this artifact within the build - <code>artifact_type</code> (string, required) - Type: vm_snapshot, ami, disk_image, config_file, etc. - <code>artifact_path</code> (string, required) - Full path/URL to the artifact - <code>storage_backend</code> (string, required) - Backend: s3, azure_blob, gcp_storage, local, vsphere, nfs, etc. - <code>storage_region</code> (string, optional) - Storage region - <code>storage_bucket</code> (string, optional) - Bucket or container name - <code>storage_key</code> (string, optional) - Key/path within bucket - <code>size_bytes</code> (int, optional) - Size in bytes - <code>checksum</code> (string, optional) - SHA256 checksum for verification - <code>checksum_algorithm</code> (string, optional, default: \"sha256\") - Checksum algorithm - <code>is_resumable</code> (bool, optional, default: true) - Can this artifact be used to resume? - <code>is_final</code> (bool, optional, default: false) - Is this the final deliverable? - <code>expires_at</code> (datetime, optional) - When to clean up temporary artifacts - <code>metadata</code> (object, optional) - Additional artifact metadata</p> <p>Response (201): <pre><code>{\n  \"id\": \"artifact-uuid-123\",\n  \"build_id\": \"build-uuid-456\",\n  \"state_code\": 20,\n  \"artifact_name\": \"base-vm-snapshot\",\n  \"artifact_type\": \"vm_snapshot\",\n  \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n  \"storage_backend\": \"s3\",\n  \"storage_region\": \"us-east-1\",\n  \"storage_bucket\": \"my-builds\",\n  \"storage_key\": \"project-123/build-456/state-20/snapshot.qcow2\",\n  \"size_bytes\": 2147483648,\n  \"checksum\": \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"checksum_algorithm\": \"sha256\",\n  \"is_resumable\": true,\n  \"is_final\": false,\n  \"metadata\": {\n    \"vm_id\": \"vm-abc123\",\n    \"snapshot_id\": \"snap-xyz789\",\n    \"disk_format\": \"qcow2\",\n    \"compression\": \"none\"\n  },\n  \"created_at\": \"2026-02-16T10:30:00Z\",\n  \"updated_at\": \"2026-02-16T10:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-buildsbuild_idartifacts","title":"GET /builds/{build_id}/artifacts","text":"<p>List artifacts for a build.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>state_code</code> (int, optional) - Filter by state code - <code>artifact_type</code> (string, optional) - Filter by artifact type - <code>is_resumable</code> (bool, optional) - Filter by resumable flag - <code>is_final</code> (bool, optional) - Filter by final flag</p> <p>Response: <pre><code>[\n  {\n    \"id\": \"artifact-uuid-123\",\n    \"build_id\": \"build-uuid-456\",\n    \"state_code\": 20,\n    \"artifact_name\": \"base-vm-snapshot\",\n    \"artifact_type\": \"vm_snapshot\",\n    \"artifact_path\": \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\",\n    \"storage_backend\": \"s3\",\n    \"size_bytes\": 2147483648,\n    \"checksum\": \"abcdef0123...\",\n    \"is_resumable\": true,\n    \"is_final\": false,\n    \"created_at\": \"2026-02-16T10:30:00Z\"\n  }\n]\n</code></pre></p>"},{"location":"api/api-reference/#get-buildsbuild_idartifactsartifact_id","title":"GET /builds/{build_id}/artifacts/{artifact_id}","text":"<p>Get details of a specific artifact.</p> <p>Authorization: <code>read</code> scope required</p> <p>Response: Same as single artifact in list response</p>"},{"location":"api/api-reference/#patch-buildsbuild_idartifactsartifact_id","title":"PATCH /builds/{build_id}/artifacts/{artifact_id}","text":"<p>Update artifact metadata.</p> <p>Authorization: <code>write</code> scope required</p> <p>Request: <pre><code>{\n  \"is_final\": true,\n  \"metadata\": {\n    \"ami_id\": \"ami-12345678\",\n    \"verified\": true\n  }\n}\n</code></pre></p> <p>Response: Updated artifact object</p>"},{"location":"api/api-reference/#delete-buildsbuild_idartifactsartifact_id","title":"DELETE /builds/{build_id}/artifacts/{artifact_id}","text":"<p>Soft delete an artifact (preserves record with deleted_at timestamp).</p> <p>Authorization: <code>admin</code> scope required</p> <p>Response: 204 No Content</p> <p>\u26a0\ufe0f Note: This soft deletes the artifact record in the database for audit purposes. The actual artifact file in storage is NOT deleted.</p>"},{"location":"api/api-reference/#dashboard","title":"Dashboard","text":"<p>Aggregate views and statistics.</p>"},{"location":"api/api-reference/#get-dashboardsummary","title":"GET /dashboard/summary","text":"<p>Get dashboard summary with statistics.</p> <p>Authorization: <code>read</code> scope required</p> <p>Response: <pre><code>{\n  \"total_builds\": 150,\n  \"active_builds\": 12,\n  \"completed_builds\": 130,\n  \"failed_builds\": 8,\n  \"platforms\": 5,\n  \"projects\": 8\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-dashboardrecent","title":"GET /dashboard/recent","text":"<p>Get recent builds.</p> <p>Authorization: <code>read</code> scope required</p> <p>Query Parameters: - <code>limit</code> (int, default: 10)</p>"},{"location":"api/api-reference/#get-dashboardplatformplatform_id","title":"GET /dashboard/platform/{platform_id}","text":"<p>Get statistics for a specific platform.</p> <p>Authorization: <code>read</code> scope required</p>"},{"location":"api/api-reference/#users","title":"Users","text":"<p>Manage user accounts and API tokens.</p>"},{"location":"api/api-reference/#post-users","title":"POST /users","text":"<p>Create a new user.</p> <p>Authorization: <code>admin</code> scope required</p> <p>Request: <pre><code>{\n  \"username\": \"newuser\",\n  \"email\": \"user@example.com\",\n  \"password\": \"secure-password\",\n  \"scopes\": [\"read\", \"write\"]\n}\n</code></pre></p> <p>Response (201): <pre><code>{\n  \"id\": \"user-uuid-123\",\n  \"username\": \"newuser\",\n  \"email\": \"user@example.com\",\n  \"scopes\": [\"read\", \"write\"],\n  \"is_active\": true,\n  \"created_at\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-users","title":"GET /users","text":"<p>List all users.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#get-usersme","title":"GET /users/me","text":"<p>Get current authenticated user.</p> <p>Authorization: Any valid authentication</p>"},{"location":"api/api-reference/#get-usersuser_id","title":"GET /users/{user_id}","text":"<p>Get specific user.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#put-usersuser_id","title":"PUT /users/{user_id}","text":"<p>Update user.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#delete-usersuser_id","title":"DELETE /users/{user_id}","text":"<p>Delete user.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#post-usersuser_idtokens","title":"POST /users/{user_id}/tokens","text":"<p>Create API token for user.</p> <p>Authorization: <code>admin</code> scope required</p> <p>Request: <pre><code>{\n  \"name\": \"Pipeline Token\",\n  \"scopes\": [\"read\", \"write\"],\n  \"expires_in_days\": 365\n}\n</code></pre></p> <p>Response: <pre><code>{\n  \"token\": \"dev-key-12345\",\n  \"name\": \"Pipeline Token\",\n  \"scopes\": [\"read\", \"write\"],\n  \"expires_at\": \"2027-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/api-reference/#get-usersuser_idtokens","title":"GET /users/{user_id}/tokens","text":"<p>List user's API tokens.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#delete-usersuser_idtokenstoken_id","title":"DELETE /users/{user_id}/tokens/{token_id}","text":"<p>Revoke API token.</p> <p>Authorization: <code>admin</code> scope required</p>"},{"location":"api/api-reference/#error-responses","title":"Error Responses","text":"<p>All errors follow this format:</p> <pre><code>{\n  \"detail\": \"Error message description\"\n}\n</code></pre>"},{"location":"api/api-reference/#http-status-codes","title":"HTTP Status Codes","text":"<ul> <li>200 - Success</li> <li>201 - Created</li> <li>204 - No Content (successful deletion)</li> <li>400 - Bad Request (validation error)</li> <li>401 - Unauthorized (authentication required)</li> <li>403 - Forbidden (insufficient permissions)</li> <li>404 - Not Found</li> <li>409 - Conflict (duplicate resource)</li> <li>422 - Unprocessable Entity (schema validation failed)</li> <li>500 - Internal Server Error</li> </ul>"},{"location":"api/api-reference/#common-error-scenarios","title":"Common Error Scenarios","text":"<p>Missing Authentication: <pre><code>{\n  \"detail\": \"Authentication required. Use Bearer token or X-API-Key.\"\n}\n</code></pre></p> <p>Insufficient Permissions: <pre><code>{\n  \"detail\": \"Admin permission required\"\n}\n</code></pre></p> <p>Resource Not Found: <pre><code>{\n  \"detail\": \"Platform with id 'unknown-platform' not found\"\n}\n</code></pre></p> <p>Validation Error: <pre><code>{\n  \"detail\": [\n    {\n      \"loc\": [\"body\", \"name\"],\n      \"msg\": \"field required\",\n      \"type\": \"value_error.missing\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"api/api-reference/#rate-limiting","title":"Rate Limiting","text":"<p>Currently not implemented. For production deployments, consider implementing rate limiting at the nginx level.</p>"},{"location":"api/api-reference/#pagination","title":"Pagination","text":"<p>List endpoints support pagination via <code>skip</code> and <code>limit</code> query parameters:</p> <pre><code># Get second page of 50 results\ncurl http://localhost:8080/platforms/?skip=50&amp;limit=50\n</code></pre>"},{"location":"api/api-reference/#filtering","title":"Filtering","text":"<p>Some endpoints support filtering via query parameters. See individual endpoint documentation for available filters.</p>"},{"location":"api/api-reference/#interactive-api-documentation","title":"Interactive API Documentation","text":"<p>FastAPI provides automatic interactive API documentation:</p> <ul> <li>Swagger UI: http://localhost:8080/docs</li> <li>ReDoc: http://localhost:8080/redoc</li> </ul> <p>These interfaces allow you to: - Browse all endpoints - View request/response schemas - Test API calls directly in the browser - Download OpenAPI specification</p>"},{"location":"api/api-reference/#example-workflows","title":"Example Workflows","text":""},{"location":"api/api-reference/#complete-build-workflow","title":"Complete Build Workflow","text":"<pre><code># 1. Authenticate\nexport API_KEY=\"dev-key-12345\"\nexport API_URL=\"http://localhost:8080\"\n\n# 2. Create project\nPROJECT_ID=$(curl -s -X POST \"$API_URL/projects/\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"name\": \"rhel-9-base\", \"description\": \"RHEL 9 base images\"}' \\\n  | jq -r '.id')\n\n# 3. Create build\nBUILD_ID=$(curl -s -X POST \"$API_URL/builds\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\n    \\\"project_id\\\": \\\"$PROJECT_ID\\\",\n    \\\"platform_id\\\": \\\"aws-commercial\\\",\n    \\\"os_version_id\\\": \\\"rhel-9.3\\\",\n    \\\"image_type_id\\\": \\\"base\\\",\n    \\\"build_number\\\": \\\"2024.02.001\\\"\n  }\" | jq -r '.id')\n\n# 4. Update state as build progresses\ncurl -X POST \"$API_URL/builds/$BUILD_ID/state\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"state_code\": 5, \"status\": \"in_progress\", \"message\": \"Starting build\"}'\n\ncurl -X POST \"$API_URL/builds/$BUILD_ID/state\" \\\n  -H \"X-API-Key: $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"state_code\": 25, \"status\": \"in_progress\", \"message\": \"Installing packages\"}'\n\n# 5. Check build status\ncurl -s \"$API_URL/builds/$BUILD_ID/state\" \\\n  -H \"X-API-Key: $API_KEY\" | jq\n</code></pre>"},{"location":"api/api-reference/#query-and-filter","title":"Query and Filter","text":"<pre><code># List builds for specific project\ncurl -s \"$API_URL/builds?project_id=$PROJECT_ID\" \\\n  -H \"X-API-Key: $API_KEY\" | jq\n\n# List only failed builds\ncurl -s \"$API_URL/builds?status=failed\" \\\n  -H \"X-API-Key: $API_KEY\" | jq\n\n# Get dashboard summary\ncurl -s \"$API_URL/dashboard/summary\" \\\n  -H \"X-API-Key: $API_KEY\" | jq\n</code></pre>"},{"location":"api/api-reference/#additional-resources","title":"Additional Resources","text":"<ul> <li>Authentication Guide</li> <li>Deployment Guide</li> <li>Architecture Overview</li> <li>CLI Documentation</li> </ul>"},{"location":"api/architecture/","title":"Build State API Service - Architecture Overview","text":"<p>\ud83d\udca1 Recommended: For pipeline integration, use the <code>bldst</code> CLI tool instead of direct API calls. See README.md for CLI examples.</p>"},{"location":"api/architecture/#overview","title":"Overview","text":"<p>This implementation provides a scalable, containerized FastAPI service for managing multi-cloud IaaS image build states with JWT and API key authentication, designed specifically for integration with Concourse CI pipelines.</p>"},{"location":"api/architecture/#architecture-components","title":"Architecture Components","text":""},{"location":"api/architecture/#1-horizontal-scaling-with-docker-containers","title":"1. Horizontal Scaling with Docker Containers","text":"<ul> <li>3 API service instances (<code>api01</code>, <code>api02</code>, <code>api03</code>) running FastAPI with Uvicorn</li> <li>Nginx reverse proxy for load balancing using least-connections algorithm</li> <li>Shared volume for SQLite database persistence across containers</li> <li>Health checks for automatic container recovery</li> </ul>"},{"location":"api/architecture/#2-authentication-security","title":"2. Authentication &amp; Security","text":"<ul> <li>JWT tokens for session-based authentication</li> <li>API keys for pipeline integration (no SQL credentials needed)</li> <li>Bearer token authentication with automatic validation</li> <li>Security headers in Nginx configuration</li> </ul>"},{"location":"api/architecture/#3-multi-stage-docker-builds","title":"3. Multi-Stage Docker Builds","text":"<ul> <li>Builder stage: Installs Python dependencies in virtual environment</li> <li>Runtime stage: Minimal Python image with compiled dependencies</li> <li>Security: Non-root user, minimal attack surface</li> <li>Performance: Optimized layer caching and smaller final images</li> </ul>"},{"location":"api/architecture/#4-database-layer","title":"4. Database Layer","text":"<ul> <li>SQLite default: File-based, zero-configuration, ACID compliant</li> <li>PostgreSQL support: Production-ready with connection pooling</li> <li>Schema: Normalized tables for platforms, OS versions, image types, builds, states, failures</li> <li>Migrations: Automatic schema initialization on startup</li> </ul>"},{"location":"api/architecture/#key-features","title":"Key Features","text":""},{"location":"api/architecture/#horizontal-scalability","title":"\u2705 Horizontal Scalability","text":"<ul> <li>Multiple API containers behind load balancer</li> <li>Automatic health checking and failover</li> <li>Shared database with proper locking</li> <li>Easy scaling with <code>docker-compose up --scale</code></li> </ul>"},{"location":"api/architecture/#pipeline-friendly-authentication","title":"\u2705 Pipeline-Friendly Authentication","text":"<pre><code># No SQL credentials in pipelines!\ncurl -H \"X-API-Key: your-key\" \\\n  http://api.example.com/builds/my-build/state\n</code></pre>"},{"location":"api/architecture/#jwt-authentication-for-uiadmin-access","title":"\u2705 JWT Authentication for UI/Admin Access","text":"<pre><code># Get token\nTOKEN=$(curl -X POST /token -d '{\"username\":\"user\",\"password\":\"pass\"}' | jq -r .access_token)\n\n# Use token\ncurl -H \"Authorization: Bearer $TOKEN\" /dashboard/summary\n</code></pre>"},{"location":"api/architecture/#comprehensive-state-management","title":"\u2705 Comprehensive State Management","text":"<ul> <li>State codes: 0-100 (increments of 5)</li> <li>Failure handling: Stay at failed state until manually reset</li> <li>Build lifecycle tracking with timestamps</li> <li>Platform-specific build organization</li> </ul>"},{"location":"api/architecture/#production-ready-features","title":"\u2705 Production-Ready Features","text":"<ul> <li>Health checks and monitoring endpoints</li> <li>Structured logging and error handling</li> <li>CORS support for future web UI</li> <li>Environment-based configuration</li> <li>Docker Compose orchestration</li> </ul>"},{"location":"api/architecture/#file-structure","title":"File Structure","text":"<pre><code>api_service/\n\u251c\u2500\u2500 app/\n\u2502   \u2514\u2500\u2500 main.py              # FastAPI application with auth &amp; endpoints\n\u251c\u2500\u2500 nginx/\n\u2502   \u2514\u2500\u2500 nginx.conf           # Load balancer configuration\n\u251c\u2500\u2500 Dockerfile               # Multi-stage API container build\n\u251c\u2500\u2500 nginx.Dockerfile         # Nginx container build\n\u251c\u2500\u2500 docker-compose.yml       # Service orchestration\n\u251c\u2500\u2500 requirements.txt         # Python dependencies\n\u251c\u2500\u2500 .env.example            # Environment template\n\u251c\u2500\u2500 scripts/\n\u2502   \u251c\u2500\u2500 test-api.sh         # Comprehensive test suite\n\u2502   \u251c\u2500\u2500 test-cli-api.sh     # CLI integration tests\n\u2502   \u251c\u2500\u2500 version.sh          # Version management\n\u2502   \u2514\u2500\u2500 gh-actions-status.sh # GitHub Actions monitor\n\u251c\u2500\u2500 init-db.sql             # PostgreSQL schema (optional)\n\u251c\u2500\u2500 Makefile                # Development commands\n\u251c\u2500\u2500 README.md               # Complete documentation\n\u2514\u2500\u2500 .dockerignore           # Docker build optimization\n</code></pre>"},{"location":"api/architecture/#concourse-pipeline-integration","title":"Concourse Pipeline Integration","text":""},{"location":"api/architecture/#recommended-using-the-bldst-cli","title":"Recommended: Using the bldst CLI","text":"<pre><code>jobs:\n- name: build-image\n  plan:\n  - task: init-build\n    config:\n      platform: linux\n      image_resource:\n        type: registry-image\n        source: {repository: your-registry/buildstate-cli}\n      params:\n        BLDST_API_URL: ((build-api-url))\n        BLDST_API_KEY: ((build-api-key))\n      outputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          # Configure CLI\n          bldst config set-url ${BLDST_API_URL}\n          bldst auth set-key ${BLDST_API_KEY}\n\n          # Get reference IDs (cache these if needed)\n          PLATFORM_ID=$(bldst platform list --output json | jq -r '.[] | select(.name==\"aws-commercial\") | .id')\n          OS_VERSION_ID=$(bldst os-version list --output json | jq -r '.[] | select(.version==\"rhel-8.8\") | .id')\n          IMAGE_TYPE_ID=$(bldst image-type list --output json | jq -r '.[] | select(.name==\"base\") | .id')\n          PROJECT_ID=$(bldst project list --output json | jq -r '.[] | select(.name==\"platform\") | .id')\n\n          # Create build\n          BUILD_UUID=$(bldst build create \\\n            --build-number \"rhel-8.8-$(date +%s)\" \\\n            --project-id ${PROJECT_ID} \\\n            --platform-id ${PLATFORM_ID} \\\n            --os-version-id ${OS_VERSION_ID} \\\n            --image-type-id ${IMAGE_TYPE_ID} \\\n            --output json | jq -r '.id')\n\n          echo ${BUILD_UUID} &gt; build-info/uuid.txt\n\n  - task: packer-build\n    config:\n      inputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-info/uuid.txt)\n\n          # Update state\n          bldst build add-state ${BUILD_UUID} --state 10 --status \"Starting Packer build\"\n\n          # Run packer\n          packer build -var-file=vars.json template.json\n\n          # Update on success\n          bldst build add-state ${BUILD_UUID} --state 25 --status \"Packer build completed\"\n\n  - task: ansible-configure\n    config:\n      inputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-info/uuid.txt)\n\n          bldst build add-state ${BUILD_UUID} --state 50 --status \"Starting Ansible configuration\"\n          ansible-playbook -i inventory playbook.yml\n          bldst build add-state ${BUILD_UUID} --state 75 --status \"Ansible configuration completed\"\n\n  - task: finalize-build\n    config:\n      inputs:\n        - name: build-info\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-info/uuid.txt)\n          bldst build add-state ${BUILD_UUID} --state 100 --status \"Build completed successfully\"\n\n  on_failure:\n    do:\n    - task: record-failure\n      config:\n        inputs:\n          - name: build-info\n        run:\n          path: sh\n          args:\n          - -c\n          - |\n            BUILD_UUID=$(cat build-info/uuid.txt)\n            bldst build add-failure ${BUILD_UUID} \\\n              --state 25 \\\n              --type \"PIPELINE_FAILURE\" \\\n              --message \"Pipeline failed at stage: ${FAILED_JOB}\"\n</code></pre>"},{"location":"api/architecture/#alternative-direct-api-with-curl","title":"Alternative: Direct API with curl","text":"<p>For environments where the CLI cannot be installed, see the full curl examples in the README.md (legacy approach).</p>"},{"location":"api/architecture/#deployment-options","title":"Deployment Options","text":""},{"location":"api/architecture/#development","title":"Development","text":"<pre><code>make dev-cycle  # Clean, build, run, test\n</code></pre>"},{"location":"api/architecture/#production","title":"Production","text":"<pre><code># Set environment variables\ncp .env.example .env\nnano .env  # Configure secrets\n\n# Deploy\nmake build\nmake up\nmake health\n</code></pre>"},{"location":"api/architecture/#scaling","title":"Scaling","text":"<pre><code># Scale to 6 API instances\nmake scale-up\n\n# Check distribution\nmake ps\n</code></pre>"},{"location":"api/architecture/#security-considerations","title":"Security Considerations","text":"<ol> <li>API Keys: Use strong, rotated keys for pipeline authentication</li> <li>JWT Secrets: Use cryptographically secure secrets in production</li> <li>Network Security: Configure firewall rules for API access</li> <li>HTTPS: Implement TLS termination in production</li> <li>Monitoring: Log authentication failures and suspicious activity</li> <li>Database: Encrypt sensitive data at rest</li> </ol>"},{"location":"api/architecture/#monitoring-observability","title":"Monitoring &amp; Observability","text":"<ul> <li>Health Endpoints: <code>/health</code>, <code>/</code> for container health</li> <li>Metrics: Ready for Prometheus integration</li> <li>Logs: Structured logging with request IDs</li> <li>Dashboard: API provides build status summaries</li> <li>Load Balancing: Nginx status monitoring</li> </ul>"},{"location":"api/architecture/#future-enhancements","title":"Future Enhancements","text":"<ul> <li>Web UI: React dashboard for build monitoring</li> <li>Webhooks: Real-time notifications for state changes</li> <li>Metrics: Prometheus/Grafana integration</li> <li>Caching: Redis for API response caching</li> <li>Rate Limiting: Request throttling per API key</li> <li>Audit Logging: Complete audit trail for compliance</li> </ul> <p>This architecture provides a robust, scalable foundation for managing complex multi-cloud image build pipelines while maintaining security and observability.</p>"},{"location":"api/authentication/","title":"Authentication &amp; Authorization Guide","text":"<p>Complete guide to authentication and authorization in the Build State API.</p> <p>\ud83d\udca1 CLI Users: The <code>bldst</code> CLI handles authentication automatically. Simply configure once: <pre><code>bldst config set-url http://localhost:8080\nbldst auth set-key your-api-key    # Or: bldst auth login\n</code></pre> See the CLI README for details.</p>"},{"location":"api/authentication/#overview","title":"Overview","text":"<p>The Build State API supports two authentication methods: 1. API Keys - Recommended for automation, scripts, and CI/CD pipelines 2. JWT Tokens - Recommended for interactive use and web applications</p> <p>Both methods support scope-based authorization (read, write, admin).</p>"},{"location":"api/authentication/#authentication-methods","title":"Authentication Methods","text":""},{"location":"api/authentication/#api-key-authentication","title":"API Key Authentication","text":"<p>API keys are static tokens ideal for service-to-service communication and automation.</p> <p>CLI Usage (Recommended): <pre><code># Configure once\nbldst auth set-key your-api-key\n\n# Use commands - authentication is automatic\nbldst platform list\nbldst build create ...\n</code></pre></p> <p>Direct HTTP Usage: <pre><code>curl -H \"X-API-Key: your-api-key\" http://localhost:8080/platforms/\n</code></pre></p> <p>Advantages: - Simple to use - No expiration (unless manually revoked) - Perfect for CI/CD pipelines - No need to manage username/password</p> <p>Security Considerations: - Store API keys securely (environment variables, secret managers) - Never commit API keys to version control - Rotate keys periodically - Use separate keys for different environments</p>"},{"location":"api/authentication/#jwt-token-authentication","title":"JWT Token Authentication","text":"<p>JWT (JSON Web Tokens) provide time-limited authentication ideal for user sessions.</p> <p>Obtaining a Token: <pre><code>curl -X POST http://localhost:8080/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"username=admin&amp;password=admin123\"\n</code></pre></p> <p>Response: <pre><code>{\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"token_type\": \"bearer\",\n  \"expires_in\": 3600\n}\n</code></pre></p> <p>Using the Token: <pre><code>curl -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\" \\\n  http://localhost:8080/platforms/\n</code></pre></p> <p>Advantages: - Time-limited (expires after 1 hour by default) - Can be refreshed - Includes user identity claims - Better audit trail</p> <p>Token Expiration: - Default: 3600 seconds (1 hour) - After expiration, request a new token - CLI automatically handles re-authentication</p>"},{"location":"api/authentication/#authorization-scopes","title":"Authorization Scopes","text":"<p>The API uses scope-based authorization with three permission levels:</p>"},{"location":"api/authentication/#1-read-scope","title":"1. Read Scope","text":"<p>Permissions: - View all resources (GET operations) - List platforms, OS versions, image types, projects, builds - View dashboard and statistics - Check health and status</p> <p>Example Operations: <pre><code># \u2713 Allowed\nGET /platforms/\nGET /os_versions/\nGET /builds/{build_id}\nGET /dashboard/summary\n\n# \u2717 Denied\nPOST /platforms/     # Needs write scope\nDELETE /builds/123   # Needs admin scope\n</code></pre></p>"},{"location":"api/authentication/#2-write-scope","title":"2. Write Scope","text":"<p>Permissions: - All read permissions - Create resources (POST) - Update resources (PUT/PATCH) - Record build states and failures</p> <p>Example Operations: <pre><code># \u2713 Allowed\nGET /platforms/                    # Read permission\nPOST /platforms/                   # Write permission\nPUT /platforms/aws-commercial      # Write permission\nPOST /builds/{id}/state           # Write permission\n\n# \u2717 Denied\nDELETE /platforms/aws-commercial   # Needs admin scope\n</code></pre></p>"},{"location":"api/authentication/#3-admin-scope","title":"3. Admin Scope","text":"<p>Permissions: - All write permissions - All read permissions - Delete resources (soft delete) - User management - API token management</p> <p>Example Operations: <pre><code># \u2713 Allowed (everything)\nGET /platforms/\nPOST /platforms/\nPUT /platforms/{id}\nDELETE /platforms/{id}\nPOST /users\nDELETE /users/{id}\n</code></pre></p>"},{"location":"api/authentication/#test-api-keys","title":"Test API Keys","text":"<p>Three test keys are pre-configured for development:</p>"},{"location":"api/authentication/#read-only-key","title":"Read-Only Key","text":"<p><pre><code>readonly-key-888\n</code></pre> Scopes: <code>read</code> Use for: Monitoring, dashboards, read-only scripts</p>"},{"location":"api/authentication/#development-key","title":"Development Key","text":"<p><pre><code>dev-key-12345\n</code></pre> Scopes: <code>read</code>, <code>write</code> Use for: Development, build pipelines, automation</p>"},{"location":"api/authentication/#admin-key","title":"Admin Key","text":"<p><pre><code>admin-key-99999\n</code></pre> Scopes: <code>read</code>, <code>write</code>, <code>admin</code> Use for: Administrative tasks, maintenance, cleanup</p>"},{"location":"api/authentication/#default-users","title":"Default Users","text":"<p>Development environment includes default users:</p>"},{"location":"api/authentication/#admin-user","title":"Admin User","text":"<ul> <li>Username: <code>admin</code></li> <li>Password: <code>admin123</code></li> <li>Scopes: <code>read</code>, <code>write</code>, <code>admin</code></li> </ul>"},{"location":"api/authentication/#regular-user","title":"Regular User","text":"<ul> <li>Username: <code>user</code></li> <li>Password: <code>user123</code></li> <li>Scopes: <code>read</code>, <code>write</code></li> </ul>"},{"location":"api/authentication/#read-only-user","title":"Read-Only User","text":"<ul> <li>Username: <code>readonly</code></li> <li>Password: <code>readonly123</code></li> <li>Scopes: <code>read</code></li> </ul> <p>\u26a0\ufe0f Change these credentials in production!</p>"},{"location":"api/authentication/#managing-api-keys","title":"Managing API Keys","text":""},{"location":"api/authentication/#creating-api-keys","title":"Creating API Keys","text":"<p>API keys can be created via the API (requires admin scope):</p> <pre><code>curl -X POST http://localhost:8080/users/{user_id}/tokens \\\n  -H \"X-API-Key: admin-key-99999\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"name\": \"Pipeline Token\",\n    \"scopes\": [\"read\", \"write\"],\n    \"expires_in_days\": 365\n  }'\n</code></pre> <p>Response: <pre><code>{\n  \"token\": \"new-key-abc123def456\",\n  \"name\": \"Pipeline Token\",\n  \"scopes\": [\"read\", \"write\"],\n  \"expires_at\": \"2027-02-14T17:30:00Z\",\n  \"created_at\": \"2026-02-14T17:30:00Z\"\n}\n</code></pre></p>"},{"location":"api/authentication/#listing-api-keys","title":"Listing API Keys","text":"<pre><code>curl http://localhost:8080/users/{user_id}/tokens \\\n  -H \"X-API-Key: admin-key-99999\"\n</code></pre>"},{"location":"api/authentication/#revoking-api-keys","title":"Revoking API Keys","text":"<pre><code>curl -X DELETE http://localhost:8080/users/{user_id}/tokens/{token_id} \\\n  -H \"X-API-Key: admin-key-99999\"\n</code></pre>"},{"location":"api/authentication/#integration-examples","title":"Integration Examples","text":""},{"location":"api/authentication/#concourse-ci-pipeline","title":"Concourse CI Pipeline","text":"<pre><code>resources:\n  - name: buildstate-api\n    type: http-api\n    source:\n      uri: http://api.example.com\n      headers:\n        X-API-Key: ((buildstate-api-key))\n\njobs:\n  - name: build-image\n    plan:\n      - task: create-build\n        config:\n          platform: linux\n          run:\n            path: /bin/bash\n            args:\n              - -c\n              - |\n                # Create build\n                BUILD_ID=$(curl -X POST http://api.example.com/builds \\\n                  -H \"X-API-Key: $API_KEY\" \\\n                  -H \"Content-Type: application/json\" \\\n                  -d '{\"project_id\": \"rhel-9\", \"platform_id\": \"aws\"}' \\\n                  | jq -r '.id')\n\n                # Update state\n                curl -X POST http://api.example.com/builds/$BUILD_ID/state \\\n                  -H \"X-API-Key: $API_KEY\" \\\n                  -H \"Content-Type: application/json\" \\\n                  -d '{\"state_code\": 5, \"status\": \"in_progress\"}'\n        params:\n          API_KEY: ((buildstate-api-key))\n</code></pre>"},{"location":"api/authentication/#python-script","title":"Python Script","text":"<pre><code>import os\nimport requests\n\nAPI_URL = os.getenv(\"BUILDSTATE_API_URL\", \"http://localhost:8080\")\nAPI_KEY = os.getenv(\"BUILDSTATE_API_KEY\")\n\nheaders = {\n    \"X-API-Key\": API_KEY,\n    \"Content-Type\": \"application/json\"\n}\n\n# List platforms\nresponse = requests.get(f\"{API_URL}/platforms/\", headers=headers)\nplatforms = response.json()\n\n# Create build\nbuild_data = {\n    \"project_id\": \"rhel-9\",\n    \"platform_id\": \"aws-commercial\",\n    \"os_version_id\": \"rhel-9.3\",\n    \"image_type_id\": \"base\",\n    \"build_number\": \"2024.02.001\"\n}\nresponse = requests.post(f\"{API_URL}/builds\", headers=headers, json=build_data)\nbuild = response.json()\nprint(f\"Created build: {build['id']}\")\n</code></pre>"},{"location":"api/authentication/#shell-script","title":"Shell Script","text":"<pre><code>#!/bin/bash\nset -euo pipefail\n\nAPI_URL=\"${BUILDSTATE_API_URL:-http://localhost:8080}\"\nAPI_KEY=\"${BUILDSTATE_API_KEY}\"\n\n# Function to call API\napi_call() {\n    local method=$1\n    local endpoint=$2\n    local data=$3\n\n    curl -s -X \"$method\" \"$API_URL$endpoint\" \\\n        -H \"X-API-Key: $API_KEY\" \\\n        -H \"Content-Type: application/json\" \\\n        ${data:+-d \"$data\"}\n}\n\n# Create build\nBUILD_ID=$(api_call POST /builds '{\n    \"project_id\": \"rhel-9\",\n    \"platform_id\": \"aws-commercial\",\n    \"os_version_id\": \"rhel-9.3\",\n    \"image_type_id\": \"base\",\n    \"build_number\": \"2024.02.001\"\n}' | jq -r '.id')\n\necho \"Created build: $BUILD_ID\"\n\n# Update state\napi_call POST \"/builds/$BUILD_ID/state\" '{\n    \"state_code\": 5,\n    \"status\": \"in_progress\",\n    \"message\": \"Starting build\"\n}'\n</code></pre>"},{"location":"api/authentication/#error-handling","title":"Error Handling","text":""},{"location":"api/authentication/#authentication-errors","title":"Authentication Errors","text":"<p>No authentication provided: <pre><code>HTTP/1.1 401 Unauthorized\n</code></pre> <pre><code>{\n  \"detail\": \"Authentication required. Use Bearer token or X-API-Key.\"\n}\n</code></pre></p> <p>Invalid API key: <pre><code>HTTP/1.1 401 Unauthorized\n</code></pre> <pre><code>{\n  \"detail\": \"Invalid API key\"\n}\n</code></pre></p> <p>Expired JWT token: <pre><code>HTTP/1.1 401 Unauthorized\n</code></pre> <pre><code>{\n  \"detail\": \"Token has expired\"\n}\n</code></pre></p>"},{"location":"api/authentication/#authorization-errors","title":"Authorization Errors","text":"<p>Insufficient permissions: <pre><code>HTTP/1.1 403 Forbidden\n</code></pre> <pre><code>{\n  \"detail\": \"Write permission required\"\n}\n</code></pre></p> <p>or</p> <pre><code>{\n  \"detail\": \"Admin permission required\"\n}\n</code></pre>"},{"location":"api/authentication/#best-practices","title":"Best Practices","text":""},{"location":"api/authentication/#for-development","title":"For Development","text":"<ol> <li> <p>Use separate keys for different environments <pre><code>export BUILDSTATE_API_KEY_DEV=\"dev-key-12345\"\nexport BUILDSTATE_API_KEY_PROD=\"prod-key-secure-token\"\n</code></pre></p> </li> <li> <p>Store keys in environment variables <pre><code># .env file (never commit this!)\nBUILDSTATE_API_KEY=dev-key-12345\n</code></pre></p> </li> <li> <p>Use the CLI for interactive work <pre><code>bldst auth set-key dev-key-12345\nbldst platform list\n</code></pre></p> </li> </ol>"},{"location":"api/authentication/#for-production","title":"For Production","text":"<ol> <li>Use secret management systems</li> <li>AWS Secrets Manager</li> <li>HashiCorp Vault</li> <li>Azure Key Vault</li> <li> <p>Kubernetes Secrets</p> </li> <li> <p>Rotate keys regularly</p> </li> <li>Set expiration dates on API keys</li> <li>Automate key rotation</li> <li> <p>Monitor key usage</p> </li> <li> <p>Use least-privilege principle</p> </li> <li>Build pipelines: <code>read</code> + <code>write</code> scopes</li> <li>Monitoring tools: <code>read</code> scope only</li> <li> <p>Admin tasks: <code>admin</code> scope (temporary)</p> </li> <li> <p>Audit API key usage</p> </li> <li>Monitor API logs</li> <li>Track which keys are used where</li> <li> <p>Revoke unused keys</p> </li> <li> <p>Enable HTTPS</p> </li> <li>Never send API keys over unencrypted connections</li> <li>Use TLS 1.2 or higher</li> </ol>"},{"location":"api/authentication/#for-cicd-pipelines","title":"For CI/CD Pipelines","text":"<ol> <li> <p>Store keys as secrets <pre><code># GitHub Actions\n- name: Call API\n  env:\n    API_KEY: ${{ secrets.BUILDSTATE_API_KEY }}\n  run: |\n    curl -H \"X-API-Key: $API_KEY\" $API_URL/builds\n</code></pre></p> </li> <li> <p>Use dedicated pipeline keys</p> </li> <li>One key per pipeline or service</li> <li>Makes revocation easier</li> <li> <p>Better audit trail</p> </li> <li> <p>Implement retry logic <pre><code>for i in {1..3}; do\n  if curl -f -H \"X-API-Key: $API_KEY\" $API_URL/builds; then\n    break\n  fi\n  sleep 5\ndone\n</code></pre></p> </li> </ol>"},{"location":"api/authentication/#security-considerations","title":"Security Considerations","text":""},{"location":"api/authentication/#api-key-security","title":"API Key Security","text":"<ul> <li>\u2705 Store in environment variables or secret managers</li> <li>\u2705 Use HTTPS in production</li> <li>\u2705 Rotate keys periodically</li> <li>\u2705 Use separate keys per environment</li> <li>\u2705 Revoke keys when no longer needed</li> <li>\u274c Never commit keys to version control</li> <li>\u274c Never log API keys</li> <li>\u274c Never include keys in URLs</li> <li>\u274c Never expose keys in error messages</li> </ul>"},{"location":"api/authentication/#jwt-token-security","title":"JWT Token Security","text":"<ul> <li>\u2705 Short expiration times (1 hour default)</li> <li>\u2705 Refresh tokens regularly</li> <li>\u2705 Store tokens securely (httpOnly cookies for web)</li> <li>\u2705 Validate tokens on every request</li> <li>\u274c Never store tokens in localStorage (XSS risk)</li> <li>\u274c Never send tokens in URLs</li> <li>\u274c Don't include sensitive data in token payload</li> </ul>"},{"location":"api/authentication/#general-security","title":"General Security","text":"<ol> <li>Use HTTPS in production</li> <li>Prevents man-in-the-middle attacks</li> <li> <p>Protects credentials in transit</p> </li> <li> <p>Implement rate limiting</p> </li> <li>Prevent brute force attacks</li> <li> <p>Protect against abuse</p> </li> <li> <p>Monitor authentication failures</p> </li> <li>Detect unauthorized access attempts</li> <li> <p>Alert on suspicious activity</p> </li> <li> <p>Regular security audits</p> </li> <li>Review active API keys</li> <li>Check user permissions</li> <li>Remove unused accounts</li> </ol>"},{"location":"api/authentication/#troubleshooting","title":"Troubleshooting","text":""},{"location":"api/authentication/#authentication-required-error","title":"\"Authentication required\" error","text":"<p>Cause: No authentication provided</p> <p>Solution: <pre><code># Add API key header\ncurl -H \"X-API-Key: your-key\" http://localhost:8080/platforms/\n\n# Or use Bearer token\ncurl -H \"Authorization: Bearer your-token\" http://localhost:8080/platforms/\n</code></pre></p>"},{"location":"api/authentication/#invalid-api-key-error","title":"\"Invalid API key\" error","text":"<p>Cause: API key is incorrect or revoked</p> <p>Solution: 1. Verify the API key is correct 2. Check if key has been revoked 3. Request a new key from admin</p>"},{"location":"api/authentication/#token-has-expired-error","title":"\"Token has expired\" error","text":"<p>Cause: JWT token has expired (default: 1 hour)</p> <p>Solution: <pre><code># Get a new token\ncurl -X POST http://localhost:8080/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"username=admin&amp;password=admin123\"\n</code></pre></p>"},{"location":"api/authentication/#permission-denied-errors","title":"\"Permission denied\" errors","text":"<p>Cause: Insufficient scopes for the operation</p> <p>Solution: 1. Check required scope for the endpoint 2. Request appropriate API key from admin 3. Verify user has correct permissions</p>"},{"location":"api/authentication/#migration-guide","title":"Migration Guide","text":""},{"location":"api/authentication/#from-password-to-api-keys","title":"From Password to API Keys","text":"<p>If you're currently using username/password in scripts:</p> <p>Before: <pre><code>TOKEN=$(curl -X POST http://localhost:8080/token \\\n  -d \"username=admin&amp;password=admin123\" | jq -r '.access_token')\ncurl -H \"Authorization: Bearer $TOKEN\" http://localhost:8080/platforms/\n</code></pre></p> <p>After: <pre><code># Much simpler!\ncurl -H \"X-API-Key: dev-key-12345\" http://localhost:8080/platforms/\n</code></pre></p> <p>Benefits: - No token expiration handling - Simpler code - Better for automation - No password exposure</p>"},{"location":"api/authentication/#faq","title":"FAQ","text":"<p>Q: Should I use API keys or JWT tokens? A: Use API keys for automation and scripts, JWT tokens for interactive use.</p> <p>Q: How long do JWT tokens last? A: 1 hour by default. Request a new token after expiration.</p> <p>Q: Can I use both authentication methods simultaneously? A: The API will check API key first, then bearer token. Use one method per request.</p> <p>Q: How do I create a new API key? A: Use the <code>/users/{user_id}/tokens</code> endpoint with admin credentials.</p> <p>Q: Can I revoke an API key? A: Yes, use <code>DELETE /users/{user_id}/tokens/{token_id}</code> with admin credentials.</p> <p>Q: What happens when I delete a user? A: All their API keys are automatically revoked.</p> <p>Q: How do I check what scopes my API key has? A: Contact your administrator or check the API key listing.</p>"},{"location":"api/authentication/#additional-resources","title":"Additional Resources","text":"<ul> <li>API Reference - Complete endpoint documentation</li> <li>CLI Documentation - CLI usage and configuration</li> <li>Deployment Guide - Production deployment setup</li> </ul>"},{"location":"cli/","title":"BuildState CLI","text":"<p>A modern, type-safe command-line interface for the Build State API. Manage platforms, OS versions, image types, projects, and builds from the command line with proper authentication and authorization.</p>"},{"location":"cli/#quick-start","title":"\ud83d\ude80 Quick Start","text":"<pre><code># Install\ncd bldst_cli\npip install -e .\n\n# Configure\nbldst config set-url http://localhost:8080\nbldst auth set-key dev-key-12345\n\n# Use\nbldst platform list\nbldst os-version list\nbldst image-type list\n</code></pre>"},{"location":"cli/#documentation","title":"\ud83d\udcda Documentation","text":"<ul> <li>Complete CLI Documentation - Comprehensive guide with all commands</li> <li>Quick Start Guide - Get started in 5 minutes</li> <li>API Reference - Full API documentation</li> <li>Authentication Guide - Auth &amp; authorization</li> </ul>"},{"location":"cli/#installation","title":"\ud83d\ude80 Installation","text":""},{"location":"cli/#from-source-development","title":"From Source (Development)","text":"<pre><code>cd bldst_cli\npip install -e .\n</code></pre>"},{"location":"cli/#verify-installation","title":"Verify Installation","text":"<pre><code>bldst --help\n</code></pre>"},{"location":"cli/#virtual-environment-recommended","title":"Virtual Environment (Recommended)","text":"<pre><code># Create and activate virtual environment\npython -m venv venv\nsource venv/bin/activate  # On Windows: venv\\Scripts\\activate\n\n# Install\npip install -e .\n</code></pre>"},{"location":"cli/#configuration","title":"\u2699\ufe0f Configuration","text":""},{"location":"cli/#set-api-url","title":"Set API URL","text":"<pre><code>bldst config set-url http://localhost:8080\n</code></pre> <p>For production: <pre><code>bldst config set-url https://api.buildstate.example.com\n</code></pre></p>"},{"location":"cli/#authentication","title":"Authentication","text":""},{"location":"cli/#api-key-recommended-for-automation","title":"API Key (Recommended for automation)","text":"<pre><code># Securely stored in system keyring\nbldst auth set-key dev-key-12345\n</code></pre>"},{"location":"cli/#jwt-token-for-interactive-use","title":"JWT Token (For interactive use)","text":"<pre><code># Login with username/password\nbldst auth login\n</code></pre>"},{"location":"cli/#view-configuration","title":"View Configuration","text":"<pre><code>bldst config show\n</code></pre>"},{"location":"cli/#usage-examples","title":"\ud83d\udccb Usage Examples","text":""},{"location":"cli/#create-a-build","title":"Create a Build","text":"<pre><code># Basic build creation\nbldst build create \\\n  --platform aws-commercial \\\n  --os rhel-8.8 \\\n  --type base \\\n  --id \"my-build-$(date +%s)\"\n\n# With pipeline context\nbldst build create \\\n  --platform azure \\\n  --os ubuntu-22.04 \\\n  --type hana \\\n  --id \"hana-build-001\" \\\n  --pipeline-url \"https://concourse.example.com/pipelines/hana\" \\\n  --commit \"abc123def\"\n</code></pre>"},{"location":"cli/#update-build-state","title":"Update Build State","text":"<pre><code># State progression (0 \u2192 10 \u2192 25 \u2192 50 \u2192 75 \u2192 100)\nbldst state update &lt;build-uuid&gt; --state 10 --message \"Starting preparation\"\nbldst state update &lt;build-uuid&gt; --state 25 --message \"Packer validation complete\"\nbldst state update &lt;build-uuid&gt; --state 50 --message \"Ansible configuration running\"\nbldst state update &lt;build-uuid&gt; --state 100 --message \"Build completed successfully\"\n</code></pre>"},{"location":"cli/#manage-build-artifacts-resumable-builds","title":"Manage Build Artifacts (Resumable Builds)","text":"<pre><code># Register an artifact after creating a VM snapshot\nbldst artifact create &lt;build-id&gt; \\\n  --name \"base-vm-snapshot\" \\\n  --type \"vm_snapshot\" \\\n  --path \"s3://my-builds/project-123/build-456/state-20/snapshot.qcow2\" \\\n  --state 20 \\\n  --backend \"s3\" \\\n  --region \"us-east-1\" \\\n  --bucket \"my-builds\" \\\n  --key \"project-123/build-456/state-20/snapshot.qcow2\" \\\n  --size 2147483648 \\\n  --checksum \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\" \\\n  --resumable\n\n# List all artifacts for a build\nbldst artifact list &lt;build-id&gt;\n\n# List only resumable artifacts (for recovery)\nbldst artifact list-resumable &lt;build-id&gt;\n\n# Get details of a specific artifact\nbldst artifact get &lt;build-id&gt; &lt;artifact-id&gt;\n\n# Update artifact metadata\nbldst artifact update &lt;build-id&gt; &lt;artifact-id&gt; \\\n  --final \\\n  --name \"final-ami\"\n\n# Delete an artifact record (soft delete)\nbldst artifact delete &lt;build-id&gt; &lt;artifact-id&gt; --yes\n</code></pre> <p>Artifact Storage Benefits: - SHA256 Checksums: All artifacts stored with checksums for integrity verification - Resumable Builds: Resume from last successful state using stored artifacts - Multi-Backend Support: S3, Azure Blob, GCP Storage, NFS, local storage, and more - Metadata Tracking: Store VM IDs, snapshot IDs, AMI IDs, and custom metadata - Size Tracking: Track artifact sizes for capacity planning and cleanup</p> <p>\ud83d\udcd6 See Also: - Resumable Builds Design - Artifact Storage Documentation - Resumable Builds Quickstart</p>"},{"location":"cli/#add-build-state-with-artifact-information","title":"Add Build State with Artifact Information","text":"<pre><code># Add state with artifact storage details\nbldst build add-state &lt;build-id&gt; \\\n  --state 20 \\\n  --status \"completed\" \\\n  --storage-type \"s3\" \\\n  --storage-path \"s3://my-builds/project-123/build-456/state-20/base.qcow2\" \\\n  --artifact-size 2147483648 \\\n  --checksum \"abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\"\n</code></pre> <p>This automatically tracks the artifact location in both the <code>build_states</code> table (for quick reference) and can be used with dedicated artifact management for full resumability support.</p>"},{"location":"cli/#record-failures","title":"Record Failures","text":"<pre><code># Record build failure\nbldst failure record &lt;build-uuid&gt; \\\n  --error \"Packer build failed: AMI creation timeout\" \\\n  --code \"PACKER_TIMEOUT\" \\\n  --component \"packer\"\n</code></pre>"},{"location":"cli/#query-builds","title":"Query Builds","text":"<pre><code># Get build details\nbldst build get &lt;build-uuid&gt;\n\n# List builds by platform\nbldst build list --platform aws-commercial --limit 20\n\n# Get current state\nbldst state get &lt;build-uuid&gt;\n</code></pre>"},{"location":"cli/#dashboard","title":"Dashboard","text":"<pre><code># View summary\nbldst dashboard summary\n\n# View recent builds\nbldst dashboard recent --limit 15\n</code></pre>"},{"location":"cli/#concourse-pipeline-integration","title":"\ud83d\udd27 Concourse Pipeline Integration","text":""},{"location":"cli/#example-pipeline-task","title":"Example Pipeline Task","text":"<pre><code>jobs:\n- name: build-image\n  plan:\n  - task: init-build\n    config:\n      platform: linux\n      image_resource:\n        type: registry-image\n        source:\n          repository: your-registry/bldst_cli\n          tag: latest\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          # Install CLI if not in image\n          pip install bldst_cli\n\n          # Configure API access\n          export BLDST_API_URL=http://build-api.example.com\n          export BLDST_API_KEY=${API_KEY}\n\n          # Create build\n          BUILD_UUID=$(bldst build create \\\n            --platform aws \\\n            --os rhel-8.8 \\\n            --type base \\\n            --id \"build-${BUILD_ID}\" \\\n            --pipeline-url \"${ATC_EXTERNAL_URL}/pipelines/${PIPELINE_NAME}\")\n\n          echo $BUILD_UUID &gt; build-uuid.txt\n\n  - task: packer-build\n    config:\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-uuid.txt)\n\n          # Update state\n          bldst state update $BUILD_UUID \\\n            --state 10 \\\n            --message \"Starting Packer build\"\n\n          # Run packer\n          packer build -var-file=vars.json template.json\n\n          # Update on success\n          bldst state update $BUILD_UUID \\\n            --state 25 \\\n            --message \"Packer build completed\"\n\n  - task: ansible-configure\n    config:\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-uuid.txt)\n\n          bldst state update $BUILD_UUID \\\n            --state 50 \\\n            --message \"Starting Ansible configuration\"\n\n          ansible-playbook playbook.yml\n\n          bldst state update $BUILD_UUID \\\n            --state 75 \\\n            --message \"Ansible configuration completed\"\n\n  - task: finalize\n    config:\n      run:\n        path: sh\n        args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-uuid.txt)\n\n          bldst state update $BUILD_UUID \\\n            --state 100 \\\n            --message \"Build completed successfully\"\n\n  on_failure:\n    do:\n    - task: record-failure\n      config:\n        run:\n          path: sh\n          args:\n        - -c\n        - |\n          BUILD_UUID=$(cat build-uuid.txt)\n          bldst failure record $BUILD_UUID \\\n            --error \"Pipeline failed at stage: ${FAILED_JOB}\" \\\n            --code \"PIPELINE_FAILURE\" \\\n            --component \"concourse\"\n</code></pre>"},{"location":"cli/#key-advantages-over-curl","title":"\ud83c\udfaf Key Advantages over Curl","text":""},{"location":"cli/#type-safety-validation","title":"Type Safety &amp; Validation","text":"<pre><code># CLI validates input before API call\nbldst state update &lt;uuid&gt; --state 23\n\u274c Error: State code must be a multiple of 5 (got 23)\n\n# Curl would send invalid data to API\ncurl -X POST /builds/&lt;uuid&gt;/state -d '{\"state_code\": 23}'\n</code></pre>"},{"location":"cli/#better-error-messages","title":"Better Error Messages","text":"<pre><code># CLI provides clear, actionable errors\n\u274c curl: (22) The requested URL returned error: 400\n\u2705 Error: Invalid state code '23'. State codes must be multiples of 5 (0, 5, 10, ..., 100)\n</code></pre>"},{"location":"cli/#auto-completion-help","title":"Auto-completion &amp; Help","text":"<pre><code>bldst --help                    # Show all commands\nbldst build create --help       # Command-specific help\nbldst state update --help       # Parameter details\nbldst &lt;TAB&gt;&lt;TAB&gt;               # Auto-complete commands\n</code></pre>"},{"location":"cli/#configuration-management","title":"Configuration Management","text":"<pre><code># One-time setup, works everywhere\nbldst config set-url http://api.example.com\nbldst auth set-key my-key\n\n# No need to remember URLs/keys in every pipeline\n</code></pre>"},{"location":"cli/#rich-output-formatting","title":"Rich Output Formatting","text":"<pre><code># Beautiful tables and status indicators\nbldst dashboard summary\n# \ud83d\udcca Build State Dashboard\n# Total Builds: 42\n# \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n# \u2502 Status      \u2502 Count \u2502\n# \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n# \u2502 Completed   \u2502 38    \u2502\n# \u2502 Failed      \u2502 2     \u2502\n# \u2502 In Progress \u2502 2     \u2502\n# \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"cli/#architecture","title":"\ud83c\udfd7\ufe0f Architecture","text":""},{"location":"cli/#shared-models","title":"Shared Models","text":"<ul> <li>Type-safe: Pydantic models shared between CLI and API</li> <li>Validation: Input validation before API calls</li> <li>Consistency: Same models ensure compatibility</li> </ul>"},{"location":"cli/#async-http-client","title":"Async HTTP Client","text":"<ul> <li>httpx: Modern async HTTP client</li> <li>Error Handling: Rich error messages and status codes</li> <li>Authentication: Automatic JWT/API key handling</li> </ul>"},{"location":"cli/#configuration-system","title":"Configuration System","text":"<ul> <li>Multiple Sources: Environment variables, config files, keyring</li> <li>Security: API keys stored securely via keyring</li> <li>Flexibility: Per-project or global configuration</li> </ul>"},{"location":"cli/#cli-framework","title":"CLI Framework","text":"<ul> <li>Typer: Modern CLI framework with auto-completion</li> <li>Rich: Beautiful terminal output and formatting</li> <li>Async Support: Non-blocking API calls</li> </ul>"},{"location":"cli/#security","title":"\ud83d\udd12 Security","text":""},{"location":"cli/#api-key-storage","title":"API Key Storage","text":"<pre><code># Secure storage using system keyring\nbldst auth set-key your-api-key\n\n# Keys stored securely, not in config files\n</code></pre>"},{"location":"cli/#environment-variables","title":"Environment Variables","text":"<pre><code># For CI/CD systems\nexport BLDST_API_URL=https://api.example.com\nexport BLDST_API_KEY=your-key\n</code></pre>"},{"location":"cli/#jwt-tokens","title":"JWT Tokens","text":"<pre><code># Interactive login with secure token storage\nbldst auth login\n# Tokens automatically refreshed\n</code></pre>"},{"location":"cli/#development","title":"\ud83d\ude80 Development","text":""},{"location":"cli/#setup-development-environment","title":"Setup Development Environment","text":"<pre><code># Clone and install in development mode\ngit clone &lt;repository-url&gt;\ncd bldst_cli\npip install -e \".[dev]\"\n\n# Run tests\npytest\n\n# Format code\nblack .\nisort .\n\n# Type checking\nmypy buildstate\n</code></pre>"},{"location":"cli/#building-distribution","title":"Building Distribution","text":"<pre><code># Build wheel\npython -m build\n\n# Install locally for testing\npip install dist/bldst_cli-0.1.0.tar.gz\n\n# Test CLI\nbldst --help\n</code></pre>"},{"location":"cli/#api-reference","title":"\ud83d\udcda API Reference","text":""},{"location":"cli/#commands","title":"Commands","text":"<ul> <li><code>bldst config</code> - Manage configuration</li> <li><code>bldst auth</code> - Manage authentication</li> <li><code>bldst build</code> - Build operations</li> <li><code>bldst state</code> - State management</li> <li><code>bldst failure</code> - Failure recording</li> <li><code>bldst dashboard</code> - View summaries</li> <li><code>bldst health</code> - Health checks</li> </ul>"},{"location":"cli/#global-options","title":"Global Options","text":"<ul> <li><code>--verbose, -v</code> - Enable verbose output</li> <li><code>--config</code> - Specify config file path</li> </ul>"},{"location":"cli/#contributing","title":"\ud83e\udd1d Contributing","text":"<ol> <li>Fork the repository</li> <li>Create a feature branch</li> <li>Make changes with tests</li> <li>Run <code>black . &amp;&amp; isort . &amp;&amp; mypy buildstate</code></li> <li>Submit a pull request</li> </ol>"},{"location":"cli/#license","title":"\ud83d\udcc4 License","text":"<p>MIT License - see LICENSE file for details.</p> <p>Clean pipelines, happy engineers! \ud83c\udf89</p>"},{"location":"cli/quickstart/","title":"BuildState CLI - Quick Start Guide","text":"<p>The BuildState CLI provides a complete interface to manage your build infrastructure with proper authentication and authorization.</p>"},{"location":"cli/quickstart/#installation","title":"Installation","text":"<pre><code>cd bldst_cli\npip install -e .\n</code></pre>"},{"location":"cli/quickstart/#configuration","title":"Configuration","text":""},{"location":"cli/quickstart/#1-set-api-url","title":"1. Set API URL","text":"<pre><code>bldst config set-url http://localhost:8080\n</code></pre>"},{"location":"cli/quickstart/#2-configure-authentication","title":"2. Configure Authentication","text":"<p>Option A: API Key (recommended for automation) <pre><code>bldst config set-key dev-key-12345\n</code></pre></p> <p>Option B: JWT Token (for interactive use) <pre><code>bldst auth login\n# Enter username and password when prompted\n</code></pre></p>"},{"location":"cli/quickstart/#usage-examples","title":"Usage Examples","text":""},{"location":"cli/quickstart/#platform-management","title":"Platform Management","text":"<p>List all platforms: <pre><code>bldst platform list\n</code></pre></p> <p>Create a platform (requires write permission): <pre><code>bldst platform create \\\n  --name \"my-aws-platform\" \\\n  --cloud-provider \"aws\" \\\n  --region \"us-east-1\"\n</code></pre></p> <p>Get platform details: <pre><code>bldst platform get &lt;platform-id&gt;\n</code></pre></p> <p>Update a platform (requires write permission): <pre><code>bldst platform update &lt;platform-id&gt; \\\n  --region \"us-west-2\"\n</code></pre></p> <p>Delete a platform (requires admin permission): <pre><code>bldst platform delete &lt;platform-id&gt;\n</code></pre></p>"},{"location":"cli/quickstart/#os-version-management","title":"OS Version Management","text":"<p>List all OS versions: <pre><code>bldst os-version list\n</code></pre></p> <p>Create an OS version (requires write permission): <pre><code>bldst os-version create \\\n  --name \"Red Hat Enterprise Linux\" \\\n  --version \"9.3\"\n</code></pre></p> <p>Update an OS version (requires write permission): <pre><code>bldst os-version update &lt;os-version-id&gt; \\\n  --version \"9.4\"\n</code></pre></p> <p>Delete an OS version (requires admin permission): <pre><code>bldst os-version delete &lt;os-version-id&gt;\n</code></pre></p>"},{"location":"cli/quickstart/#image-type-management","title":"Image Type Management","text":"<p>List all image types: <pre><code>bldst image-type list\n</code></pre></p> <p>Create an image type (requires write permission): <pre><code>bldst image-type create \\\n  --name \"kubernetes-node\" \\\n  --description \"Kubernetes worker node image\"\n</code></pre></p> <p>Update an image type (requires write permission): <pre><code>bldst image-type update &lt;image-type-id&gt; \\\n  --description \"Updated description\"\n</code></pre></p> <p>Delete an image type (requires admin permission): <pre><code>bldst image-type delete &lt;image-type-id&gt;\n</code></pre></p>"},{"location":"cli/quickstart/#project-management","title":"Project Management","text":"<p>List all projects: <pre><code>bldst project list\n</code></pre></p> <p>Create a project (requires write permission): <pre><code>bldst project create \\\n  --name \"my-project\" \\\n  --description \"My build project\"\n</code></pre></p>"},{"location":"cli/quickstart/#build-management","title":"Build Management","text":"<p>List all builds: <pre><code>bldst build list\n</code></pre></p> <p>Get build details: <pre><code>bldst build get &lt;build-id&gt;\n</code></pre></p> <p>Get build states: <pre><code>bldst build states &lt;build-id&gt;\n</code></pre></p>"},{"location":"cli/quickstart/#authorization-levels","title":"Authorization Levels","text":"<p>The CLI supports three authorization levels via API tokens:</p> <ol> <li>Read - View resources</li> <li> <p>List and get operations</p> </li> <li> <p>Write - Create and update resources</p> </li> <li>Includes read permissions</li> <li> <p>Create and update operations</p> </li> <li> <p>Admin - Full access including delete</p> </li> <li>Includes read and write permissions</li> <li>Delete operations (soft delete)</li> </ol>"},{"location":"cli/quickstart/#api-keys","title":"API Keys","text":"<p>Three test API keys are available:</p> <ul> <li><code>dev-key-12345</code> - read + write permissions</li> <li><code>admin-key-99999</code> - read + write + admin permissions</li> <li><code>readonly-key-888</code> - read-only permissions</li> </ul>"},{"location":"cli/quickstart/#output-formats","title":"Output Formats","text":"<p>By default, output is formatted as a table. Use <code>--output json</code> for JSON output:</p> <pre><code>bldst platform list --output json\n</code></pre>"},{"location":"cli/quickstart/#health-check","title":"Health Check","text":"<p>Verify API connectivity:</p> <pre><code>bldst health check\n</code></pre>"},{"location":"cli/quickstart/#configuration-management","title":"Configuration Management","text":"<p>View current configuration: <pre><code>bldst config show\n</code></pre></p> <p>Clear stored credentials: <pre><code>bldst auth logout        # Clear JWT token\nbldst auth clear-key     # Clear API key\n</code></pre></p>"},{"location":"cli/quickstart/#examples","title":"Examples","text":""},{"location":"cli/quickstart/#complete-workflow","title":"Complete Workflow","text":"<pre><code># 1. Configure CLI\nbldst config set-url http://localhost:8080\nbldst config set-key dev-key-12345\n\n# 2. List existing resources\nbldst platform list\nbldst os-version list\nbldst image-type list\n\n# 3. Create new resources\nPLATFORM_ID=$(bldst platform create \\\n  --name \"production-aws\" \\\n  --cloud-provider \"aws\" \\\n  --region \"us-east-1\" \\\n  --output json | jq -r '.id')\n\nOS_ID=$(bldst os-version create \\\n  --name \"Ubuntu\" \\\n  --version \"22.04\" \\\n  --output json | jq -r '.id')\n\nIMAGE_ID=$(bldst image-type create \\\n  --name \"web-server\" \\\n  --description \"Nginx web server\" \\\n  --output json | jq -r '.id')\n\n# 4. Update resources\nbldst platform update $PLATFORM_ID --region \"us-west-2\"\n\n# 5. Soft delete (requires admin key)\nbldst config set-key admin-key-99999\nbldst platform delete $PLATFORM_ID\n</code></pre>"},{"location":"cli/quickstart/#automated-script-example","title":"Automated Script Example","text":"<pre><code>#!/bin/bash\n# Setup API key from environment\nexport BUILDSTATE_API_KEY=\"${BUILDSTATE_API_KEY}\"\n\n# Configure CLI\nbldst config set-url \"${BUILDSTATE_API_URL}\"\nbldst config set-key \"${BUILDSTATE_API_KEY}\"\n\n# List platforms and filter\nbldst platform list --output json | \\\n  jq -r '.[] | select(.cloud_provider == \"aws\") | .name'\n</code></pre>"},{"location":"cli/quickstart/#troubleshooting","title":"Troubleshooting","text":"<p>\"Authentication failed\" error: - Verify API URL is correct: <code>bldst config show</code> - Check API key is valid: <code>bldst config set-key &lt;your-key&gt;</code> - Test API connectivity: <code>bldst health check</code></p> <p>\"Permission denied\" errors: - Check your API token has appropriate scopes - Write operations require <code>write</code> scope - Delete operations require <code>admin</code> scope</p> <p>\"Connection refused\" error: - Ensure the API is running: <code>docker compose ps</code> - Verify the API URL is accessible: <code>curl http://localhost:8080/health</code></p>"},{"location":"cli/quickstart/#advanced-features","title":"Advanced Features","text":""},{"location":"cli/quickstart/#using-jwt-tokens","title":"Using JWT Tokens","text":"<p>For interactive use, you can use JWT tokens instead of API keys:</p> <pre><code># Login with username/password\nbldst auth login\n# Username: admin\n# Password: admin123\n\n# Use the CLI (JWT token is automatically used)\nbldst platform list\n\n# Logout when done\nbldst auth logout\n</code></pre>"},{"location":"cli/quickstart/#scripting-with-the-cli","title":"Scripting with the CLI","text":"<p>The CLI is designed for automation:</p> <pre><code># Get all platforms and process with jq\nbldst platform list --output json | \\\n  jq -r '.[] | \"\\(.name): \\(.cloud_provider) (\\(.region))\"'\n\n# Check if specific platform exists\nif bldst platform get \"my-platform\" &gt; /dev/null 2&gt;&amp;1; then\n  echo \"Platform exists\"\nelse\n  echo \"Platform not found\"\nfi\n</code></pre>"},{"location":"cli/quickstart/#additional-resources","title":"Additional Resources","text":"<ul> <li>API Documentation: http://localhost:8080/docs</li> <li>GitHub Repository: [Your repo URL]</li> <li>Issue Tracker: [Your issue tracker URL]</li> </ul>"}]}