name: Version and Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      create_tag:
        description: 'Create git tag'
        required: true
        type: boolean
        default: true
      create_release:
        description: 'Create GitHub release'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      old_version: ${{ steps.bump.outputs.old_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Bump version
        id: bump
        run: |
          # Store old version
          OLD_VERSION=$(cat VERSION)
          echo "old_version=${OLD_VERSION}" >> $GITHUB_OUTPUT
          echo "Old version: $OLD_VERSION"
          
          # Bump version
          chmod +x scripts/version.sh
          NEW_VERSION=$(./scripts/version.sh bump ${{ inputs.bump }})
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
      
      - name: Update CLI version
        run: |
          cd buildstate_cli
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          sed -i "s/^version = .*/version = \"${NEW_VERSION}\"/" pyproject.toml
          echo "Updated buildstate_cli/pyproject.toml to version ${NEW_VERSION}"
      
      - name: Commit version bump
        run: |
          git add VERSION buildstate_cli/pyproject.toml
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push origin ${{ github.ref_name }}
      
      - name: Create tag
        if: inputs.create_tag
        run: |
          TAG="v${{ steps.bump.outputs.new_version }}"
          git tag -a "${TAG}" -m "Release version ${{ steps.bump.outputs.new_version }}"
          git push origin "${TAG}"
          echo "Created and pushed tag: ${TAG}"

  create-release:
    name: Create GitHub Release
    needs: bump-version
    runs-on: ubuntu-latest
    if: inputs.create_release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.bump-version.outputs.new_version }}
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file to preserve newlines
          echo "$CHANGELOG" > changelog.txt
      
      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelog = fs.readFileSync('changelog.txt', 'utf8');
            
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: 'v${{ needs.bump-version.outputs.new_version }}',
              name: 'Release v${{ needs.bump-version.outputs.new_version }}',
              body: `## What's Changed\n\n${changelog}\n\n**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/v${{ needs.bump-version.outputs.old_version }}...v${{ needs.bump-version.outputs.new_version }}`,
              draft: false,
              prerelease: false
            });
            
            console.log('Created release:', release.data.html_url);
